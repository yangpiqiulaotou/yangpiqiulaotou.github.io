<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-55HKMllCks">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic%7CAmita:300,300italic,400,400italic,700,700italic%7CMontserrat:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="羊皮裘老头">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="羊皮裘老头">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="羊皮裘老头">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>羊皮裘老头</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">羊皮裘老头</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">28</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">116</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="羊皮裘老头"
      src="/images/bb.jpg">
  <p class="site-author-name" itemprop="name">羊皮裘老头</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


<!-- CloudCalendar -->
<div class="widget-wrap" style="width: 90%;margin-left: auto;margin-right: auto; opacity: 0.97;">
	<div class="widget" id="CloudCalendar"></div>
</div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/14/Istio%E5%85%A5%E5%9D%91%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/14/Istio%E5%85%A5%E5%9D%91%E7%AF%87/" class="post-title-link" itemprop="url">Istio入坑篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-14 10:34:37" itemprop="dateCreated datePublished" datetime="2021-05-14T10:34:37+08:00">2021-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/14/Istio%E5%85%A5%E5%9D%91%E7%AF%87/" class="post-meta-item leancloud_visitors" data-flag-title="Istio入坑篇" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/concepts">https://istio.io/docs/concepts</a></p>
</blockquote>
<h2 id="1、什么是Istio"><a href="#1、什么是Istio" class="headerlink" title="1、什么是Istio"></a>1、什么是Istio</h2><p>云平台为使用它们的组织提供了很多好处。但是，不可否认的是，采用云技术会对DevOps团队造成压力。开发人员必须使用微服务来构建可移植性，同时运营商正在管理超大型混合和多云部署。Istio使您可以连接，保护，控制和观察服务。</p>
<p>从较高的角度来看，Istio有助于降低这些部署的复杂性，并减轻开发团队的负担。它是一个完全开源的服务网格，可以透明地分层到现有的分布式应用程序上。它也是一个平台，包括可将其集成到任何日志记录平台，遥测或策略系统中的API。Istio的多样化功能集使您能够成功，高效地运行分布式微服务架构，并提供一种统一的方式来保护，连接和监视微服务。</p>
<h2 id="2、为什么要使用Istio"><a href="#2、为什么要使用Istio" class="headerlink" title="2、为什么要使用Istio"></a>2、为什么要使用Istio</h2><p>Istio可以轻松创建带有负载平衡，服务到服务的身份验证，监视等功能的已部署服务网络，而服务代码中的代码更改<a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/distributed-tracing/overview/#trace-context-propagation">很少</a>或没有更改。通过在整个环境中部署一个特殊的sidecar代理来拦截微服务之间的所有网络通信，然后使用其控制平面功能配置和管理Istio，可以为服务添加Istio支持，包括：</p>
<ul>
<li>HTTP，gRPC，WebSocket和TCP通信的自动负载平衡。</li>
<li>通过丰富的路由规则，重试，故障转移和故障注入对流量行为进行细粒度控制。</li>
<li>可插拔的策略层和配置API，支持访问控制，速率限制和配额。</li>
<li>集群内所有流量的自动度量，日志和跟踪，包括集群的入口和出口。</li>
<li>通过强大的基于身份的身份验证和授权，在群集中进行安全的服务间通信。</li>
</ul>
<p>Istio专为可扩展性而设计，可满足多种部署需求。</p>
<h2 id="3、核心功能"><a href="#3、核心功能" class="headerlink" title="3、核心功能"></a>3、核心功能</h2><p>Istio在服务网络中统一提供了许多关键功能：</p>
<h3 id="3-1-流量管理"><a href="#3-1-流量管理" class="headerlink" title="3.1 流量管理"></a>3.1 流量管理</h3><p>Istio的简单规则配置和流量路由使您可以控制服务之间流量和API调用的流。Istio简化了诸如断路器，超时和重试之类的服务级别属性的配置，并使其轻而易举地设置了重要任务（如A / B测试，canary部署和基于百分比的流量拆分的分阶段部署）。</p>
<p>借助对流量的更好可见性和开箱即用的故障恢复功能，无论遇到什么情况，您都可以在问题引起问题之前及时发现问题，使呼叫更加可靠，网络也更加强大。</p>
<blockquote>
<p>流量管理概念指南：<a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/traffic-management/">https://istio.io/docs/concepts/traffic-management/</a></p>
</blockquote>
<h3 id="3-2-安全"><a href="#3-2-安全" class="headerlink" title="3.2 安全"></a>3.2 安全</h3><p>Istio的安全功能使开发人员可以将精力集中在应用程序级别上。Istio提供基础安全通信通道，并大规模管理服务通信的身份验证，授权和加密。借助Istio，默认情况下可以保护服务通信的安全，从而使您能够在各种协议和运行时之间一致地实施策略-所有这些操作几乎不需要更改应用程序。</p>
<p>尽管Istio是独立于平台的，但将其与Kubernetes（或基础架构）网络策略配合使用，其好处更大，包括能够在网络和应用程序层保护Pod到Pod或服务到服务的通信的能力。</p>
<blockquote>
<p>安全性概念指南：<a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/security/">https://istio.io/docs/concepts/security/</a></p>
</blockquote>
<h3 id="3-3-策略规定"><a href="#3-3-策略规定" class="headerlink" title="3.3 策略规定"></a>3.3 策略规定</h3><p>Istio允许您为应用程序配置自定义策略，以在运行时强制执行规则，例如：</p>
<ul>
<li>速率限制以动态限制服务流量</li>
<li>拒绝，白名单和黑名单，以限制对服务的访问</li>
<li>标头重写和重定向</li>
</ul>
<p>Istio还允许您创建自己的<a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/policy-enforcement/control-headers">策略适配器，</a>以添加例如自己的自定义授权行为。</p>
<blockquote>
<p>策略概念指南：<a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/policies/">https://istio.io/docs/concepts/policies/</a></p>
</blockquote>
<h3 id="3-4-可观察性"><a href="#3-4-可观察性" class="headerlink" title="3.4 可观察性"></a>3.4 可观察性</h3><p>Istio强大的跟踪，监视和日志记录功能使您可以深入了解服务网格部署。借助Istio的监视功能，可以真正了解服务性能如何影响上游和下游事物，而其自定义仪表板可提供对所有服务性能的可视性，并让您了解该性能如何影响您的其他流程。</p>
<p>Istio的Mixer组件负责策略控制和遥测收集。它提供了后端抽象和中介，使Istio的其余部分与各个基础架构后端的实现细节隔离开来，并为操作员提供了对网格和基础架构后端之间所有交互的精细控制。</p>
<p>所有这些功能使您可以更有效地设置，监视和实施服务上的SLO。当然，最重要的是您可以快速有效地检测和修复问题。</p>
<blockquote>
<p>可观察性概念指南：<a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/observability/">https://istio.io/docs/concepts/observability/</a></p>
</blockquote>
<h3 id="3-5-平台支援"><a href="#3-5-平台支援" class="headerlink" title="3.5 平台支援"></a>3.5 平台支援</h3><p>Istio是独立于平台的，旨在在多种环境中运行，包括跨Cloud，本地，Kubernetes，Mesos等的环境。您可以在Kubernetes或Consul的Nomad上部署Istio。Istio当前支持：</p>
<ul>
<li>Kubernetes上的服务部署</li>
<li>向领事注册的服务</li>
<li>在单个虚拟机上运行的服务</li>
</ul>
<h3 id="3-6-集成和定制"><a href="#3-6-集成和定制" class="headerlink" title="3.6 集成和定制"></a>3.6 集成和定制</h3><p>Istio的策略执行组件可以扩展和定制，以与现有的ACL，日志记录，监视，配额，审核等解决方案集成。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Containerd%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Containerd%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Containerd的使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:32:23" itemprop="dateCreated datePublished" datetime="2021-05-10T15:32:23+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Containerd%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-meta-item leancloud_visitors" data-flag-title="Containerd的使用" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h2><p>containerd是行业标准的容器运行时，重点是简单性，健壮性和可移植性。它可以作为Linux和Windows的守护程序使用，可以管理其主机系统的完整容器生命周期：图像传输和存储，容器执行和监控，低级存储和网络附件等。</p>
<p>容器化的设计旨在嵌入到更大的系统中，而不是由开发人员或最终用户直接使用。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210510141814.png"></p>
<p><code>cri</code>是Kubernetes[容器运行时接口（CRI）的容器化插件实现</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210510142315.png"></p>
<h2 id="2、配置"><a href="#2、配置" class="headerlink" title="2、配置"></a>2、配置</h2><p>containerd是一个可以在任何系统上运行的简单守护程序，配置文件的默认路径位于<code>/etc/containerd/config.toml</code>。<code>--config,-c</code>引导守护程序时，可以通过标志更改此路径。</p>
<p>Containerd在主机系统上也有两个不同的存储位置。一种用于持久性数据，另一种用于运行时状态。</p>
<p><code>root</code>将用于存储任何类型的容器持久化数据。快照，内容，容器和图像的元数据以及任何插件数据都将保留在此位置。根也为容器加载的插件命名空间。每个插件都有其自己的目录，用于存储数据。容器本身实际上并不需要存储任何持久性数据，它的功能来自于已加载的插件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;lib&#x2F;containerd&#x2F;</span><br><span class="line">├── io.containerd.content.v1.content</span><br><span class="line">│   ├── blobs</span><br><span class="line">│   └── ingest</span><br><span class="line">├── io.containerd.metadata.v1.bolt</span><br><span class="line">│   └── meta.db</span><br><span class="line">├── io.containerd.runtime.v1.linux</span><br><span class="line">│   ├── default</span><br><span class="line">│   └── example</span><br><span class="line">├── io.containerd.snapshotter.v1.btrfs</span><br><span class="line">└── io.containerd.snapshotter.v1.overlayfs</span><br><span class="line">    ├── metadata.db</span><br><span class="line">    └── snapshots</span><br></pre></td></tr></table></figure>
<p><code>state</code>将用于存储任何类型的临时数据。套接字，PID，运行时状态，安装点以及在重新启动之间不得保留的其他插件数据都存储在此位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;run&#x2F;containerd</span><br><span class="line">├── containerd.sock</span><br><span class="line">├── debug.sock</span><br><span class="line">├── io.containerd.runtime.v1.linux</span><br><span class="line">│   └── default</span><br><span class="line">│       └── redis</span><br><span class="line">│           ├── config.json</span><br><span class="line">│           ├── init.pid</span><br><span class="line">│           ├── log.json</span><br><span class="line">│           └── rootfs</span><br><span class="line">│               ├── bin</span><br><span class="line">│               ├── data</span><br><span class="line">│               ├── dev</span><br><span class="line">│               ├── etc</span><br><span class="line">│               ├── home</span><br><span class="line">│               ├── lib</span><br><span class="line">│               ├── media</span><br><span class="line">│               ├── mnt</span><br><span class="line">│               ├── proc</span><br><span class="line">│               ├── root</span><br><span class="line">│               ├── run</span><br><span class="line">│               ├── sbin</span><br><span class="line">│               ├── srv</span><br><span class="line">│               ├── sys</span><br><span class="line">│               ├── tmp</span><br><span class="line">│               ├── usr</span><br><span class="line">│               └── var</span><br><span class="line">└── runc</span><br><span class="line">    └── default</span><br><span class="line">        └── redis</span><br><span class="line">            └── state.json</span><br></pre></td></tr></table></figure>
<h2 id="3、插件"><a href="#3、插件" class="headerlink" title="3、插件"></a>3、插件</h2><p>containerd在内部使用插件，以确保内部实现解耦，稳定并与外部插件平等对待。要查看容器中包含的所有插件，请使用<code>ctr plugins ls</code></p>
<p>插件是使用<code>[plugins]</code>containerd的config部分配置的。每个插件都可以使用模式有其自己的部分<code>[plugins.&lt;plugin id&gt;]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[plugins]</span><br><span class="line">  [plugins.cgroups]</span><br><span class="line">    no_prometheus &#x3D; false</span><br><span class="line">  [plugins.cri]</span><br><span class="line">    stream_server_address &#x3D; &quot;&quot;</span><br><span class="line">    stream_server_port &#x3D; &quot;10010&quot;</span><br><span class="line">    enable_selinux &#x3D; false</span><br><span class="line">    sandbox_image &#x3D; &quot;k8s.gcr.io&#x2F;pause:3.5&quot;</span><br><span class="line">    stats_collect_period &#x3D; 10</span><br><span class="line">    systemd_cgroup &#x3D; false</span><br><span class="line">    [plugins.cri.containerd]</span><br><span class="line">      snapshotter &#x3D; &quot;overlayfs&quot;</span><br><span class="line">      [plugins.cri.containerd.default_runtime]</span><br><span class="line">        runtime_type &#x3D; &quot;io.containerd.runtime.v1.linux&quot;</span><br><span class="line">        runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">        runtime_root &#x3D; &quot;&quot;</span><br><span class="line">      [plugins.cri.containerd.untrusted_workload_runtime]</span><br><span class="line">        runtime_type &#x3D; &quot;&quot;</span><br><span class="line">        runtime_engine &#x3D; &quot;&quot;</span><br><span class="line">        runtime_root &#x3D; &quot;&quot;</span><br><span class="line">    [plugins.cri.cni]</span><br><span class="line">      bin_dir &#x3D; &quot;&#x2F;opt&#x2F;cni&#x2F;bin&quot;</span><br><span class="line">      conf_dir &#x3D; &quot;&#x2F;etc&#x2F;cni&#x2F;net.d&quot;</span><br><span class="line">    [plugins.cri.registry]</span><br><span class="line">      [plugins.cri.registry.mirrors]</span><br><span class="line">        [plugins.cri.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">          endpoint &#x3D; [&quot;https:&#x2F;&#x2F;registry-1.docker.io&quot;]</span><br></pre></td></tr></table></figure>
<h2 id="4、命令行工具"><a href="#4、命令行工具" class="headerlink" title="4、命令行工具"></a>4、命令行工具</h2><p>语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctr [global options] command [command options] [arguments...]</span><br></pre></td></tr></table></figure>
<p>命令选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">plugins, plugin            提供关于容器插件的信息</span><br><span class="line">version                    打印客户端和服务器版本</span><br><span class="line">containers, c, container   管理容器</span><br><span class="line">content                    管理内容</span><br><span class="line">events, event              显示containerd事件</span><br><span class="line">images, image, i           管理镜像</span><br><span class="line">leases                     管理租赁协定</span><br><span class="line">namespaces, namespace, ns  管理名称空间</span><br><span class="line">pprof                      为containerd提供golang pprof输出</span><br><span class="line">run                        运行一个容器</span><br><span class="line">snapshots, snapshot        管理快照</span><br><span class="line">tasks, t, task             管理任务</span><br><span class="line">install                    安装一个新包</span><br><span class="line">oci                        OCI工具</span><br><span class="line">shim                       直接与垫片互动</span><br><span class="line">help, h                    帮助</span><br></pre></td></tr></table></figure>
<p>全局选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--debug                      在日志中打开调试输出</span><br><span class="line">--address value, -a value    containerd的GRPC服务器地址(default: &quot;&#x2F;run&#x2F;containerd&#x2F;containerd.sock&quot;) [$CONTAINERD_ADDRESS]</span><br><span class="line">--timeout value              CTR命令总超时时间 (default: 0s)</span><br><span class="line">--connect-timeout value      连接到containerd的超时(default: 0s)</span><br><span class="line">--namespace value, -n value  与命令一起使用的命名空间(default: &quot;default&quot;) [$CONTAINERD_NAMESPACE]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Crictl%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Crictl%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Crictl安装与使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:30:29" itemprop="dateCreated datePublished" datetime="2021-05-10T15:30:29+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Crictl%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-meta-item leancloud_visitors" data-flag-title="Crictl安装与使用" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p><code>crictl</code> 是 CRI 兼容的容器运行时命令行接口。 可以使用它来检查和调试 Kubernetes 节点上的容器运行时和应用程序。</p>
<h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><h3 id="2-1-使用yum安装"><a href="#2-1-使用yum安装" class="headerlink" title="2.1 使用yum安装"></a>2.1 使用yum安装</h3><p>安装<code>containerd.io</code>软件包就自带了<code>crictl</code>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line">yum install -y containerd.io</span><br></pre></td></tr></table></figure>
<h3 id="2-2-使用二进制包"><a href="#2-2-使用二进制包" class="headerlink" title="2.2 使用二进制包"></a>2.2 使用二进制包</h3><p>在github下载安装包：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.21.0">https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.21.0</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VERSION&#x3D;&quot;v1.21.0&quot;</span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;cri-tools&#x2F;releases&#x2F;download&#x2F;$VERSION&#x2F;crictl-$VERSION-linux-amd64.tar.gz</span><br><span class="line">sudo tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;bin</span><br><span class="line">rm -f crictl-$VERSION-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="3、设置配置文件"><a href="#3、设置配置文件" class="headerlink" title="3、设置配置文件"></a>3、设置配置文件</h2><h3 id="3-1-配置文件"><a href="#3-1-配置文件" class="headerlink" title="3.1 配置文件"></a>3.1 配置文件</h3><p><code>crictl</code> 默认连接到 <code>unix:///var/run/dockershim.sock</code>。 对于其他的运行时，可以用多种不同的方法设置端点：</p>
<ul>
<li>通过设置参数 <code>--runtime-endpoint</code> 和 <code>--image-endpoint</code></li>
<li>通过设置环境变量 <code>CONTAINER_RUNTIME_ENDPOINT</code> 和 <code>IMAGE_SERVICE_ENDPOINT</code></li>
<li>通过在配置文件中设置端点 <code>--config=/etc/crictl.yaml</code></li>
</ul>
<p>还可以在连接到服务器并启用或禁用调试时指定超时值，方法是在配置文件中指定 <code>timeout</code> 或 <code>debug</code> 值，或者使用 <code>--timeout</code> 和 <code>--debug</code> 命令行参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; &#x2F;etc&#x2F;crictl.yaml &lt;&lt; EOF    #这里使用containerd</span><br><span class="line">runtime-endpoint: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">image-endpoint: unix:&#x2F;&#x2F;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">timeout: 3</span><br><span class="line">debug: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="3-2-命令行"><a href="#3-2-命令行" class="headerlink" title="3.2 命令行"></a>3.2 命令行</h3><p>使用crictl config命令获取并设置crictl客户端配置选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl config [command options] [&lt;crictl options&gt;]</span><br></pre></td></tr></table></figure>
<p>例如，<code>crictl config --set debug=true</code>在提供后续crictl命令时将启用调试模式。</p>
<p>可选选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">runtime-endpoint:       Container runtime endpoint</span><br><span class="line">image-endpoint:         Image endpoint</span><br><span class="line">timeout:                Timeout of connecting to server (default: 2s)</span><br><span class="line">debug:                  Enable debug output (default: false)</span><br><span class="line">pull-image-on-create:   Enable pulling image on create requests (default: false)</span><br><span class="line">disable-pull-on-run:    Disable pulling image on run requests (default: false)</span><br></pre></td></tr></table></figure>
<p>选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--get value  show the option value</span><br><span class="line">--set value  set option (can specify multiple or separate values with commas: opt1&#x3D;val1,opt2&#x3D;val2)</span><br><span class="line">--help, -h   show help (default: false)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启用后，<code>pull-image-on-create</code>将修改create container命令以首先拉出容器的映像。此功能用作帮助使创建容器更容易，更快的助手。<code>crictl</code>可能希望不要提取创建容器所需的图像。例如，图像可能已经被拉出或以其他方式加载到容器运行时中，或者用户可能在没有网络的情况下运行。因此，默认值for<code>pull-image-on-create</code>为false。</p>
</blockquote>
<blockquote>
<p>默认情况下，运行命令首先提取容器映像，并且<code>disable-pull-on-run</code>为false。的某些用户<code>crictl</code>可能希望将其设置<code>disable-pull-on-run</code>为true，以在使用run命令时默认情况下不拉取图像。</p>
</blockquote>
<blockquote>
<p>要覆盖这些默认的拉取配置设置，<code>--no-pull</code>并<code>--with-pull</code>为create和run命令提供了选项。</p>
</blockquote>
<h2 id="4、用法"><a href="#4、用法" class="headerlink" title="4、用法"></a>4、用法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl [全局选项]命令[命令选项] [参数...]</span><br></pre></td></tr></table></figure>
<p><strong>指令</strong>：</p>
<ul>
<li><code>attach</code>：附加到正在运行的容器</li>
<li><code>create</code>：创建一个新的容器</li>
<li><code>exec</code>：在正在运行的容器中运行命令</li>
<li><code>version</code>：显示运行时版本信息</li>
<li><code>images</code>：列出镜像</li>
<li><code>inspect</code>：显示一个或多个容器的状态</li>
<li><code>inspecti</code>：返回一个或多个镜像的状态</li>
<li><code>imagefsinfo</code>：返回镜像文件系统信息</li>
<li><code>inspectp</code>：显示一个或多个pods的状态</li>
<li><code>logs</code>：获取容器的日志</li>
<li><code>port-forward</code>：将本地端口转发到Pod</li>
<li><code>ps</code>：列出容器</li>
<li><code>pull</code>：从镜像库拉取镜像</li>
<li><code>runp</code>：运行一个新的pod</li>
<li><code>rm</code>：删除一个或多个容器</li>
<li><code>rmi</code>：删除一个或多个镜像</li>
<li><code>rmp</code>：删除一个或多个pod</li>
<li><code>pods</code>：列出pods</li>
<li><code>start</code>：启动一个或多个已创建的容器</li>
<li><code>info</code>：显示容器运行时的信息</li>
<li><code>stop</code>：停止一个或多个运行中的容器</li>
<li><code>stopp</code>：停止一个或多个正在运行的Pod</li>
<li><code>update</code>：更新一个或多个正在运行的容器</li>
<li><code>config</code>：获取并设置crictl客户端配置选项</li>
<li><code>stats</code>：列出容器资源使用情况统计信息</li>
<li><code>completion</code>：输出bash shell完成代码</li>
<li><code>help, h</code>：显示命令列表或一个命令的帮助</li>
</ul>
<p><strong>其他指令</strong>：</p>
<ul>
<li><code>--timeout</code>，<code>-t</code>：连接服务器的超时时间（以秒为单位）（默认值：10s）。0或更少将被解释为未设置并转换为默认值。没有设置超时值的选项，支持的最小超时为<code>1s</code></li>
<li><code>--debug</code>，<code>-D</code>：启用调试输出</li>
<li><code>--help</code>，<code>-h</code>：显示帮助</li>
<li><code>--version</code>，<code>-v</code>：打印crictl的版本信息</li>
<li><code>--config</code>，<code>-c</code>：客户端配置文件的位置。如果未指定并且默认目录不存在，则也会搜索该程序的目录（默认目录：“ / etc / crictl.yaml”）[$ CRI_CONFIG_FILE]</li>
</ul>
<h2 id="5、创建pod报错"><a href="#5、创建pod报错" class="headerlink" title="5、创建pod报错"></a>5、创建pod报错</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# cat pod-config.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;sandbox&quot;,</span><br><span class="line">        &quot;namespace&quot;: &quot;default&quot;,</span><br><span class="line">        &quot;attempt&quot;: 1,</span><br><span class="line">        &quot;uid&quot;: &quot;hdishd83djaidwnduwk28bcsb&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;log_directory&quot;: &quot;&#x2F;tmp&quot;,</span><br><span class="line">    &quot;linux&quot;: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@node2 ~]# crictl runp  pod-config.json</span><br><span class="line">FATA[0000] run pod sandbox failed: rpc error: code &#x3D; Unknown desc &#x3D; failed to setup network for sandbox &quot;b20591a4fcb681975ed3f906de91455ad793f18dafc98630b23e64548ade90a6&quot;: pods &quot;sandbox&quot; not found</span><br></pre></td></tr></table></figure>
<p>报错原因：calico daemonset监视apiserver以获取Pod列表，并根据Pod规范应用网络配置。自己使用沙盒，则apiserver上将没有相应的Pod，因此calico报告该错误。不建议用户运行<code>crictl runs</code>和<code>crictl create</code>一个Kubernetes节点上，这些命令在那里只是一些特殊的调试情况。即使您能够创建沙箱，<code>kubelet</code>也将最终停止并删除它，因为它在apiserver上看不到相应的pod。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/%E4%BD%BF%E7%94%A8containerd%E5%AE%89%E8%A3%85k8s%E7%9A%841-21%E7%89%88%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/%E4%BD%BF%E7%94%A8containerd%E5%AE%89%E8%A3%85k8s%E7%9A%841-21%E7%89%88%E6%9C%AC/" class="post-title-link" itemprop="url">使用containerd安装k8s的1.21版本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:29:20" itemprop="dateCreated datePublished" datetime="2021-05-10T15:29:20+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/%E4%BD%BF%E7%94%A8containerd%E5%AE%89%E8%A3%85k8s%E7%9A%841-21%E7%89%88%E6%9C%AC/" class="post-meta-item leancloud_visitors" data-flag-title="使用containerd安装k8s的1.21版本" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、准备"><a href="#1、准备" class="headerlink" title="1、准备"></a>1、准备</h2><ul>
<li>每台机器 2 GB 或更多的 RAM</li>
<li>2 CPU 核或更多</li>
<li>集群中的所有机器的网络彼此均能相互连接</li>
<li>关闭selinux和firewalld</li>
<li>关闭swap分区</li>
<li>添加hosts解析</li>
</ul>
<h2 id="2、确保每个节点上-MAC-地址和-product-uuid-的唯一性"><a href="#2、确保每个节点上-MAC-地址和-product-uuid-的唯一性" class="headerlink" title="2、确保每个节点上 MAC 地址和 product_uuid 的唯一性"></a>2、确保每个节点上 MAC 地址和 product_uuid 的唯一性</h2><ul>
<li>使用命令 <code>ip link</code> 或 <code>ifconfig -a</code> 来获取网络接口的 MAC 地址</li>
<li>使用 <code>cat /sys/class/dmi/id/product_uuid</code> 命令对 product_uuid 校验</li>
</ul>
<p>一般来讲，硬件设备会拥有唯一的地址，但是有些虚拟机的地址可能会重复。 Kubernetes 使用这些值来唯一确定集群中的节点。</p>
<h2 id="3、允许-iptables-检查桥接流量"><a href="#3、允许-iptables-检查桥接流量" class="headerlink" title="3、允许 iptables 检查桥接流量"></a>3、允许 iptables 检查桥接流量</h2><p>3.1 安装依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release conntrack ipvsadm ipset jq sysstat curl iptables libseccomp</span><br></pre></td></tr></table></figure>
<p>3.2 关闭防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>
<p>确保 <code>br_netfilter</code> 模块被加载。这一操作可以通过运行 <code>lsmod | grep br_netfilter</code> 来完成。若要显式加载该模块，可执行 <code>modprobe br_netfilter</code>。</p>
<p>为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量，你需要确保在你的 <code>sysctl</code> 配置中将 <code>net.bridge.bridge-nf-call-iptables</code> 设置为 1。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | tee &#x2F;etc&#x2F;modules-load.d&#x2F;k8s.conf</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | sudo tee &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables &#x3D; 1</span><br><span class="line">net.ipv4.ip_forward&#x3D;1</span><br><span class="line">net.ipv4.tcp_tw_recycle&#x3D;0</span><br><span class="line">vm.swappiness&#x3D;0</span><br><span class="line">vm.overcommit_memory&#x3D;1</span><br><span class="line">vm.panic_on_oom&#x3D;0</span><br><span class="line">fs.inotify.max_user_watches&#x3D;89100</span><br><span class="line">fs.file-max&#x3D;52706963</span><br><span class="line">fs.nr_open&#x3D;52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6&#x3D;1</span><br><span class="line">net.netfilter.nf_conntrack_max&#x3D;2310720</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<p>3.3 加载内核模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;etc&#x2F;sysconfig&#x2F;modules&#x2F;ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 &#x2F;etc&#x2F;sysconfig&#x2F;modules&#x2F;ipvs.modules &amp;&amp; bash &#x2F;etc&#x2F;sysconfig&#x2F;modules&#x2F;ipvs.modules</span><br></pre></td></tr></table></figure>
<h2 id="4、检查所需端口"><a href="#4、检查所需端口" class="headerlink" title="4、检查所需端口"></a>4、检查所需端口</h2><h3 id="4-1-控制平面节点"><a href="#4-1-控制平面节点" class="headerlink" title="4.1 控制平面节点"></a>4.1 控制平面节点</h3><table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td>Kubernetes API 服务器</td>
<td>所有组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd 服务器客户端 API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet 自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>kube-scheduler 自身</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>kube-controller-manager 自身</td>
</tr>
</tbody></table>
<h3 id="4-2-工作节点"><a href="#4-2-工作节点" class="headerlink" title="4.2 工作节点"></a>4.2 工作节点</h3><table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>作用</th>
<th>使用者</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>kubelet 自身、控制平面组件</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>NodePort 服务†</td>
<td>所有组件</td>
</tr>
</tbody></table>
<h2 id="5、安装-runtime"><a href="#5、安装-runtime" class="headerlink" title="5、安装 runtime"></a>5、安装 runtime</h2><p>为了在 Pod 中运行容器，Kubernetes 使用容器运行时Container Runtime</p>
<p>默认情况下，Kubernetes 使用 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/components/#container-runtime">容器运行时接口（Container Runtime Interface，CRI）</a> 来与你所选择的容器运行时交互。</p>
<p>如果你不指定运行时，则 kubeadm 会自动尝试检测到系统上已经安装的运行时， 方法是扫描一组众所周知的 Unix 域套接字。 下面的表格列举了一些容器运行时及其对应的套接字路径：</p>
<table>
<thead>
<tr>
<th>运行时</th>
<th>域套接字</th>
</tr>
</thead>
<tbody><tr>
<td>Docker</td>
<td>/var/run/dockershim.sock</td>
</tr>
<tr>
<td>containerd</td>
<td>/run/containerd/containerd.sock</td>
</tr>
<tr>
<td>CRI-O</td>
<td>/var/run/crio/crio.sock</td>
</tr>
</tbody></table>
<p>如果同时检测到 Docker 和 containerd，则优先选择 Docker。 这是必然的，因为 Docker 18.09 附带了 containerd 并且两者都是可以检测到的， 即使你仅安装了 Docker。 如果检测到其他两个或多个运行时，kubeadm 输出错误信息并退出。</p>
<p>kubelet 通过内置的 <code>dockershim</code> CRI 实现与 Docker 集成。</p>
<h3 id="5-1-使用-containerd-作为-CRI-运行时"><a href="#5-1-使用-containerd-作为-CRI-运行时" class="headerlink" title="5.1 使用 containerd 作为 CRI 运行时"></a>5.1 使用 containerd 作为 CRI 运行时</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | tee &#x2F;etc&#x2F;modules-load.d&#x2F;containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"># 设置必需的 sysctl 参数，这些参数在重新启动后仍然存在。</span><br><span class="line">cat &lt;&lt;EOF | sudo tee &#x2F;etc&#x2F;sysctl.d&#x2F;99-kubernetes-cri.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables  &#x3D; 1</span><br><span class="line">net.ipv4.ip_forward                 &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 应用 sysctl 参数而无需重新启动</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<h3 id="5-2-安装-containerd"><a href="#5-2-安装-containerd" class="headerlink" title="5.2 安装 containerd"></a>5.2 安装 containerd</h3><ol>
<li><p>从官方Docker仓库安装 <code>containerd.io</code> 软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line">yum install -y containerd.io</span><br></pre></td></tr></table></figure></li>
<li><p>配置 containerd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;containerd</span><br><span class="line">containerd config default | tee &#x2F;etc&#x2F;containerd&#x2F;config.toml</span><br></pre></td></tr></table></figure></li>
<li><p>重新启动 containerd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart containerd</span><br><span class="line">systemctl enable containerd</span><br></pre></td></tr></table></figure>
<h3 id="5-3-使用-systemd-cgroup-驱动程序"><a href="#5-3-使用-systemd-cgroup-驱动程序" class="headerlink" title="5.3 使用 systemd cgroup 驱动程序"></a>5.3 使用 <code>systemd</code> cgroup 驱动程序</h3></li>
</ol>
<p>结合 <code>runc</code> 使用 <code>systemd</code> cgroup 驱动，在 <code>/etc/containerd/config.toml</code> 中设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sandbox_image &#x3D; &quot;registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;pause:3.2&quot; #换成阿里云</span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br><span class="line">  ...  </span><br><span class="line">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br><span class="line">    SystemdCgroup &#x3D; true</span><br></pre></td></tr></table></figure>
<p>再次重新启动 containerd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>
<h2 id="6、安装-kubeadm、kubelet-和-kubectl"><a href="#6、安装-kubeadm、kubelet-和-kubectl" class="headerlink" title="6、安装 kubeadm、kubelet 和 kubectl"></a>6、安装 kubeadm、kubelet 和 kubectl</h2><p>需要在每台机器上安装以下的软件包：</p>
<ul>
<li><code>kubeadm</code>：用来初始化集群的指令。</li>
<li><code>kubelet</code>：在集群中的每个节点上用来启动 Pod 和容器等。</li>
<li><code>kubectl</code>：用来与集群通信的命令行工具。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name&#x3D;Kubernetes</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kubernetes-el7-x86_64&#x2F;</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">repo_gpgcheck&#x3D;0</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;yum-key.gpg </span><br><span class="line">https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;rpm-package-key.gpg</span><br><span class="line">exclude&#x3D;kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes&#x3D;kubernetes</span><br><span class="line">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>
<p>kubelet 现在每隔几秒就会重启，因为它陷入了一个等待 kubeadm 指令的死循环。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;etc&#x2F;sysconfig&#x2F;kubelet &lt;&lt;EOF</span><br><span class="line">KUBELET_EXTRA_ARGS&#x3D;--cgroup-driver&#x3D;systemd --container-runtime&#x3D;remote --container-runtime-endpoint&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="7、初始化控制平面节点"><a href="#7、初始化控制平面节点" class="headerlink" title="7、初始化控制平面节点"></a>7、初始化控制平面节点</h2><p>如果计划将单个控制平面 kubeadm 集群升级成高可用， 应该指定 <code>--control-plane-endpoint</code> 为所有控制平面节点设置共享端点。 端点可以是负载均衡器的 DNS 名称或 IP 地址。</p>
<h3 id="7-1-kubeadm-init"><a href="#7-1-kubeadm-init" class="headerlink" title="7.1 kubeadm init"></a>7.1 kubeadm init</h3><h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><table>
<thead>
<tr>
<th>–apiserver-advertise-address string</th>
<th>API 服务器所公布的其正在监听的 IP 地址。如果未设置，则使用默认网络接口。</th>
</tr>
</thead>
<tbody><tr>
<td>–apiserver-bind-port int32   默认值：6443</td>
<td>API 服务器绑定的端口。</td>
</tr>
<tr>
<td>–apiserver-cert-extra-sans stringSlice</td>
<td>用于 API Server 服务证书的可选附加主题备用名称（SAN）。可以是 IP 地址和 DNS 名称。</td>
</tr>
<tr>
<td>–cert-dir string   默认值：”/etc/kubernetes/pki”</td>
<td>保存和存储证书的路径</td>
</tr>
<tr>
<td>–certificate-key string</td>
<td>用于加密 kubeadm-certs Secret 中的控制平面证书的密钥。</td>
</tr>
<tr>
<td>–config string</td>
<td>kubeadm 配置文件的路径。</td>
</tr>
<tr>
<td>–control-plane-endpoint string</td>
<td>为控制平面指定一个稳定的 IP 地址或 DNS 名称。</td>
</tr>
<tr>
<td>–cri-socket string</td>
<td>要连接的 CRI 套接字的路径。如果为空，则 kubeadm 将尝试自动检测此值；仅当安装了多个 CRI 或具有非标准 CRI 插槽时，才使用此选项。</td>
</tr>
<tr>
<td>–dry-run</td>
<td>不要应用任何更改；只是输出将要执行的操作。</td>
</tr>
<tr>
<td>–experimental-patches string</td>
<td>包含名为 “target[suffix][+patchtype].extension” 的文件的目录路径。 例如，”kube-apiserver0+merge.yaml” 或仅仅是 “etcd.json”。 “patchtype” 可以是 “strategic”、”merge” 或 “json” 之一，并且它们与 kubectl 支持的补丁格式匹配。 默认的 “patchtype” 为 “strategic”。 “extension” 必须为 “json” 或 “yaml”。 “suffix” 是一个可选字符串，可用于确定首先按字母顺序应用哪些补丁。</td>
</tr>
<tr>
<td>–feature-gates string</td>
<td>一组用来描述各种功能特性的键值（key=value）对。选项是： IPv6DualStack=true|false (ALPHA - default=false)</td>
</tr>
<tr>
<td>-h, –help</td>
<td>init 操作的帮助命令</td>
</tr>
<tr>
<td>–ignore-preflight-errors stringSlice</td>
<td>错误将显示为警告的检查列表；例如：’IsPrivilegedUser,Swap’。取值为 ‘all’ 时将忽略检查中的所有错误。</td>
</tr>
<tr>
<td>–image-repository string   默认值：”k8s.gcr.io”</td>
<td>选择用于拉取控制平面镜像的容器仓库</td>
</tr>
<tr>
<td>–kubernetes-version string   默认值：”stable-1”</td>
<td>为控制平面选择一个特定的 Kubernetes 版本。</td>
</tr>
<tr>
<td>–node-name string</td>
<td>指定节点的名称。</td>
</tr>
<tr>
<td>–pod-network-cidr string</td>
<td>指明 pod 网络可以使用的 IP 地址段。如果设置了这个参数，控制平面将会为每一个节点自动分配 CIDRs。</td>
</tr>
<tr>
<td>–service-cidr string   默认值：”10.96.0.0/12”</td>
<td>为服务的虚拟 IP 地址另外指定 IP 地址段</td>
</tr>
<tr>
<td>–service-dns-domain string   默认值：”cluster.local”</td>
<td>为服务另外指定域名，例如：”myorg.internal”。</td>
</tr>
<tr>
<td>–skip-certificate-key-print</td>
<td>不要打印用于加密控制平面证书的密钥。</td>
</tr>
<tr>
<td>–skip-phases stringSlice</td>
<td>要跳过的阶段列表</td>
</tr>
<tr>
<td>–skip-token-print</td>
<td>跳过打印 ‘kubeadm init’ 生成的默认引导令牌。</td>
</tr>
<tr>
<td>–token string</td>
<td>这个令牌用于建立控制平面节点与工作节点间的双向通信。格式为 [a-z0-9]{6}.[a-z0-9]{16} - 示例：abcdef.0123456789abcdef</td>
</tr>
<tr>
<td>–token-ttl duration   默认值：24h0m0s</td>
<td>令牌被自动删除之前的持续时间（例如 1 s，2 m，3 h）。如果设置为 ‘0’，则令牌将永不过期</td>
</tr>
<tr>
<td>–upload-certs</td>
<td>将控制平面证书上传到 kubeadm-certs Secret。</td>
</tr>
</tbody></table>
<h2 id="8、使用自定义的镜像"><a href="#8、使用自定义的镜像" class="headerlink" title="8、使用自定义的镜像"></a>8、使用自定义的镜像</h2><p>默认情况下, kubeadm 会从 <code>k8s.gcr.io</code> 仓库拉取镜像。如果请求的 Kubernetes 版本是 CI 标签 （例如 <code>ci/latest</code>），则使用 <code>gcr.io/kubernetes-ci-images</code>。</p>
<p>允许的自定义功能有：</p>
<ul>
<li>使用其他的 <code>imageRepository</code> 来代替 <code>k8s.gcr.io</code>。</li>
<li>将 <code>useHyperKubeImage</code> 设置为 <code>true</code>，使用 HyperKube 镜像。</li>
<li>为 etcd 或 DNS 附件提供特定的 <code>imageRepository</code> 和 <code>imageTag</code>。</li>
</ul>
<p>请注意配置文件中的配置项 <code>kubernetesVersion</code> 或者命令行参数 <code>--kubernetes-version</code> 会影响到镜像的版本。</p>
<p>以使用 <code>kubeadm config print</code> 命令打印默认配置， 并使用 <code>kubeadm config migrate</code> 命令将旧版本的配置转化成新版本。 <code>kubeadm config images list</code> 和 <code>kubeadm config images pull</code> 命令可以用来列出并拉取 kubeadm 所需的镜像。</p>
<h3 id="8-1-拉取阿里云镜像"><a href="#8-1-拉取阿里云镜像" class="headerlink" title="8.1 拉取阿里云镜像"></a>8.1 拉取阿里云镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers</span><br></pre></td></tr></table></figure>
<h3 id="8-2-初始化"><a href="#8-2-初始化" class="headerlink" title="8.2 初始化"></a>8.2 初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init   --kubernetes-version&#x3D;v1.21.0   --pod-network-cidr&#x3D;10.244.0.0&#x2F;16   --apiserver-advertise-address&#x3D;192.168.120.128   --image-repository&#x3D;registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers</span><br></pre></td></tr></table></figure>
<p>备注：如果初始化有问题，使用<code>reset</code>重置</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210507164420.png" alt="image-20210507164407170"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME&#x2F;.kube</span><br><span class="line">sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></figure>
<h3 id="8-3-安装calico网络"><a href="#8-3-安装calico网络" class="headerlink" title="8.3 安装calico网络"></a>8.3 安装calico网络</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;manifests&#x2F;calico.yaml#移除母版上的污点kubectl taint nodes --all node-role.kubernetes.io&#x2F;master-</span><br></pre></td></tr></table></figure>
<h3 id="8-4-添加自动补全命令"><a href="#8-4-添加自动补全命令" class="headerlink" title="8.4 添加自动补全命令"></a>8.4 添加自动补全命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release bash-completion</span><br><span class="line">source &#x2F;usr&#x2F;share&#x2F;bash-completion&#x2F;bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>
<p>根据初始化成功的提示加入从节点即可</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/" class="post-title-link" itemprop="url">Linux三剑客之awk</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:27:01" itemprop="dateCreated datePublished" datetime="2021-05-10T15:27:01+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/" class="post-meta-item leancloud_visitors" data-flag-title="Linux三剑客之awk" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>​            此命令的设计者有 3 位，他们的姓分别是 Aho、Weingberger 和 Kernighan，awk 就取自这 3 为大师姓的首字母。和 sed 命令类似，awk 命令也是逐行扫描文件（从第 1 行到最后一行），寻找含有目标文本的行，如果匹配成功，则会在该行上执行用户想要的操作；反之，则不对行做任何处理。</p>
<h2 id="2、基本语法"><a href="#2、基本语法" class="headerlink" title="2、基本语法"></a>2、基本语法</h2><p>awk 命令的基本格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# awk [选项] &#39;脚本命令&#39; 文件名</span><br></pre></td></tr></table></figure>
<p>此命令常用的选项以及各自的含义，如表</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-F fs</td>
<td>指定以 fs 作为输入行的分隔符，awk 命令默认分隔符为空格或制表符。</td>
</tr>
<tr>
<td>-f file</td>
<td>从脚本文件中读取 awk 脚本指令，以取代直接在命令行中输入指令。</td>
</tr>
<tr>
<td>-v var=val</td>
<td>在执行处理过程之前，设置一个变量 var，并给其设备初始值为 val。</td>
</tr>
</tbody></table>
<p>awk 的强大之处在于脚本命令，它由 2 部分组成，分别为匹配规则和执行命令，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;匹配规则&#123;执行命令&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>​        这里的匹配规则，和 sed 命令中的 address 部分作用相同，用来指定脚本命令可以作用到文本内容中的具体行，可以使用字符串（比如 /demo/，表示查看含有 demo 字符串的行）或者正则表达式指定。另外需要注意的是，整个脚本命令是用单引号（’’）括起，而其中的执行命令部分需要用大括号（{}）括起来。</p>
<p>在 awk 程序执行时，如果没有指定执行命令，则默认会把匹配的行输出；如果不指定匹配规则，则默认匹配文本中所有的行。</p>
<p>举个简单的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# awk &#39;&#x2F;^$&#x2F; &#123;print &quot;Blank line&quot;&#125;&#39; test.txt</span><br></pre></td></tr></table></figure>
<p>​        在此命令中，<code>/^$/</code> 是一个正则表达式，功能是匹配文本中的空白行，同时可以看到，执行命令使用的是 print 命令，此命令经常会使用，它的作用很简单，就是将指定的文本进行输出。因此，整个命令的功能是，如果 test.txt 有 N 个空白行，那么执行此命令会输出 N 个 Blank line。</p>
<h2 id="3、awk-使用数据字段变量"><a href="#3、awk-使用数据字段变量" class="headerlink" title="3、awk 使用数据字段变量"></a>3、awk 使用数据字段变量</h2><p>awk 的主要特性之一是其处理文本文件中数据的能力，它会自动给一行中的每个数据元素分配一个变量。</p>
<p>默认情况下，awk 会将如下变量分配给它在文本行中发现的数据字段：</p>
<ul>
<li>$0 代表整个文本行；</li>
<li>$1 代表文本行中的第 1 个数据字段；</li>
<li>$2 代表文本行中的第 2 个数据字段；</li>
<li>$n 代表文本行中的第 n 个数据字段。</li>
</ul>
<p>前面说过，在 awk 中，默认的字段分隔符是任意的空白字符（例如空格或制表符）。 在文本行中，每个数据字段都是通过字段分隔符划分的。awk 在读取一行文本时，会用预定义的字段分隔符划分每个数据字段。</p>
<p>所以在下面的例子中，awk 程序读取文本文件，只显示第 1 个数据字段的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">[root@node1 ~]# awk &#39;&#123;print $5&#125;&#39;  data2.txt</span><br><span class="line">1.</span><br><span class="line">2.</span><br><span class="line">3.</span><br><span class="line">4.</span><br></pre></td></tr></table></figure>
<p>该程序用 $5 字段变量来表示“仅显示每行文本的第 5 个数据字段”。当然，如果你要读取采用了其他字段分隔符的文件，可以用 -F 选项手动指定。</p>
<h2 id="4、awk-脚本命令使用多个命令"><a href="#4、awk-脚本命令使用多个命令" class="headerlink" title="4、awk 脚本命令使用多个命令"></a>4、awk 脚本命令使用多个命令</h2><p>awk 允许将多条命令组合成一个正常的程序。要在命令行上的程序脚本中使用多条命令，只要在命令之间放个分号即可，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">[root@node1 ~]# awk &#39;&#123;$4&#x3D;&quot;line&quot;;print $0&#125;&#39;  data2.txt</span><br><span class="line">This is line line 1.</span><br><span class="line">This is line line 2.</span><br><span class="line">This is line line 3.</span><br><span class="line">This is line line 4.</span><br></pre></td></tr></table></figure>
<p>第一条命令会给字段变量 $4 赋值。第二条命令会打印整个数据字段。可以看到，awk 程序在输出中已经将原文本中的第四个数据字段替换成了新值。</p>
<p>除此之外，也可以一次一行地输入程序脚本命令，比如说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# awk &#39;&#123;</span><br><span class="line">&gt; $3&#x3D;&quot;tom&quot;</span><br><span class="line">&gt; print $0&#125;&#39;</span><br><span class="line">my name hello</span><br><span class="line">my name tom</span><br></pre></td></tr></table></figure>
<p>在你用了表示起始的单引号后，bash shell 会使用 &gt; 来提示输入更多数据，我们可以每次在每行加一条命令，直到输入了结尾的单引号。</p>
<p>注意，此例中因为没有在命令行中指定文件名，awk 程序需要用户输入获得数据，因此当运行这个程序的时候，它会一直等着用户输入文本，此时如果要退出程序，只需按下 Ctrl+D 组合键即可。</p>
<h2 id="5、awk从文件中读取程序"><a href="#5、awk从文件中读取程序" class="headerlink" title="5、awk从文件中读取程序"></a>5、awk从文件中读取程序</h2><p>跟 sed 一样，awk 允许将脚本命令存储到文件中，然后再在命令行中引用，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat awk.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">&#123;print $1 &quot;&#39;s wellcom to beijing&#39;&quot; $6&#125;</span><br><span class="line">[root@node1 ~]# awk -F: -f awk.sh &#x2F;etc&#x2F;passwd</span><br><span class="line">root&#39;s wellcom to beijing&#39;&#x2F;root</span><br><span class="line">bin&#39;s wellcom to beijing&#39;&#x2F;bin</span><br><span class="line">daemon&#39;s wellcom to beijing&#39;&#x2F;sbin</span><br><span class="line">adm&#39;s wellcom to beijing&#39;&#x2F;var&#x2F;adm</span><br></pre></td></tr></table></figure>
<p>awk.sh 脚本文件会使用 print 命令打印 /etc/passwd 文件的主目录数据字段（字段变量 $6），以及 userid 数据字段（字段变量 $1）。注意，在程序文件中，也可以指定多条命令，只要一条命令放一行即可，之间不需要用分号。</p>
<h2 id="6、awk-BEGIN关键字"><a href="#6、awk-BEGIN关键字" class="headerlink" title="6、awk BEGIN关键字"></a>6、awk BEGIN关键字</h2><p>awk 中还可以指定脚本命令的运行时机。默认情况下，awk 会从输入中读取一行文本，然后针对该行的数据执行程序脚本，但有时可能需要在处理数据前运行一些脚本命令，这就需要使用 BEGIN 关键字。</p>
<p>BEGIN 会强制 awk 在读取数据前执行该关键字后指定的脚本命令，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">[root@node1 ~]# awk &#39;BEGIN &#123;print &quot;hello world:&quot;&#125; &#123;print $5&#125;&#39; data2.txt</span><br><span class="line">hello world:</span><br><span class="line">1.</span><br><span class="line">2.</span><br><span class="line">3.</span><br><span class="line">4.</span><br></pre></td></tr></table></figure>
<p>可以看到，这里的脚本命令中分为 2 部分，BEGIN 部分的脚本指令会在 awk 命令处理数据前运行，而真正用来处理数据的是第二段脚本命令。</p>
<h2 id="7、awk-END关键字"><a href="#7、awk-END关键字" class="headerlink" title="7、awk END关键字"></a>7、awk END关键字</h2><p>和 BEGIN 关键字相对应，END 关键字允许我们指定一些脚本命令，awk 会在读完数据后执行它们，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# awk &#39;BEGIN &#123;print &quot;hello world:&quot;&#125; &#123;print $5&#125; END &#123;print &quot;love china&quot;&#125;&#39; data2.txt</span><br><span class="line">hello world:</span><br><span class="line">1.</span><br><span class="line">2.</span><br><span class="line">3.</span><br><span class="line">4.</span><br><span class="line">love china</span><br></pre></td></tr></table></figure>
<p>可以看到，当 awk 程序打印完文件内容后，才会执行 END 中的脚本命令。</p>
<h2 id="8、归纳总结"><a href="#8、归纳总结" class="headerlink" title="8、归纳总结"></a>8、归纳总结</h2><h3 id="一-内置变量"><a href="#一-内置变量" class="headerlink" title="(一)内置变量"></a><strong>(一)内置变量</strong></h3><p>\1. 每一行内容记录，叫做记录，英文名称 Record</p>
<p>\2. 每行中通过分隔符隔开的每一列，叫做字段，英文名称 Field</p>
<p>明确这几个概念后，我们来总结几个重要的内置变量：</p>
<ul>
<li>NR：表示当前的行数;</li>
<li>NF：表示当前的列数;</li>
<li>RS：行分隔符，默认是换行;</li>
<li>FS：列分隔符，默认是空格和制表符;</li>
<li>OFS：输出列分隔符，用于打印时分割字段，默认为空格</li>
<li>ORS：输出行分隔符，用于打印时分割记录，默认为换行符</li>
</ul>
<h3 id="二-输出格式"><a href="#二-输出格式" class="headerlink" title="(二)输出格式"></a><strong>(二)输出格式</strong></h3><p>awk 提供 printf 函数进行格式化输出功能，具体的使用方式和 C 语法基本一致。</p>
<p>基本用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;%12s, %02d, %0.2f\n&quot;, s, d, g);</span><br></pre></td></tr></table></figure>
<p>常用的格式化方式：</p>
<ul>
<li>%d 十进制有符号整数</li>
<li>%u 十进制无符号整数</li>
<li>%f 浮点数</li>
<li>%s 字符串</li>
<li>%c 单个字符</li>
<li>%e 指数形式的浮点数</li>
<li>%x %X 无符号以十六进制表示的整数</li>
<li>%0 无符号以八进制表示的整数</li>
<li>%g 自动选择合适的表示法</li>
<li>\n 换行符</li>
<li>\t Tab符</li>
</ul>
<h3 id="三-编程语句"><a href="#三-编程语句" class="headerlink" title="(三)编程语句"></a><strong>(三)编程语句</strong></h3><p>awk 不仅是一个 Linux 命令行工具，它其实是一门脚本语言，支持程序设计语言所有的控制结构，它支持：</p>
<ul>
<li>条件语句</li>
<li>循环语句</li>
<li>数组</li>
<li>函数</li>
</ul>
<h3 id="四-常用函数"><a href="#四-常用函数" class="headerlink" title="(四)常用函数"></a><strong>(四)常用函数</strong></h3><p>awk 内置了大量的有用函数功能，也支持自定义函数，允许你编写自己的函数来扩展内置函数。</p>
<p>这里只简单罗列一些比较常用的字符串函数：</p>
<ul>
<li>index(s, t) 返回子串 t 在 s 中的位置</li>
<li>length(s) 返回字符串 s 的长度</li>
<li>split(s, a, sep) 分割字符串，并将分割后的各字段存放在数组 a 中</li>
<li>substr(s, p, n) 根据参数，返回子串</li>
<li>tolower(s) 将字符串转换为小写</li>
<li>toupper(s) 将字符串转换为大写</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BGrep/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BGrep/" class="post-title-link" itemprop="url">Linux三剑客之Grep</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:25:53" itemprop="dateCreated datePublished" datetime="2021-05-10T15:25:53+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BGrep/" class="post-meta-item leancloud_visitors" data-flag-title="Linux三剑客之Grep" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>grep 命令的由来可以追溯到 UNIX 诞生的早期，在 UNIX 系统中，搜索的模式（patterns）被称为正则表达式（regular expressions），为了要彻底搜索一个文件，有的用户在要搜索的字符串前加上前缀 global（全面的），一旦找到相匹配的内容，用户就像将其输出（print）到屏幕上，而将这一系列的操作整合到一起就是 global regular expressions print，而这也就是 grep 命令的全称。</p>
<p>grep命令能够在一个或多个文件中，搜索某一特定的字符模式（也就是正则表达式），此模式可以是单一的字符、字符串、单词或句子。</p>
<p>正则表达式是描述一组字符串的一个模式，正则表达式的构成模仿了数学表达式，通过使用操作符将较小的表达式组合成一个新的表达式。正则表达式可以是一些纯文本文字，也可以是用来产生模式的一些特殊字符。为了进一步定义一个搜索模式，grep 命令支持如下表所示的这几种正则表达式的元字符（也就是通配符）。</p>
<table>
<thead>
<tr>
<th>通配符</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>c*</td>
<td>将匹配 0 个（即空白）或多个字符 c（c 为任一字符）。</td>
</tr>
<tr>
<td>.</td>
<td>将匹配任何一个字符，且只能是一个字符。</td>
</tr>
<tr>
<td>[xyz]</td>
<td>匹配方括号中的任意一个字符。</td>
</tr>
<tr>
<td>[^xyz]</td>
<td>匹配除方括号中字符外的所有字符。</td>
</tr>
<tr>
<td>^</td>
<td>锁定行的开头。</td>
</tr>
<tr>
<td>$</td>
<td>锁定行的结尾。</td>
</tr>
</tbody></table>
<p>需要注意的是，在基本正则表达式中，如通配符 <em>、+、{、|、( 和 )等，已经失去了它们原本的含义，而若要恢复它们原本的含义，则要在之前添加反斜杠 \，如 \</em>、+、{、|、( 和 )。</p>
<p>grep 命令是用来在每一个文件或中（或特定输出上）搜索特定的模式，当使用 grep 时，包含指定字符模式的每一行内容，都会被打印（显示）到屏幕上，但是使用 grep 命令并不改变文件中的内容。</p>
<p>这里的模式，要么是字符（串），要么是正则表达式。而此命令常用的选项以及各自的含义如下表所示。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-c</td>
<td>仅列出文件中包含模式的行数。</td>
</tr>
<tr>
<td>-i</td>
<td>忽略模式中的字母大小写。</td>
</tr>
<tr>
<td>-l</td>
<td>列出带有匹配行的文件名。</td>
</tr>
<tr>
<td>-n</td>
<td>在每一行的最前面列出行号。</td>
</tr>
<tr>
<td>-v</td>
<td>列出没有匹配模式的行。</td>
</tr>
<tr>
<td>-w</td>
<td>把表达式当做一个完整的单字符来搜寻，忽略那些部分匹配的行。</td>
</tr>
</tbody></table>
<p>注意，如果是搜索多个文件，grep 命令的搜索结果只显示文件中发现匹配模式的文件名；而如果搜索单个文件，grep 命令的结果将显示每一个包含匹配模式的行。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BSed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BSed/" class="post-title-link" itemprop="url">Linux三剑客之Sed</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:24:30" itemprop="dateCreated datePublished" datetime="2021-05-10T15:24:30+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Linux%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BSed/" class="post-meta-item leancloud_visitors" data-flag-title="Linux三剑客之Sed" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>sed 会根据脚本命令来处理文本文件中的数据，这些命令要么从命令行中输入，要么存储在一个文本文件中，此命令执行数据的顺序如下：</p>
<ol>
<li>每次仅读取一行内容；</li>
<li>根据提供的规则命令匹配并修改数据。注意，sed 默认不会直接修改源文件数据，而是会将数据复制到缓冲区中，修改也仅限于缓冲区中的数据；</li>
<li>将执行结果输出。</li>
</ol>
<p>当一行数据匹配完成后，它会继续读取下一行数据，并重复这个过程，直到将文件中所有数据处理完毕。</p>
<h2 id="2、格式"><a href="#2、格式" class="headerlink" title="2、格式"></a>2、格式</h2><p>sed 命令的基本格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# sed [选项] [脚本命令] 文件名</span><br></pre></td></tr></table></figure>
<p>该命令常用的选项及含义，如表图所示</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-e 脚本命令</td>
<td>该选项会将其后跟的脚本命令添加到已有的命令中。</td>
</tr>
<tr>
<td>-f 脚本命令文件</td>
<td>该选项会将其后文件中的脚本命令添加到已有的命令中。</td>
</tr>
<tr>
<td>-n</td>
<td>默认情况下，sed 会在所有的脚本指定执行完毕后，会自动输出处理后的内容，而该选项会屏蔽启动输出，需使用 print 命令来完成输出。</td>
</tr>
<tr>
<td>-i</td>
<td>此选项会直接修改源文件，要慎用。</td>
</tr>
</tbody></table>
<h2 id="3、参数"><a href="#3、参数" class="headerlink" title="3、参数"></a>3、参数</h2><p>文件：指定待处理的文本文件列表。</p>
<h4 id="sed常用命令"><a href="#sed常用命令" class="headerlink" title="sed常用命令"></a>sed常用命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">a\ 在当前行下面插入文本;</span><br><span class="line">i\ 在当前行上面插入文本;</span><br><span class="line">c\ 把选定的行改为新的文本;</span><br><span class="line">d 删除，删除选择的行;</span><br><span class="line">D 删除模板块的第一行;</span><br><span class="line">s 替换指定字符;</span><br><span class="line">h 拷贝模板块的内容到内存中的缓冲区;</span><br><span class="line">H 追加模板块的内容到内存中的缓冲区;</span><br><span class="line">g 获得内存缓冲区的内容，并替代当前模板块中的文本;</span><br><span class="line">G 获得内存缓冲区的内容，并追加到当前模板块文本的后面;</span><br><span class="line">l 列表不能打印字符的清单;</span><br><span class="line">n 读取下一个输入行，用下一个命令处理新的行而不是用第一个命令;</span><br><span class="line">N 追加下一个输入行到模板块后面并在二者间嵌入一个新行，改变当前行号码;</span><br><span class="line">p 打印模板块的行。 P(大写) 打印模板块的第一行;</span><br><span class="line">q 退出Sed;</span><br><span class="line">b lable 分支到脚本中带有标记的地方，如果分支不存在则分支到脚本的末尾;</span><br><span class="line">r file 从file中读行;</span><br><span class="line">t label if分支，从最后一行开始，条件一旦满足或者T，t命令，将导致分支到带有标号的命令处，或者到脚本的末尾;</span><br><span class="line">T label 错误分支，从最后一行开始，一旦发生错误或者T，t命令，将导致分支到带有标号的命令处，或者到脚本的末尾;</span><br><span class="line">w file 写并追加模板块到file末尾;</span><br><span class="line">W file 写并追加模板块的第一行到file末尾;</span><br><span class="line">! 表示后面的命令对所有没有被选定的行发生作用;</span><br><span class="line">&#x3D; 打印当前行号;</span><br><span class="line"># 把注释扩展到下一个换行符以前;</span><br></pre></td></tr></table></figure>
<h4 id="sed替换标记"><a href="#sed替换标记" class="headerlink" title="sed替换标记"></a>sed替换标记</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">g 表示行内全面替换;</span><br><span class="line">p 表示打印行;</span><br><span class="line">w 表示把行写入一个文件;</span><br><span class="line">x 表示互换模板块中的文本和缓冲区中的文本;</span><br><span class="line">y 表示把一个字符翻译为另外的字符（但是不用于正则表达式）;</span><br><span class="line">\1 子串匹配标记;</span><br><span class="line">&amp; 已匹配字符串标记;</span><br></pre></td></tr></table></figure>
<h4 id="sed元字符集"><a href="#sed元字符集" class="headerlink" title="sed元字符集"></a>sed元字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">^ 匹配行开始，如：&#x2F;^sed&#x2F;匹配所有以sed开头的行;</span><br><span class="line">$ 匹配行结束，如：&#x2F;sed$&#x2F;匹配所有以sed结尾的行;</span><br><span class="line">. 匹配一个非换行符的任意字符，如：&#x2F;s.d&#x2F;匹配s后接一个任意字符，最后是d;</span><br><span class="line">* 匹配0个或多个字符，如：&#x2F;*sed&#x2F;匹配所有模板是一个或多个空格后紧跟sed的行;</span><br><span class="line">[] 匹配一个指定范围内的字符，如&#x2F;[ss]ed&#x2F;匹配sed和Sed;</span><br><span class="line">[^] 匹配一个不在指定范围内的字符，如：&#x2F;[^A-RT-Z]ed&#x2F;匹配不包含A-R和T-Z的一个字母开头，紧跟ed的行;</span><br><span class="line">\(..\) 匹配子串，保存匹配的字符，如s&#x2F;\(love\)able&#x2F;\1rs，loveable被替换成lovers;</span><br><span class="line">&amp; 保存搜索字符用来替换其他字符，如s&#x2F;love&#x2F;**&amp;**&#x2F;，love这成**love**;</span><br><span class="line">\&lt; 匹配单词的开始，如:&#x2F;\</span><br><span class="line">\&gt; 匹配单词的结束，如&#x2F;love\&gt;&#x2F;匹配包含以love结尾的单词的行;</span><br><span class="line">x\&#123;m\&#125; 重复字符x，m次，如：&#x2F;0\&#123;5\&#125;&#x2F;匹配包含5个0的行;</span><br><span class="line">x\&#123;m,\&#125; 重复字符x，至少m次，如：&#x2F;0\&#123;5,\&#125;&#x2F;匹配至少有5个0的行;</span><br><span class="line">x\&#123;m,n\&#125; 重复字符x，至少m次，不多于n次，如：&#x2F;0\&#123;5,10\&#125;&#x2F;匹配5~10个0的行;</span><br></pre></td></tr></table></figure>
<h2 id="4、脚本命令"><a href="#4、脚本命令" class="headerlink" title="4、脚本命令"></a>4、脚本命令</h2><h3 id="4-1-替换命令：s"><a href="#4-1-替换命令：s" class="headerlink" title="4.1 替换命令：s"></a>4.1 替换命令：s</h3><p>此命令的基本格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[address]s&#x2F;pattern&#x2F;replacement&#x2F;flags</span><br></pre></td></tr></table></figure>
<p>其中，address 表示指定要操作的具体行，pattern 指的是需要替换的内容，replacement 指的是要替换的新内容。</p>
<p>此命令中常用的 flags 标记如下表所示</p>
<table>
<thead>
<tr>
<th>flags 标记</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>n</td>
<td>1~512 之间的数字，表示指定要替换的字符串出现第几次时才进行替换，例如，一行中有 3 个 A，但用户只想替换第二个 A，这是就用到这个标记；</td>
</tr>
<tr>
<td>g</td>
<td>对数据中所有匹配到的内容进行替换，如果没有 g，则只会在第一次匹配成功时做替换操作。例如，一行数据中有 3 个 A，则只会替换第一个 A；</td>
</tr>
<tr>
<td>p</td>
<td>会打印与替换命令中指定的模式匹配的行。此标记通常与 -n 选项一起使用。</td>
</tr>
<tr>
<td>w file</td>
<td>将缓冲区中的内容写到指定的 file 文件中；</td>
</tr>
<tr>
<td>&amp;</td>
<td>用正则表达式匹配的内容进行替换；</td>
</tr>
<tr>
<td>\n</td>
<td>匹配第 n 个子串，该子串之前在 pattern 中用 () 指定。</td>
</tr>
<tr>
<td>\</td>
<td>转义（转义替换部分包含：&amp;、\ 等）。</td>
</tr>
</tbody></table>
<p>查看原文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data1.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">This is the second test of the test script.</span><br></pre></td></tr></table></figure>
<p>替换后为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;s&#x2F;test&#x2F;hello&#x2F;2&#39; data1.txt</span><br><span class="line">This is a test of the hello script.</span><br><span class="line">This is the second test of the hello script.</span><br></pre></td></tr></table></figure>
<p>可以看到，使用数字 2 作为标记的结果就是，sed 编辑器只替换每行中第 2 次出现的匹配模式。</p>
<p>如果要用新文件替换所有匹配的字符串，可以使用 g 标记：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;s&#x2F;test&#x2F;hello&#x2F;g&#39; data1.txt</span><br><span class="line">This is a hello of the hello script.</span><br><span class="line">This is the second hello of the hello script.</span><br></pre></td></tr></table></figure>
<p>-n 选项会禁止 sed 输出，但 p 标记会输出修改过的行，将二者匹配使用的效果就是只输出被替换命令修改过的行，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data1.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">This is the second test of the test script.</span><br><span class="line">[root@node1 ~]# sed -n &#39;s&#x2F;second&#x2F;hello&#x2F;p&#39; data1.txt</span><br><span class="line">This is the hello test of the test script.</span><br></pre></td></tr></table></figure>
<p>w 标记会将匹配后的结果保存到指定文件中，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;s&#x2F;second&#x2F;hello&#x2F;w test.txt&#39; data1.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">This is the hello test of the test script.</span><br><span class="line">[root@node1 ~]# cat test.txt</span><br><span class="line">This is the hello test of the test script.</span><br></pre></td></tr></table></figure>
<p>在使用 s 脚本命令时，替换类似文件路径的字符串会比较麻烦，需要将路径中的正斜线进行转义，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat &#x2F;etc&#x2F;passwd</span><br><span class="line">test:x:1000:1000::&#x2F;home&#x2F;test:&#x2F;bin&#x2F;bash</span><br><span class="line">[root@node1 ~]# sed -n &#39;s&#x2F;\&#x2F;home\&#x2F;test&#x2F;\&#x2F;home\&#x2F;hello&#x2F;p&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">test:x:1000:1000::&#x2F;home&#x2F;hello:&#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>
<p>以上命令中字符 / 在sed中作为定界符使用，也可以使用任意的定界符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;s:test:ok:g&#39; data1.txt</span><br><span class="line">This is a ok of the ok script.</span><br><span class="line">This is the second ok of the ok script.</span><br><span class="line">[root@node1 ~]# sed &#39;s#test#ok1#g&#39; data1.txt</span><br><span class="line">This is a ok1 of the ok1 script.</span><br><span class="line">This is the second ok1 of the ok1 script.</span><br><span class="line">[root@node1 ~]# sed &#39;s|test|ok2|g&#39; data1.txt</span><br><span class="line">This is a ok2 of the ok2 script.</span><br><span class="line">This is the second ok2 of the ok2 script.</span><br></pre></td></tr></table></figure>
<h3 id="4-2-删除命令：d"><a href="#4-2-删除命令：d" class="headerlink" title="4.2 删除命令：d"></a>4.2 删除命令：d</h3><p>删除空白行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">[root@node1 ~]# sed &#39;&#x2F;^$&#x2F;d&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<p>删除指定行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;2d&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<p>删除第二行到末尾所有行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;2,$d&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br></pre></td></tr></table></figure>
<p>删除最后一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;$d&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br></pre></td></tr></table></figure>
<p><strong>在此强调，在默认情况下 sed 并不会修改原始文件，这里被删除的行只是从 sed 的输出中消失了，原始文件没做任何改变。</strong></p>
<h3 id="4-3-插入命令：a和i"><a href="#4-3-插入命令：a和i" class="headerlink" title="4.3 插入命令：a和i"></a>4.3 插入命令：a和i</h3><p>a 命令表示在指定行的后面附加一行，i 命令表示在指定行的前面插入一行，这里之所以要同时介绍这 2 个脚本命令，因为它们的基本格式完全相同，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;3i&#x2F;This is an inserted line.&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is an inserted line.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;3a&#x2F;This is an inserted line.&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is an inserted line.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<h3 id="4-4-替换文本命令：c"><a href="#4-4-替换文本命令：c" class="headerlink" title="4.4 替换文本命令：c"></a>4.4 替换文本命令：c</h3><p>c 命令表示将指定行中的所有内容，替换成该选项后面的字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;3c&#x2F;This is an inserted line test.&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is an inserted line test.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<h3 id="4-5-转换命令：y"><a href="#4-5-转换命令：y" class="headerlink" title="4.5 转换命令：y"></a>4.5 转换命令：y</h3><p>y 转换命令是唯一可以处理单个字符的 sed 脚本命令</p>
<p>转换命令会对 inchars 和 outchars 值进行一对一的映射，即 inchars 中的第一个字符会被转换为 outchars 中的第一个字符，第二个字符会被转换成 outchars 中的第二个字符…这个映射过程会一直持续到处理完指定字符。如果 inchars 和 outchars 的长度不同，则 sed 会产生一条错误消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 5.</span><br><span class="line">This is line number 6.</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">[root@node1 ~]# sed &#39;y&#x2F;123&#x2F;789&#x2F;&#39; data2.txt</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 5.</span><br><span class="line">This is line number 6.</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br></pre></td></tr></table></figure>
<p>可以看到，inchars 模式中指定字符的每个实例都会被替换成 outchars 模式中相同位置的那个字符。</p>
<p>转换命令是一个全局命令，也就是说，它会文本行中找到的所有指定字符自动进行转换，而不会考虑它们出现的位置，再打个比方：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 5.</span><br><span class="line">This is line number 6.</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">This is line number 10.</span><br><span class="line">This is line number 11.</span><br><span class="line">This is line number 12.</span><br><span class="line">[root@node1 ~]# sed &#39;y&#x2F;123&#x2F;789&#x2F;&#39; data2.txt</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 5.</span><br><span class="line">This is line number 6.</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">This is line number 70.</span><br><span class="line">This is line number 77.</span><br><span class="line">This is line number 78.</span><br></pre></td></tr></table></figure>
<p><strong>sed 转换了在文本行中匹配到的字符，无法限定只转换在特定地方出现的字符。</strong></p>
<h3 id="4-6-打印命令：p"><a href="#4-6-打印命令：p" class="headerlink" title="4.6 打印命令：p"></a>4.6 打印命令：p</h3><p>p 命令表示搜索符号条件的行，并输出该行的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">[root@node1 ~]# sed -n &#39;&#x2F;number 2&#x2F;p&#39; data2.txt</span><br><span class="line">This is line number 2.</span><br></pre></td></tr></table></figure>
<p>可以看到，用 -n 选项和 p 命令配合使用，我们可以禁止输出其他行，只打印包含匹配文本模式的行。</p>
<p>如果需要在修改之前查看行，也可以使用打印命令，比如与替换或修改命令一起使用。可以创建一个脚本在修改行之前显示该行，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed -n &#39;&#x2F;3&#x2F;&#123;&gt; p&gt; s&#x2F;line&#x2F;test&#x2F;p&gt; &#125;&#39; data2.txt</span><br><span class="line">This is line number 3.</span><br><span class="line">This is test number 3.</span><br></pre></td></tr></table></figure>
<h3 id="4-7-写入命令：w"><a href="#4-7-写入命令：w" class="headerlink" title="4.7 写入命令：w"></a>4.7 写入命令：w</h3><p>w 命令用来将文本中指定行的内容写入文件中，如果不想让行直接输出，可以用 -n 选项</p>
<p>可以看到，通过使用 w 脚本命令，sed 可以实现将包含文本模式的数据行写入目标文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed -n &#39;1,2w test2.txt&#39; data2.txt</span><br><span class="line">[root@node1 ~]# cat test2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br></pre></td></tr></table></figure>
<h3 id="4-8-插入文件命令：r"><a href="#4-8-插入文件命令：r" class="headerlink" title="4.8 插入文件命令：r"></a>4.8 插入文件命令：r</h3><p>r 命令用于将一个独立文件的数据插入到当前数据流的指定位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# cat test2.txt</span><br><span class="line">hello world</span><br><span class="line">This is line number 2.</span><br><span class="line">[root@node1 ~]# sed &#39;2r test2.txt&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">hello world</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br></pre></td></tr></table></figure>
<p>如果你想将指定文件中的数据插入到数据流的末尾，可以使用 $ 地址符</p>
<h3 id="4-9-退出命令：q"><a href="#4-9-退出命令：q" class="headerlink" title="4.9 退出命令：q"></a>4.9 退出命令：q</h3><p>q 命令的作用是使 sed 命令在第一次匹配任务结束后，退出 sed 程序，不再进行对后续数据的处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed &#39;2q&#39; data2.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br></pre></td></tr></table></figure>
<h3 id="4-10-多点编辑：e"><a href="#4-10-多点编辑：e" class="headerlink" title="4.10 多点编辑：e"></a>4.10 多点编辑：e</h3><p>允许在同一行里执行多条命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# sed -e &#39;1d&#39; -e &#39;s&#x2F;line&#x2F;hello&#x2F;&#39; data2.txt</span><br><span class="line">This is hello number 2.</span><br><span class="line">This is hello number 3.</span><br><span class="line">This is hello number 4.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Linux-rsync%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Linux-rsync%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">Linux rsync命令用法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:23:30" itemprop="dateCreated datePublished" datetime="2021-05-10T15:23:30+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Linux-rsync%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95/" class="post-meta-item leancloud_visitors" data-flag-title="Linux rsync命令用法" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>​        从字面意思上，rsync 可以理解为 remote sync（远程同步），但它不仅可以远程同步数据（类似于 scp 命令），还可以本地同步数据（类似于 cp 命令）。不同于 cp 或 scp 的一点是，使用 rsync 命令备份数据时，不会直接覆盖以前的数据（如果数据已经存在），而是先判断已经存在的数据和新数据的差异，只有数据不同时才会把不相同的部分覆盖。</p>
<h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><p>在Centos中使用以下命令安装rsync：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rsync</span><br></pre></td></tr></table></figure>
<h2 id="3、工作模式"><a href="#3、工作模式" class="headerlink" title="3、工作模式"></a>3、工作模式</h2><p>rsync 有 5 种不同的工作模式：</p>
<ul>
<li>第一种用于仅在本地备份数据；</li>
<li>第二种用于将本地数据备份到远程机器上；</li>
<li>第三种用于将远程机器上的数据备份到本地机器上；</li>
<li>第四种和第三种是相对的，同样第五种和第二种是相对的，它们各自之间的区别在于登陆认证时使用的验证方式不同。</li>
</ul>
<p>要知道，使用 rsync 在远程传输数据（备份数据）前，是需要进行登陆认证的，这个过程需要借助 ssh 协议或者 rsync 协议才能完成。在 rsync 命令中，如果使用单个冒号（:），则默认使用 ssh 协议；反之，如果使用两个冒号（::），则使用 rsync 协议。</p>
<blockquote>
<p>ssh 协议和 rsync 协议的区别在于，rsync 协议在使用时需要额外配置，增加了工作量，但优势是更加安全；反之，ssh 协议使用方便，无需进行配置，但有泄漏服务器密码的风险。</p>
</blockquote>
<h2 id="4、参数列表"><a href="#4、参数列表" class="headerlink" title="4、参数列表"></a>4、参数列表</h2><p>另外，以上几种格式中各个参数的含义如下：</p>
<ul>
<li>SRC：用来表示要备份的目标数据所在的位置（路径）；</li>
<li>DEST：用于表示将数据备份到什么位置；</li>
<li>USER@：当做远程同步操作时，需指明系统登录的用户名，如果不显示指定，默认为以 root 身份登录系统并完成同步操作。</li>
</ul>
<p>rsync 命令提供使用的 OPTION 及功能如表</p>
<table>
<thead>
<tr>
<th>OPTION选项</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>这是归档模式，表示以递归方式传输文件，并保持所有属性，它等同于-r、-l、-p、-t、-g、-o、-D 选项。-a 选项后面可以跟一个 –no-OPTION，表示关闭 -r、-l、-p、-t、-g、-o、-D 中的某一个，<strong>比如-a   –no-l 等同于 -r、-p、-t、-g、-o、-D 选项。</strong></td>
</tr>
<tr>
<td>-r</td>
<td>表示以递归模式处理子目录，它主要是针对目录来说的，如果单独传一个文件不需要加 -r 选项，但是传输目录时必须加。</td>
</tr>
<tr>
<td>-v</td>
<td>表示打印一些信息，比如文件列表、文件数量等。</td>
</tr>
<tr>
<td>-l</td>
<td>表示保留软连接。</td>
</tr>
<tr>
<td>-L</td>
<td>表示像对待常规文件一样处理软连接。如果是 SRC 中有软连接文件，则加上该选项后，将会把软连接指向的目标文件复制到 DEST。</td>
</tr>
<tr>
<td>-p</td>
<td>表示保持文件权限。</td>
</tr>
<tr>
<td>-o</td>
<td>表示保持文件属主信息。</td>
</tr>
<tr>
<td>-g</td>
<td>表示保持文件属组信息。</td>
</tr>
<tr>
<td>-D</td>
<td>表示保持设备文件信息。</td>
</tr>
<tr>
<td>-t</td>
<td>表示保持文件时间信息。</td>
</tr>
<tr>
<td>–delete</td>
<td>表示删除 DEST 中 SRC 没有的文件。</td>
</tr>
<tr>
<td>–exclude=PATTERN</td>
<td>表示指定排除不需要传输的文件，等号后面跟文件名，可以是通配符模式（如 *.txt）。</td>
</tr>
<tr>
<td>–progress</td>
<td>表示在同步的过程中可以看到同步的过程状态，比如统计要同步的文件数量、 同步的文件传输速度等。</td>
</tr>
<tr>
<td>-u</td>
<td>表示把 DEST 中比 SRC 还新的文件排除掉，不会覆盖。</td>
</tr>
<tr>
<td>-z</td>
<td>加上该选项，将会在传输过程中压缩。</td>
</tr>
</tbody></table>
<h2 id="5、本机中的两个目录进行同步"><a href="#5、本机中的两个目录进行同步" class="headerlink" title="5、本机中的两个目录进行同步"></a>5、本机中的两个目录进行同步</h2><p>要同步本地计算机中的两个目录，使用<code>rsync -zvr</code>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# mkdir &#x2F;rsync</span><br><span class="line">[root@node1 ~]# rsync -zvr &#x2F;var&#x2F;log&#x2F; &#x2F;rsync&#x2F;</span><br><span class="line">sending incremental file list</span><br><span class="line">boot.log</span><br><span class="line">......</span><br><span class="line">tuned&#x2F;tuned.log</span><br><span class="line"></span><br><span class="line">sent 465,270 bytes  received 759 bytes  932,058.00 bytes&#x2F;sec</span><br><span class="line">total size is 4,754,906  speedup is 10.20</span><br></pre></td></tr></table></figure>
<h2 id="6、使用rsync-a选项"><a href="#6、使用rsync-a选项" class="headerlink" title="6、使用rsync  -a选项"></a>6、使用rsync  -a选项</h2><p>rsync命令的<code>-a</code>选项表示存档模式。<code>-a</code>选项递归同步，保留符号链接，保留权限，保留，保留所有者和组。</p>
<p>现在，执行以下命令，然后查看文件的时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rsync -zva &#x2F;var&#x2F;log&#x2F; &#x2F;rsync&#x2F;</span><br><span class="line">sending incremental file list</span><br><span class="line">.&#x2F;</span><br><span class="line">boot.log</span><br><span class="line">......</span><br><span class="line">tuned&#x2F;tuned.log</span><br><span class="line"></span><br><span class="line">sent 465,714 bytes  received 762 bytes  932,952.00 bytes&#x2F;sec</span><br><span class="line">total size is 4,759,531  speedup is 10.20</span><br></pre></td></tr></table></figure>
<p>如下图所示，在同步期间保留了补充</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210429153216.png" alt="image-20210429152235649"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210429153151.png" alt="image-20210429152252882"></p>
<h2 id="7、将文件从本地同步到远程目录"><a href="#7、将文件从本地同步到远程目录" class="headerlink" title="7、将文件从本地同步到远程目录"></a>7、将文件从本地同步到远程目录</h2><p>rsync允许在本地和远程系统之间的同步文件/目录，应该是本地和远程系统都要安装rsync才行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rsync -zva &#x2F;var&#x2F;log&#x2F; root@192.168.10.200:&#x2F;rsync</span><br><span class="line">The authenticity of host &#39;192.168.10.200 (192.168.10.200)&#39; can&#39;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:CQ+Ueun&#x2F;hBJkSNzWjqdNDLc3bFsfS8RwWTYeX3aD3Ak.</span><br><span class="line">ECDSA key fingerprint is MD5:4d:fd:8a:6f:99:16:33:39:fb:c9:7c:1b:16:61:ea:07.</span><br><span class="line">Are you sure you want to continue connecting (yes&#x2F;no)? yes</span><br><span class="line">Warning: Permanently added &#39;192.168.10.200&#39; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.10.200&#39;s password:</span><br><span class="line">sending incremental file list</span><br><span class="line">created directory &#x2F;rsync</span><br><span class="line">.&#x2F;</span><br><span class="line">boot.log</span><br><span class="line">......</span><br><span class="line">tuned&#x2F;tuned.log</span><br><span class="line"></span><br><span class="line">sent 465,718 bytes  received 791 bytes  71,770.62 bytes&#x2F;sec</span><br><span class="line">total size is 4,759,531  speedup is 10.20</span><br></pre></td></tr></table></figure>
<h2 id="8、将文件从远程目录同步到本地"><a href="#8、将文件从远程目录同步到本地" class="headerlink" title="8、将文件从远程目录同步到本地"></a>8、将文件从远程目录同步到本地</h2><p>将目标文件从远程系统同步到本地时，在源中指定远程路径，在目标中指定本地路径即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rsync -avz root@192.168.10.200:&#x2F;rsync&#x2F; &#x2F;test1&#x2F;</span><br><span class="line">root@192.168.10.200&#39;s password:</span><br><span class="line">receiving incremental file list</span><br><span class="line">.&#x2F;</span><br><span class="line">boot.log</span><br><span class="line">......</span><br><span class="line">tuned&#x2F;tuned.log</span><br><span class="line"></span><br><span class="line">sent 770 bytes  received 465,673 bytes  103,654.00 bytes&#x2F;sec</span><br><span class="line">total size is 4,759,531  speedup is 10.20</span><br></pre></td></tr></table></figure>
<h2 id="9、不传输大文件"><a href="#9、不传输大文件" class="headerlink" title="9、不传输大文件"></a>9、不传输大文件</h2><p>可以使用<code>rsync --max-size</code>选项告诉rsync不要传输大于指定大小的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# rsync -zva --max-size&#x3D;&#39;1M&#39; &#x2F;var&#x2F;log&#x2F; root@192.168.10.200:&#x2F;rsync1</span><br><span class="line">root@192.168.10.200&#39;s password:</span><br><span class="line">sending incremental file list</span><br><span class="line">created directory &#x2F;rsync1</span><br><span class="line">.&#x2F;</span><br><span class="line">boot.log</span><br><span class="line">......</span><br><span class="line">tuned&#x2F;tuned.log</span><br><span class="line"></span><br><span class="line">sent 279,991 bytes  received 773 bytes  112,305.60 bytes&#x2F;sec</span><br><span class="line">total size is 4,773,150  speedup is 17.00</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/20210429154823.png" alt="image-20210429154749416"></p>
<p><code>--max-size=1M</code>使rsync仅传输小于或等于1M的文件。单位可以是K，M，G等。</p>
<p>还可以使用<code>--min-size=</code>参数，指定传输最小文件的大小。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/10/Shell%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/10/Shell%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">Shell脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-10 15:22:27" itemprop="dateCreated datePublished" datetime="2021-05-10T15:22:27+08:00">2021-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/05/10/Shell%E8%84%9A%E6%9C%AC/" class="post-meta-item leancloud_visitors" data-flag-title="Shell脚本" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、Shell变量介绍"><a href="#1、Shell变量介绍" class="headerlink" title="1、Shell变量介绍"></a>1、Shell变量介绍</h2><p>​        Linux中的变量分为系统变量和自定义变量</p>
<h2 id="2、Shell变量的定义"><a href="#2、Shell变量的定义" class="headerlink" title="2、Shell变量的定义"></a>2、Shell变量的定义</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><ol>
<li>定义变量：变量=值</li>
<li>撤销变量：unset 变量</li>
<li>声明静态变量：readonly变量（不能unset）<code>readonly   city=beijing</code></li>
</ol>
<h3 id="定义变量的规则"><a href="#定义变量的规则" class="headerlink" title="定义变量的规则"></a>定义变量的规则</h3><ol>
<li>变量名称可以由字母、数字和下划线组成，但不能使用数字开头</li>
<li>变量两侧不能有空格</li>
<li>变量名称一般习惯为大写</li>
</ol>
<h3 id="将命令的返回值赋给变量"><a href="#将命令的返回值赋给变量" class="headerlink" title="将命令的返回值赋给变量"></a>将命令的返回值赋给变量</h3><ul>
<li>A=<code>date</code> 两个反引号`将命令引起来，并将结果返回给变量A</li>
<li>A=$(date) 等价于反引号</li>
</ul>
<h2 id="3、设置环境变量"><a href="#3、设置环境变量" class="headerlink" title="3、设置环境变量"></a>3、设置环境变量</h2><h3 id="基本语法-1"><a href="#基本语法-1" class="headerlink" title="基本语法"></a>基本语法</h3><ul>
<li>export 变量名=变量值</li>
<li>source  配置文件</li>
<li>echo $变量名</li>
</ul>
<h2 id="4、位置参数变量"><a href="#4、位置参数变量" class="headerlink" title="4、位置参数变量"></a>4、位置参数变量</h2><h3 id="基本语法-2"><a href="#基本语法-2" class="headerlink" title="基本语法"></a>基本语法</h3><ul>
<li>$n     功能描述：n为数字，$0表示命令本身，$1–$9代表第一个到第九个参数，十以上的参数需要用大括号包含（${10}）</li>
<li>$*     功能描述：代表命令行中所有的参数，把所有的参数看做一个整体</li>
<li>$@    功能描述：代表命令行中所有的参数，不过把每个参数区分对待</li>
<li>$#     功能描述：代表命令行中所有参数的个数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">echo &quot;0&#x3D;$0 1&#x3D;$1 2&#x3D;$2&quot;</span><br><span class="line">echo &quot;所有的参数为$*&quot;</span><br><span class="line">echo &quot;所有的参数为$@&quot;</span><br><span class="line">echo &quot;所有的参数为$#&quot;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh 12 34</span><br><span class="line">0&#x3D;myshell.sh 1&#x3D;12 2&#x3D;34</span><br><span class="line">所有的参数为12 34</span><br><span class="line">所有的参数为12 34</span><br><span class="line">所有的参数为2</span><br></pre></td></tr></table></figure>
<h2 id="5、预定义变量"><a href="#5、预定义变量" class="headerlink" title="5、预定义变量"></a>5、预定义变量</h2><p>基本介绍</p>
<p>​        就是shell设计者事先已经定义好的变量，可以直接在shell脚本使用</p>
<p>基本语法</p>
<ul>
<li>$$     功能描述：当前进程的进程号（PID）</li>
<li>$!      功能描述：后台运行的最后一个进程的进程号（PID）</li>
<li>$?      功能描述：最后一次执行命令的返回状态，如果这个变量的值为0，证明上一个命令正确执行；如果这个变量的值为非0(具体是哪个数，由命令自己决定)，则证明上一个命令执行不正确。</li>
</ul>
<h2 id="6、运算符"><a href="#6、运算符" class="headerlink" title="6、运算符"></a>6、运算符</h2><h3 id="基本语法-3"><a href="#基本语法-3" class="headerlink" title="基本语法"></a>基本语法</h3><ol>
<li>“$((运算式))”或$[运算式]或者expr  m + n</li>
<li>注意expr运算符间要有空格</li>
<li>expr  *，/，%    乘，除，取余</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">RES1&#x3D;$((2+3))</span><br><span class="line">echo &quot;$RES1&quot;</span><br><span class="line"></span><br><span class="line">RES2&#x3D;$[(2+3)*4]</span><br><span class="line">echo &quot;$RES2&quot;</span><br><span class="line"></span><br><span class="line">RES3&#x3D;&#96;expr 2 + 3&#96;</span><br><span class="line">RES4&#x3D;&#96;expr $RES3 \* 4&#96;</span><br><span class="line">echo &quot;$RES3  $RES4&quot;</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh</span><br><span class="line">5</span><br><span class="line">20</span><br><span class="line">5  20</span><br></pre></td></tr></table></figure>
<h2 id="7、条件判断"><a href="#7、条件判断" class="headerlink" title="7、条件判断"></a>7、条件判断</h2><h3 id="1、条件判断语法结构"><a href="#1、条件判断语法结构" class="headerlink" title="1、条件判断语法结构"></a>1、条件判断语法结构</h3><pre><code>    1. test 条件表达式
    2. [ 条件表达式 ]
    3. [[[ 条件表达式 ]] 支持正则 =~条件判断相关参数</code></pre>
<h3 id="2、条件判断相关参数"><a href="#2、条件判断相关参数" class="headerlink" title="2、条件判断相关参数"></a>2、条件判断相关参数</h3><h4 id="2-1-判断文件类型"><a href="#2-1-判断文件类型" class="headerlink" title="2.1 判断文件类型"></a>2.1 判断文件类型</h4><table>
<thead>
<tr>
<th>判断参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-e</td>
<td>判断文件是否存在(任意文件类型）</td>
</tr>
<tr>
<td>-f</td>
<td>判断文件是否存在，并且是一个普通文件</td>
</tr>
<tr>
<td>-d</td>
<td>判断文件是否存在，并且是一个目录</td>
</tr>
<tr>
<td>-L</td>
<td>判断文件是否存在并且是一个软连接文件</td>
</tr>
<tr>
<td>-b</td>
<td>判断文件是否存在并且是一块设备文件</td>
</tr>
<tr>
<td>-c</td>
<td>判断文件是否存在是一个字符设备文件</td>
</tr>
<tr>
<td>-S</td>
<td>判断文件是否存在并且是一个套接字文件</td>
</tr>
<tr>
<td>-p</td>
<td>判断文件是否存在并且是一个命名管道文件</td>
</tr>
<tr>
<td>-s</td>
<td>判断文件是否存在并且是否非空文件</td>
</tr>
</tbody></table>
<h4 id="2-2-判断文件权限"><a href="#2-2-判断文件权限" class="headerlink" title="2.2 判断文件权限"></a>2.2 判断文件权限</h4><table>
<thead>
<tr>
<th>判断参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-r</td>
<td>当前用户对其是否可读</td>
</tr>
<tr>
<td>-w</td>
<td>当前用户对其是否可写</td>
</tr>
<tr>
<td>-x</td>
<td>当前用户对其是否可执行</td>
</tr>
<tr>
<td>-u</td>
<td>是否有suid，高级权限冒险家位</td>
</tr>
<tr>
<td>-g</td>
<td>是否sgid，高级权限限制位</td>
</tr>
<tr>
<td>-k</td>
<td>是否有t位，高级权限粘滞位</td>
</tr>
</tbody></table>
<h4 id="2-3-判断文件新旧"><a href="#2-3-判断文件新旧" class="headerlink" title="2.3 判断文件新旧"></a>2.3 判断文件新旧</h4><table>
<thead>
<tr>
<th>判断参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>file1 -nt file2</td>
<td>比较file1是否比file2新</td>
</tr>
<tr>
<td>file1 -ot file2</td>
<td>比较file1 是否比file2旧</td>
</tr>
<tr>
<td>file1 -ef file2</td>
<td>比较是否为同一个文件，或者判断硬连接，是否指向同一个inode</td>
</tr>
</tbody></table>
<h4 id="2-4-判断整数"><a href="#2-4-判断整数" class="headerlink" title="2.4 判断整数"></a>2.4 判断整数</h4><table>
<thead>
<tr>
<th>判断参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-eq</td>
<td>相等</td>
</tr>
<tr>
<td>-ne</td>
<td>不等</td>
</tr>
<tr>
<td>-gt</td>
<td>大于</td>
</tr>
<tr>
<td>-lt</td>
<td>小于</td>
</tr>
<tr>
<td>-ge</td>
<td>大于等于</td>
</tr>
<tr>
<td>-le</td>
<td>小于等于</td>
</tr>
</tbody></table>
<h4 id="2-5-判断字符串"><a href="#2-5-判断字符串" class="headerlink" title="2.5 判断字符串"></a>2.5 判断字符串</h4><table>
<thead>
<tr>
<th>判断参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-z</td>
<td>判断是否为空字符串，字符串长度为0则成立</td>
</tr>
<tr>
<td>-n</td>
<td>判断是否为空字符串，字符串长度不为0则成立</td>
</tr>
<tr>
<td>string1 = string2</td>
<td>判断字符串是否相等</td>
</tr>
<tr>
<td>string1 ！= string2</td>
<td>判断字符串是否不相等</td>
</tr>
</tbody></table>
<h4 id="2-6-多重条件判断"><a href="#2-6-多重条件判断" class="headerlink" title="2.6 多重条件判断"></a>2.6 多重条件判断</h4><table>
<thead>
<tr>
<th>判断符号</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-a 和 &amp;&amp;</td>
<td>逻辑与</td>
</tr>
<tr>
<td>-o 和 ||</td>
<td>逻辑或</td>
</tr>
</tbody></table>
<p> 特别说明：</p>
<ul>
<li>  &amp;&amp;   前面表达式为真，才会执行后面代码</li>
<li>  ||   前面表达式为假，才会执行后面代码</li>
<li>  ；  用于分割命令或表达式</li>
</ul>
<h2 id="8、流程控制"><a href="#8、流程控制" class="headerlink" title="8、流程控制"></a>8、流程控制</h2><h3 id="8-1-case语句"><a href="#8-1-case语句" class="headerlink" title="8.1 case语句"></a>8.1 case语句</h3><h4 id="基本语法-4"><a href="#基本语法-4" class="headerlink" title="基本语法"></a>基本语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case $变量名 in</span><br><span class="line">&quot;值1&quot;)</span><br><span class="line">如果变量的值等于值1，则执行程序1</span><br><span class="line">;;</span><br><span class="line">&quot;值2&quot;)</span><br><span class="line">如果变量的值等于值2，则执行程序2</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">如果变量的值都不是以上的值，则执行此程序</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">case $1 in</span><br><span class="line">&quot;1&quot;)</span><br><span class="line">echo &quot;周一&quot;</span><br><span class="line">;;</span><br><span class="line">&quot;2&quot;)</span><br><span class="line">echo &quot;周二&quot;</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">echo &quot;我也不知道周几了&quot;</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh 3</span><br><span class="line">我也不知道周几了</span><br><span class="line">[root@node1 shell]# bash myshell.sh 2</span><br><span class="line">周二</span><br></pre></td></tr></table></figure>
<h3 id="8-2-for循环"><a href="#8-2-for循环" class="headerlink" title="8.2 for循环"></a>8.2 for循环</h3><h4 id="语法一"><a href="#语法一" class="headerlink" title="语法一"></a>语法一</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for  变量  in  值1  值2  值3</span><br><span class="line">do</span><br><span class="line">程序代码</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">for i in &quot;$*&quot;</span><br><span class="line">do</span><br><span class="line">	echo &quot;num is $i&quot;</span><br><span class="line">done</span><br><span class="line">	echo &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;</span><br><span class="line">for j in &quot;$@&quot;</span><br><span class="line">do</span><br><span class="line">	echo &quot;num is $j&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh 1 22 44</span><br><span class="line">num is 1 22 44</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">num is 1</span><br><span class="line">num is 22</span><br><span class="line">num is 44</span><br></pre></td></tr></table></figure>
<h4 id="语法二"><a href="#语法二" class="headerlink" title="语法二"></a>语法二</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for ((初始值；循环控制条件；变量变化))</span><br><span class="line">do</span><br><span class="line">程序代码</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">SUM&#x3D;0</span><br><span class="line">for (( i&#x3D;1;i&lt;&#x3D;$1;i++ ))   #两侧括号有空格do        </span><br><span class="line">	SUM&#x3D;$[$SUM+$i]</span><br><span class="line">done</span><br><span class="line">echo &quot;SUM&#x3D;$SUM&quot;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh 100</span><br><span class="line">SUM&#x3D;5050</span><br></pre></td></tr></table></figure>
<h3 id="8-3-while循环"><a href="#8-3-while循环" class="headerlink" title="8.3 while循环"></a>8.3 while循环</h3><h4 id="基本语法-5"><a href="#基本语法-5" class="headerlink" title="基本语法"></a>基本语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while [ 条件判断式 ]   #注意空格</span><br><span class="line">do</span><br><span class="line">程序代码</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">SUM&#x3D;0</span><br><span class="line">i&#x3D;0</span><br><span class="line">while [ $i -le $1 ]</span><br><span class="line">do        </span><br><span class="line">i&#x3D;$[$i+1]        </span><br><span class="line">SUM&#x3D;$[$SUM+$i]</span><br><span class="line">done</span><br><span class="line">echo &quot;结果SUM&#x3D;$SUM&quot;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh 100</span><br><span class="line">结果SUM&#x3D;5151</span><br></pre></td></tr></table></figure>
<h3 id="8-4-read读取控制台输入"><a href="#8-4-read读取控制台输入" class="headerlink" title="8.4 read读取控制台输入"></a>8.4 read读取控制台输入</h3><h4 id="基本语法-6"><a href="#基本语法-6" class="headerlink" title="基本语法"></a>基本语法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">read (选项) (参数)选项：</span><br><span class="line">-a：将分裂后的字段依次存储到指定的数组中，存储的起始位置从数组的index&#x3D;0开始。</span><br><span class="line">-d：指定读取行的结束符号。默认结束符号为换行符。</span><br><span class="line">-n：限制读取N个字符就自动结束读取，如果没有读满N个字符就按下回车或遇到换行符，则也会结束读取。</span><br><span class="line">-N：严格要求读满N个字符才自动结束读取，即使中途按下了回车或遇到了换行符也不结束。其中换行符或回车算一个字符。</span><br><span class="line">-p：给出提示符。默认不支持&quot;\n&quot;换行，要换行需要特殊处理，通过$&#39;string&#39;的方式特殊处理，就可以实现换行的功能</span><br><span class="line">-r：禁止反斜线的转义功能。这意味着&quot;\&quot;会变成文本的一部分。</span><br><span class="line">-s：静默模式。输入的内容不会回显在屏幕上。</span><br><span class="line">-t：给出超时时间，在达到超时时间时，read退出并返回错误。也就是说不会读取任何内容，即使已经输入了一部分。</span><br><span class="line">-u：从给定文件描述符(fd&#x3D;N)中读取数据</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">read -s -p $&#39;请输入密码：\n&#39; PASSWORD   #使用了换行</span><br><span class="line">echo &quot;密码为$PASSWORD&quot;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 shell]# bash myshell.sh</span><br><span class="line">请输入密码：</span><br><span class="line">密码为12345</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/23/K8s%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/23/K8s%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">K8s配置域名解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-23 14:17:03" itemprop="dateCreated datePublished" datetime="2021-04-23T14:17:03+08:00">2021-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>

  
    <span id="/2021/04/23/K8s%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="K8s配置域名解析" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>有的时候pod里面调域名，需要写到 /etc/hosts 里面进行域名解析，但很不幸，/etc/hosts 被 k8s 征用了，无法修改。</p>
<p>但 k8s 给我们提供了 hostAliases 来解决此问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      hostAliases:</span><br><span class="line">      - ip: &quot;192.168.0.11&quot;</span><br><span class="line">        hostnames:</span><br><span class="line">        - &quot;www.yangpiqiulaotou.cn&quot;</span><br><span class="line">        - &quot;yangpiqiulaotou.cn&quot;</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:alpine</span><br><span class="line">        name: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          protocol: TCP</span><br></pre></td></tr></table></figure>
<p>进入pod查看hosts已经生效！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">羊皮裘老头</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
<!--
-->

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":null,"app_key":null,"server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<!-- calendar widget -->
{% if theme.CloudCalendar.enable %}
    <script src="{{ theme.CloudCalendar.calendarCdn }}"></script>
    <script src="{{ theme.CloudCalendar.langCdn }}"></script>
    <script>
    $(function() {
        $('#CloudCalendar').aCalendar('{{ theme.CloudCalendar.language }}',
            $.extend(
                '', {
                    single:{{ theme.CloudCalendar.single }},
                    root:'{{ theme.CloudCalendar.root }}'
                }
            )
        );
    });
    </script>
{% endif %}

</body>
</html>
