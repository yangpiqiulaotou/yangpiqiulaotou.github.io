<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-55HKMllCks">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic%7CAmita:300,300italic,400,400italic,700,700italic%7CMontserrat:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="羊皮裘老头">
<meta property="og:url" content="http://example.com/page/8/index.html">
<meta property="og:site_name" content="羊皮裘老头">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="羊皮裘老头">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>羊皮裘老头</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">羊皮裘老头</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">28</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">116</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">羊皮裘老头</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


<!-- CloudCalendar -->
<div class="widget-wrap" style="width: 90%;margin-left: auto;margin-right: auto; opacity: 0.97;">
	<div class="widget" id="CloudCalendar"></div>
</div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/%E5%AE%89%E8%A3%85MetalLB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/%E5%AE%89%E8%A3%85MetalLB/" class="post-title-link" itemprop="url">安装MetalLB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:09:27" itemprop="dateCreated datePublished" datetime="2021-03-22T15:09:27+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/%E5%AE%89%E8%A3%85MetalLB/" class="post-meta-item leancloud_visitors" data-flag-title="安装MetalLB" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、准备"><a href="#1、准备" class="headerlink" title="1、准备"></a>1、准备</h2><p>如果您在IPVS模式下使用kube-proxy，则从Kubernetes v1.14.2开始，必须启用严格的ARP模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请注意，如果您将kube-router用作服务代理，则不需要此设置，因为默认情况下它会启用严格的arp。</span><br></pre></td></tr></table></figure>
<p>可以通过在当前集群中编辑kube-proxy配置来实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap -n kube-system kube-proxy</span><br><span class="line"></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io&#x2F;v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">ipvs:</span><br><span class="line">  strictARP: true</span><br></pre></td></tr></table></figure>
<p>也可以使用shell命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br><span class="line">sed -e &quot;s&#x2F;strictARP: false&#x2F;strictARP: true&#x2F;&quot; | \</span><br><span class="line">kubectl diff -f - -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br><span class="line">sed -e &quot;s&#x2F;strictARP: false&#x2F;strictARP: true&#x2F;&quot; | \</span><br><span class="line">kubectl apply -f - -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;metallb&#x2F;metallb&#x2F;v0.9.3&#x2F;manifests&#x2F;namespace.yaml</span><br><span class="line">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;metallb&#x2F;metallb&#x2F;v0.9.3&#x2F;manifests&#x2F;metallb.yaml</span><br><span class="line">kubectl create secret generic -n metallb-system memberlist --from-literal&#x3D;secretkey&#x3D;&quot;$(openssl rand -base64 128)&quot;</span><br></pre></td></tr></table></figure>
<p>这会将MetalLB部署到<code>metallb-system</code> 名称空间下的群集中。清单中的组件是：</p>
<ul>
<li>该<code>metallb-system/controller</code>部署。这是处理IP地址分配的群集范围的控制器。</li>
<li>该<code>metallb-system/speaker</code>daemonset。这是表明您选择的协议以使服务可访问的组件。</li>
<li>控制器和扬声器的服务帐户，以及组件需要运行的RBAC权限。</li>
</ul>
<p>安装清单不包括配置文件。MetalLB的组件仍将启动，但将保持空闲状态，直到您 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/">定义并部署配置图</a>。<code>memberlist</code>机密包含<code>secretkey</code>用于加密扬声器之间的通信以进行快速死点检测的密钥。</p>
<h2 id="3、支持的网络插件"><a href="#3、支持的网络插件" class="headerlink" title="3、支持的网络插件"></a>3、支持的网络插件</h2><table>
<thead>
<tr>
<th>兼容</th>
<th>网络插件</th>
</tr>
</thead>
<tbody><tr>
<td>calico</td>
<td>已知问题，使用BGP模式，IPIP模式不影响</td>
</tr>
<tr>
<td>canal</td>
<td>支持</td>
</tr>
<tr>
<td>Flannel</td>
<td>支持</td>
</tr>
</tbody></table>
<h2 id="4、二层配置IP地址池"><a href="#4、二层配置IP地址池" class="headerlink" title="4、二层配置IP地址池"></a>4、二层配置IP地址池</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb-system</span><br><span class="line">  name: config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: hello         #svc中需要使用name</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.10.200-192.168.10.210         #这里的IP地址池范围需要跟集群实际情况相对应</span><br></pre></td></tr></table></figure>
<h2 id="5、完整实例"><a href="#5、完整实例" class="headerlink" title="5、完整实例"></a>5、完整实例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.14-alpine</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx</span><br><span class="line">  annotations:</span><br><span class="line">    metallb.universe.tf&#x2F;address-pool: hello          #和configmap中的name对应</span><br><span class="line">spec:</span><br><span class="line">  clusterIP:</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200714145400861.png" alt="image-20200714145400861"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200714145416862.png" alt="image-20200714145416862"></p>
<p>文章参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yevvzi/article/details/102967936">https://blog.csdn.net/yevvzi/article/details/102967936</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/MetalLB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/MetalLB/" class="post-title-link" itemprop="url">MetalLB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:07:59" itemprop="dateCreated datePublished" datetime="2021-03-22T15:07:59+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/MetalLB/" class="post-meta-item leancloud_visitors" data-flag-title="MetalLB" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h2><p>​        MetalLB挂接到您的Kubernetes集群中，并提供了网络负载平衡器实现。简而言之，它允许您在未在云提供商上运行的集群中创建类型为“ LoadBalancer”的Kubernetes服务。</p>
<p>​        它具有两个可以共同提供此服务的功能：地址分配和外部通知</p>
<h3 id="1-1-地址分配"><a href="#1-1-地址分配" class="headerlink" title="1.1 地址分配"></a>1.1 地址分配</h3><p>​        在启用了云的Kubernetes集群中，您需要一个负载均衡器，然后您的云平台会为您分配一个IP地址。在裸机集群中，MetalLB负责该分配。</p>
<p>​        MetalLB无法凭空创建IP地址，因此您必须为它提供可以使用的IP地址<em>池</em>。MetalLB将随着服务的来来去往分配和取消分配单个地址，但它只会分发作为其已配置池一部分的IP。</p>
<h3 id="1-2-外部通知"><a href="#1-2-外部通知" class="headerlink" title="1.2  外部通知"></a>1.2  外部通知</h3><p>​        一旦MetalLB为服务分配了外部IP地址，它就需要使群集之外的网络意识到IP在群集中“存在”。MetalLB使用标准路由协议来实现此目的：ARP，NDP或BGP。</p>
<h4 id="第2层模式（ARP-NDP）"><a href="#第2层模式（ARP-NDP）" class="headerlink" title="第2层模式（ARP / NDP）"></a>第2层模式（ARP / NDP）</h4><p>​        在第2层模式下，群集中的一台机器获得服务的所有权，并使用标准地址发现协议（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Address_Resolution_Protocol">ARP协议</a> 对于IPv4）以使这些IP在本地网络上可以访问。从LAN的角度来看，通告机仅具有多个IP地址。</p>
<p><a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/layer2/">https://metallb.universe.tf/concepts/layer2/</a></p>
<h4 id="BGP协议"><a href="#BGP协议" class="headerlink" title="BGP协议"></a>BGP协议</h4><p>​        在BGP模式下，群集中的所有计算机都将建立 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">BGP协议</a> 与您控制的附近路由器的对等会话，并告诉这些路由器如何将流量转发到服务IP。借助BGP的策略机制，使用BGP可以在多个节点之间实现真正的负载平衡，并实现细粒度的流量控制。</p>
<p><a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/bgp/">https://metallb.universe.tf/concepts/bgp/</a></p>
<h2 id="2、第2层模式下的METALLB"><a href="#2、第2层模式下的METALLB" class="headerlink" title="2、第2层模式下的METALLB"></a>2、第2层模式下的METALLB</h2><p>第2层模式的主要优点是它的通用性：它可以在任何以太网网络上运行，不需要特殊的硬件，甚至不需要花哨的路由器。</p>
<h3 id="负载均衡行为"><a href="#负载均衡行为" class="headerlink" title="负载均衡行为"></a>负载均衡行为</h3><p>​        在第2层模式下，服务IP的所有流量都流向一个节点。从那里， <code>kube-proxy</code>将流量分散到所有服务的Pod。</p>
<p>​        从这个意义上讲，第2层没有实现负载平衡器。相反，它实现了故障转移机制，以便当当前引导节点由于某种原因发生故障时，其他节点可以接管。</p>
<p>​        如果领导节点由于某种原因失败，则故障转移是自动的：使用以下命令检测到失败的节点 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/memberlist">用户列表</a>，此时新节点将接管发生故障的节点的IP地址所有权。</p>
<h3 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h3><p>​        第2层模式有两个主要限制：单节点瓶颈和潜在的故障转移速度很慢。</p>
<p>​        如上所述，在第2层模式下，单个领导者当选节点接收服务IP的所有流量。这意味着服务的入口带宽被限制为单个节点的带宽。这是使用ARP和NDP引导流量的基本限制。</p>
<p>​        在当前的实现中，节点之间的故障转移取决于客户端的合作。当发生故障转移时，MetalLB发送大量免费的第2层数据包（有点用词不正确-它实际上应称为“未经请求的第2层数据包”），以通知客户端与服务IP关联的MAC地址已更改。</p>
<p>​        大多数操作系统正确处理“免费”数据包，并迅速更新其邻居缓存。在这种情况下，故障转移将在几秒钟内发生。但是，某些系统要么根本不执行免费处理，要么具有错误的实现，从而延迟了缓存更新。</p>
<p>​        所有主要版本的现代操作系统（Windows，Mac，Linux）都可以正确实现第2层故障转移，因此唯一可能出现问题的情况是较旧的或较不常见的操作系统。</p>
<h3 id="与Keepalived的比较"><a href="#与Keepalived的比较" class="headerlink" title="与Keepalived的比较"></a>与Keepalived的比较</h3><p>​        MetalLB的layer2模式与Keepalived有很多相似之处，因此，如果您熟悉Keepalived，听起来应该很熟悉。但是，还有一些差异值得一提。</p>
<p>​        Keepalived使用虚拟路由器冗余协议（VRRP）。Keepalived实例会不断相互交换VRRP消息，以选择领导者并通知该领导者何时离开。</p>
<p>​        另一方面，MetalLB依靠 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/memberlist">用户列表</a> 知道何时无法再访问群集中的节点，并且应将来自该节点的服务IP移动到其他位置。</p>
<p>​        从客户端的角度来看，Keepalived和MetalLB“看起来”是相同的：发生故障转移时，服务IP地址似乎从一台计算机迁移到另一台计算机，而在其余时间中，看起来机器都具有多个IP地址。</p>
<p>​        由于MetalLB不使用VRRP，因此不受该协议的某些限制。例如，MetalLB中不存在每个网络255个负载均衡器的VRRP限制。只要您的网络中有可用的IP，您就可以拥有任意数量的负载平衡IP。与VRRP相比，MetalLB还需要更少的配置-例如，没有虚拟路由器ID</p>
<p>​        另一方面，因为MetalLB依赖 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/memberlist">用户列表</a>对于群集成员信息，它不能与支持VRRP的第三方路由器和基础架构互操作。这可以按预期工作：MetalLB专为<em>在</em> Kubernetes群集<em>内</em>提供负载平衡和故障转移而设计，在这种情况下，与第三方LB软件的互操作性超出了范围。</p>
<h2 id="3、BGP模式下的METALLB"><a href="#3、BGP模式下的METALLB" class="headerlink" title="3、BGP模式下的METALLB"></a>3、BGP模式下的METALLB</h2><p>​        在BGP模式下，群集中的每个节点都与网络路由器建立BGP对等会话，并使用该对等会话来通告外部群集服务的IP。</p>
<p>​        假设您的路由器配置为支持多路径，则可以实现真正的负载平衡：MetalLB发布的路由彼此等效，除了它们的下一跳。这意味着路由器将一起使用所有下一跳，并在它们之间进行负载平衡。</p>
<p>​        数据包到达节点后，<code>kube-proxy</code>负责流量路由的最后一跳，以将数据包到达服务中的一个特定容器。</p>
<h3 id="负载均衡行为-1"><a href="#负载均衡行为-1" class="headerlink" title="负载均衡行为"></a>负载均衡行为</h3><p>​        负载平衡的确切行为取决于特定的路由器型号和配置，但是常见的行为是基于<em>数据包哈希值</em>来平衡 <em>每个连接</em>。</p>
<p>​        每次连接意味着单个TCP或UDP会话的所有数据包都将定向到群集中的单个计算机。流量扩散仅发生<em>在</em>不同的连接<em>之间</em>，而不是一个连接中的数据包。</p>
<p>这是一个<em>很好的</em>事情，因为分散在多个群集节点的数据包会导致在几个层次上不良行为：</p>
<ul>
<li>将单个连接分布在多条路径上会导致数据包在网络上重新排序，这将严重影响最终主机的性能。</li>
<li>不保证Kubernetes中的节点上流量路由在各个节点之间是一致的。这意味着两个不同的节点可能决定将同一连接的数据包路由到不同的Pod，这将导致连接失败。</li>
</ul>
<p>数据包哈希是高性能路由器如何在多个后端之间无状态地分布连接。对于每个数据包，他们提取一些字段，并将它们用作“种子”，以确定性地选择一个可能的后端。如果所有字段都相同，则将选择相同的后端。</p>
<p>​        可用的确切哈希方法取决于路由器的硬件和软件。两个典型的选项是<em>3元组</em>和<em>5元组</em> 哈希。三元组<code>(protocol, source-ip, dest-ip)</code>用作密钥，这意味着两个唯一IP之间的所有数据包都将到达同一后端。5元组散列将源端口和目标端口添加到混合中，这允许来自同一客户端的不同连接分布在群集中。</p>
<p>​        通常，最好将尽可能多的<em>熵</em>放入数据包哈希中，这意味着使用更多字段通常是好的。这是因为熵的增加使我们更接近“理想”的负载平衡状态，在该状态下，每个节点都接收完全相同数量的数据包。由于上面列出的问题，我们永远无法达到理想状态，但是我们可以做的是尝试并尽可能均匀地分布连接，以尝试防止热点的形成。</p>
<h3 id="局限性-1"><a href="#局限性-1" class="headerlink" title="局限性"></a>局限性</h3><p>​        将BGP用作负载平衡机制的优势在于，您可以使用标准的路由器硬件，而不是定制的负载平衡器。但是，这也有缺点。</p>
<p>​        最大的问题是，基于BGP的负载平衡无法对地址<em>后端集的</em>更改做出适当的响应。这意味着，当群集节点发生故障时，您应该希望断开与服务的<em>所有</em>活动连接（用户将看到“对等方重置连接”）。</p>
<p>​        基于BGP的路由器实现无状态负载平衡。他们通过散列数据包头中的某些字段，并将该散列用作可用后端数组的索引，将给定的数据包分配给特定的下一跳。</p>
<p>​        问题在于，路由器中使用的哈希通常 <em>不稳定</em>，因此，只要后端集的大小发生变化（例如，当节点的BGP会话断开时），现有连接就会被随机有效地重新哈希，这意味着大多数现有连接连接最终将突然转发到另一后端，而该后端不知道所讨论的连接。</p>
<p>​        这样做的结果是，每当服务的IP→节点映射发生更改时，您都应该会看到一次一次性命中，其中最活跃的服务连接中断。没有持续的数据包丢失或黑洞，只有一次干净的休息时间。</p>
<p>根据您的服务工作，可以采用几种缓解策略：</p>
<ul>
<li>您的BGP路由器可以选择使用更稳定的ECMP哈希算法。有时称为“弹性ECMP”或“弹性LAG”。当后端集更改时，使用这种算法可以大大减少受影响的连接数。</li>
<li>将您的服务部署固定到特定的节点，以最大程度地减少必须“小心”的节点池。</li>
<li>当大多数用户处于睡眠状态并且流量较低时，可以在“低谷”期间安排对服务部署的更改。</li>
<li>将每个逻辑服务划分为两个具有不同IP的Kubernetes服务，并使用DNS在中断“排水”服务之前将用户流量从一个迁移到另一个。</li>
<li>在客户端添加透明的重试逻辑，以从突然的断开中正常恢复。如果您的客户是诸如移动应用程序或丰富的单页Web应用程序之类的东西，则此方法特别有用。</li>
<li>将您的服务放在入口控制器后面。入口控制器本身可以使用MetalLB接收流量，但是BGP与服务之间具有状态层意味着您可以更改服务而无需担心。您只需要在更改入口控制器本身的部署时小心即可（例如，在添加更多nginx pod进行扩展时）。</li>
<li>接受偶尔会有突发的重置连接。对于低可用性内部服务，这可能是可接受的。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Docker-%E6%9C%80%E5%AE%9E%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Docker-%E6%9C%80%E5%AE%9E%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C/" class="post-title-link" itemprop="url">Docker 最实用命令行</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:06:25" itemprop="dateCreated datePublished" datetime="2021-03-22T15:06:25+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/Docker-%E6%9C%80%E5%AE%9E%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C/" class="post-meta-item leancloud_visitors" data-flag-title="Docker 最实用命令行" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="管理命令"><a href="#管理命令" class="headerlink" title="管理命令"></a>管理命令</h2><p>为了整理CLI，Docker 1.13引进了新的管理命令，如下：</p>
<ul>
<li>system</li>
<li>container</li>
<li>image</li>
</ul>
<p>Docker的老版本中已经有了 network, node, service, swarm 和 volume 。这些新命令组子命令过去作为root命令直接实现。</p>
<h2 id="Docker系统"><a href="#Docker系统" class="headerlink" title="Docker系统"></a>Docker系统</h2><p>​        现在有一个新管理命令 system 。它有4个子命令分别是 df, events, info 和 prune  。命令 docker system df  提供Docker整体磁盘使用率的概况，包括镜像、容器和（本地）volume。所以我们现在随时都可以查看Docker使用了多少资源。</p>
<p>​        如果之前的命令展示出 docker 已经占用了太多空间，我们会开始清理。有一个包办一切的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune</span><br></pre></td></tr></table></figure>
<p>​        这个命令会删除当前没有被使用的一切项目，它按照一种正确的序列进行清理，所以会达到最大化的输出结果。首先删除没有被使用的容器，然后是volume和网络，最后是挂起的镜像。通过使用 y 回复来确认操作。如果想在脚本中使用这个命令，可以使用参数 –force 或者 -f 告诉Docker不要发来确认请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker system prune后可以加额外的参数，如：</span><br><span class="line">docker system prune -a ： 一并清除所有未被使用的镜像和没有tag镜像。</span><br><span class="line">docker system prune -f ： 用以强制删除，不提示信息。</span><br></pre></td></tr></table></figure>
<h2 id="Docker容器"><a href="#Docker容器" class="headerlink" title="Docker容器"></a>Docker容器</h2><p>​        我们已经知道许多 docker container 的子命令。它们过去（现在也是）是 docker 的直接子命令。可以通过下面的命令得到完整的子命令列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container prune</span><br></pre></td></tr></table></figure>
<p>​        在列表中会看到一个 prune 命令。如果使用它，那么只会删除无用的容器。因此这条命令比 docker system prune 命令更局限。使用 –force 或者 -f 同意可以让CLI不再进行确认请求。</p>
<h2 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h2><p>这里也有一个 prune 命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network prune</span><br></pre></td></tr></table></figure>
<p>删除所有没有使用的网络。</p>
<h2 id="Docker-Volume"><a href="#Docker-Volume" class="headerlink" title="Docker Volume"></a>Docker Volume</h2><p>volume也有新的 prune 命令了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume prune</span><br></pre></td></tr></table></figure>
<p>删除所有（本地）没有被容器使用的volume。</p>
<h2 id="Docker镜像"><a href="#Docker镜像" class="headerlink" title="Docker镜像"></a>Docker镜像</h2><p>新的镜像命令也是 prune 子命令。–force 用法如上面一样， –all 可以删除所有不用的镜像，不只挂起的镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image prune --force --all</span><br></pre></td></tr></table></figure>
<p>这个命令可以删除所有不使用的镜像并且不再请求确认。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/prometheus%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/prometheus%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89/" class="post-title-link" itemprop="url">prometheus对接钉钉</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:04:55" itemprop="dateCreated datePublished" datetime="2021-03-22T15:04:55+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/prometheus%E5%AF%B9%E6%8E%A5%E9%92%89%E9%92%89/" class="post-meta-item leancloud_visitors" data-flag-title="prometheus对接钉钉" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dingtalk</span><br><span class="line">  namespace: prometheus</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: dingtalk</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: dingtalk</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: timonwong&#x2F;prometheus-webhook-dingtalk:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">          - --ding.profile&#x3D;webhook1&#x3D;https:&#x2F;&#x2F;oapi.dingtalk.com&#x2F;robot&#x2F;send?access_token&#x3D;xxxxxxxxx        #自己钉钉token的地址</span><br><span class="line">        name: dingtalk</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8060</span><br><span class="line">          name: http</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities: &#123;&#125;</span><br><span class="line">        terminationMessagePath: &#x2F;dev&#x2F;termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: dingtalk</span><br><span class="line">  namespace: prometheus</span><br><span class="line">spec:</span><br><span class="line">  clusterIP:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 8060</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8060</span><br><span class="line">  selector:</span><br><span class="line">    app: dingtalk</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;timonwong&#x2F;prometheus-webhook-dingtalk</span><br></pre></td></tr></table></figure>
<p>测试token是否能连通：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl &#39;https:&#x2F;&#x2F;oapi.dingtalk.com&#x2F;robot&#x2F;send?access_token&#x3D;xxxxxxxxx&#39; \</span><br><span class="line">   -H &#39;Content-Type: application&#x2F;json&#39; \</span><br><span class="line">   -d &#39;&#123;&quot;msgtype&quot;: &quot;text&quot;,&quot;text&quot;: &#123;&quot;content&quot;: &quot;我就是我, 是不一样的烟火&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>能在钉钉群看到一下就说明成功了</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608160534812.png" alt="image-20200608160534812"></p>
<p>在alertmanager中配置连接钉钉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">    route:</span><br><span class="line">      group_by: [alertname]</span><br><span class="line">      group_wait: 30s</span><br><span class="line">      group_interval: 5m</span><br><span class="line">      repeat_interval: 1h</span><br><span class="line">      receiver: default</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: default</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        match_re:</span><br><span class="line">          alertname: 内存使用率告警|磁盘使用率告警|CPU使用率告警</span><br><span class="line">    receivers:</span><br><span class="line">    - name: &#39;default&#39;</span><br><span class="line">      webhook_configs:</span><br><span class="line">      - url: &#39;http:&#x2F;&#x2F;dingtalk.prometheus.svc.cluster.local:8060&#x2F;dingtalk&#x2F;webhook1&#x2F;send&#39;</span><br><span class="line">        send_resolved: true</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">    chart: prometheus-11.3.0</span><br><span class="line">    component: alertmanager</span><br><span class="line">    heritage: Helm</span><br><span class="line">    release: prometheus</span><br><span class="line">  name: prometheus-alertmanager</span><br><span class="line">  namespace: prometheus</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7MySQL/" class="post-title-link" itemprop="url">Prometheus监控MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:03:11" itemprop="dateCreated datePublished" datetime="2021-03-22T15:03:11+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7MySQL/" class="post-meta-item leancloud_visitors" data-flag-title="Prometheus监控MySQL" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>官方地址：<a target="_blank" rel="noopener" href="https://github.com/prometheus/mysqld_exporter">https://github.com/prometheus/mysqld_exporter</a></p>
<p>软件包下载地址：<a target="_blank" rel="noopener" href="https://github.com/prometheus/mysqld_exporter/releases">https://github.com/prometheus/mysqld_exporter/releases</a></p>
<h2 id="1、进入数据库创建用户"><a href="#1、进入数据库创建用户" class="headerlink" title="1、进入数据库创建用户"></a>1、进入数据库创建用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#39;exporter&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;hello&#39;;</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO &#39;exporter&#39;@&#39;localhost&#39;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h2 id="2、解压压缩包"><a href="#2、解压压缩包" class="headerlink" title="2、解压压缩包"></a>2、解压压缩包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xvf mysqld_exporter-0.12.1.linux-amd64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">mv mysqld_exporter-0.12.1.linux-amd64 mysqld_exporter</span><br></pre></td></tr></table></figure>
<h2 id="3、创建mysql配置文件、运行时可免密码连接数据库："><a href="#3、创建mysql配置文件、运行时可免密码连接数据库：" class="headerlink" title="3、创建mysql配置文件、运行时可免密码连接数据库："></a>3、创建mysql配置文件、运行时可免密码连接数据库：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;local&#x2F;mysql_exporter&#x2F;.my.cnf</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">user&#x3D;exporter</span><br><span class="line">password&#x3D;hello</span><br></pre></td></tr></table></figure>
<h2 id="4、启动服务"><a href="#4、启动服务" class="headerlink" title="4、启动服务"></a>4、启动服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup &#x2F;usr&#x2F;local&#x2F;mysqld_exporter&#x2F;mysqld_exporter  --config.my-cnf&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;mysqld_exporter&#x2F;.my.cnf&quot; &amp;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608164830184.png" alt="image-20200608164830184"></p>
<h2 id="5、web界面网站查看捕获mysql数据"><a href="#5、web界面网站查看捕获mysql数据" class="headerlink" title="5、web界面网站查看捕获mysql数据"></a>5、web界面网站查看捕获mysql数据</h2><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608165039884.png" alt="image-20200608165039884"></p>
<h2 id="6、Prometheus中添加mysql"><a href="#6、Prometheus中添加mysql" class="headerlink" title="6、Prometheus中添加mysql"></a>6、Prometheus中添加mysql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: mysql</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#39;192.168.1.10:9104&#39;]</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608165432286.png" alt="image-20200608165432286"></p>
<p>刷新Prometheus的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:&#x2F;&#x2F;192.168.0.103:31842&#x2F;-&#x2F;reload      #nodeIP+nodeport</span><br></pre></td></tr></table></figure>
<p>通过Prometheus就能查看到获取到了MySQL的数据</p>
<p><strong><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608165844341.png" alt="image-20200608165844341"></strong></p>
<h2 id="7、进入grafana导入mysql"><a href="#7、进入grafana导入mysql" class="headerlink" title="7、进入grafana导入mysql"></a>7、进入grafana导入mysql</h2><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608171608124.png" alt="image-20200608171608124"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608171630600.png" alt="image-20200608171630600"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200608171706439.png" alt="image-20200608171706439"></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiangsikai/p/11289675.html">https://www.cnblogs.com/xiangsikai/p/11289675.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7Redis/" class="post-title-link" itemprop="url">Prometheus监控Redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:01:09" itemprop="dateCreated datePublished" datetime="2021-03-22T15:01:09+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7Redis/" class="post-meta-item leancloud_visitors" data-flag-title="Prometheus监控Redis" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、安装"><a href="#1、安装" class="headerlink" title="1、安装"></a>1、安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xvf redis_exporter-v1.6.0.linux-amd64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">mv redis_exporter-v1.6.0.linux-amd64 redis_exporter</span><br><span class="line">## 无密码</span><br><span class="line">nohup .&#x2F;redis_exporter -redis.addr 192.168.1.120:6379 &amp;</span><br><span class="line">## 有密码</span><br><span class="line">nohup .&#x2F;redis_exporter -redis.addr 192.168.1.120:6379  -redis.password 123456</span><br><span class="line">#查看是否运行成功</span><br><span class="line">ss -auntlp |grep 9121</span><br></pre></td></tr></table></figure>
<h2 id="2、Prometheus收集redis"><a href="#2、Prometheus收集redis" class="headerlink" title="2、Prometheus收集redis"></a>2、Prometheus收集redis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: &#39;redis-dev&#39;</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - &quot;192.168.1.120:9121&quot;</span><br><span class="line">#可以重启Prometheus的服务，也可以热加载</span><br><span class="line">curl -X POST http:&#x2F;&#x2F;192.168.0.103:31842&#x2F;-&#x2F;reload        #Prometheus的web访问地址</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200619140854076.png" alt="image-20200619140854076"></p>
<h2 id="3、grafana导入模板模板编号763"><a href="#3、grafana导入模板模板编号763" class="headerlink" title="3、grafana导入模板模板编号763"></a>3、grafana导入模板模板编号763</h2><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200619150016808.png" alt="image-20200619150016808"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/alertmanager%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/alertmanager%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">alertmanager配置文件详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 14:59:34" itemprop="dateCreated datePublished" datetime="2021-03-22T14:59:34+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/alertmanager%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/" class="post-meta-item leancloud_visitors" data-flag-title="alertmanager配置文件详解" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  smtp_smarthost: &#39;localhost:25&#39;</span><br><span class="line">  smtp_from: &#39;alertmanager@example.org&#39;         #用于邮件通知的P发件人</span><br><span class="line"></span><br><span class="line">route:                                          #每个输入警报进入根路由</span><br><span class="line">  receiver: &#39;team-X-mails&#39;                      #根路由不得包含任何匹配项，因为它是所有警报的入口点</span><br><span class="line">  group_by: [&#39;alertname&#39;, &#39;cluster&#39;]            #将传入警报分组的标签。例如，将有个针对cluster &#x3D; A和alertname &#x3D; LatencyHigh的警报进入批处理成一个组</span><br><span class="line">  group_wait: 30s                               #当传入的警报创建了一组新的警报时，请至少等待多少秒发送初始通知</span><br><span class="line">  group_interval: 5m                            #发送第一个通知时，请等待多少分钟发送一批已开始为该组触发的新警报</span><br><span class="line">  repeat_interval: 3h                           #如果警报已成功发送，请等待多少小时以重新发送警报</span><br><span class="line">  routes:                                       #子路由，父路由的所有属性都会被子路由继承</span><br><span class="line">  - match_re:                                   #此路由在警报标签上执行正则表达式匹配，以捕获与服务列表相关的警报</span><br><span class="line">      service: ^(foo1|foo2|baz)$</span><br><span class="line">    receiver: team-X-mails</span><br><span class="line"></span><br><span class="line">    routes:                                     #服务有严重警报，任何警报子路径不匹配，即通过父路由配置直接发送给收件人</span><br><span class="line">    - match:</span><br><span class="line">        severity: critical</span><br><span class="line">      receiver: team-X-pager</span><br><span class="line"></span><br><span class="line">    routes:                                      #此路由处理来自数据库服务的所有警报</span><br><span class="line">    - match:</span><br><span class="line">        severity: critical</span><br><span class="line">      receiver: team-Y-pager</span><br><span class="line"></span><br><span class="line">  - match:</span><br><span class="line">      service: database</span><br><span class="line">    receiver: team-DB-pager                       #还可以按受影响的数据库对警报进行分组</span><br><span class="line">    group_by: [alertname, cluster, database]</span><br><span class="line"></span><br><span class="line">    routes:</span><br><span class="line">    - match:</span><br><span class="line">        owner: team-X</span><br><span class="line">      receiver: team-X-pager</span><br><span class="line"></span><br><span class="line">#如果另一个警报正在触发，则禁止规则允许将一组警报静音，如果同一警报已经严重，我们将使用此选项禁用任何警告级别的通知</span><br><span class="line">inhibit_rules:</span><br><span class="line">- source_match:</span><br><span class="line">    severity: &#39;critical&#39;</span><br><span class="line">  target_match:</span><br><span class="line">    severity: &#39;warning&#39;</span><br><span class="line">  equal: [&#39;alertname&#39;]</span><br><span class="line"></span><br><span class="line">#如果警报名称相同，则应用抑制，如果源警报和目标警报中均缺少“equal”中列出的所有标签名称，则将应用禁止规则！</span><br><span class="line">receivers:</span><br><span class="line">- name: &#39;team-X-mails&#39;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#39;team-X+alerts@example.org, team-Y+alerts@example.org&#39;</span><br><span class="line"></span><br><span class="line">- name: &#39;team-X-pager&#39;</span><br><span class="line">  email_configs:</span><br><span class="line">  - to: &#39;team-X+alerts-critical@example.org&#39;</span><br><span class="line">  pagerduty_configs:</span><br><span class="line">  - routing_key: &lt;team-X-key&gt;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Prometheus%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Prometheus%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Prometheus启动参数详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 14:58:07" itemprop="dateCreated datePublished" datetime="2021-03-22T14:58:07+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/Prometheus%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/" class="post-meta-item leancloud_visitors" data-flag-title="Prometheus启动参数详解" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">Flags:</span><br><span class="line">#帮助</span><br><span class="line">  -h, --help                     Show context-sensitive help (also try --help-long and --help-man).</span><br><span class="line">#版本</span><br><span class="line">      --version                  Show application version.</span><br><span class="line">#配置文件</span><br><span class="line">      --config.file&#x3D;&quot;prometheus.yml&quot;</span><br><span class="line">                                 Prometheus configuration file path.</span><br><span class="line">#监听端口</span><br><span class="line">      --web.listen-address&#x3D;&quot;0.0.0.0:9090&quot;</span><br><span class="line">                                 Address to listen on for UI, API, and telemetry.</span><br><span class="line">#空闲连接的超时时间</span><br><span class="line">      --web.read-timeout&#x3D;5m      Maximum duration before timing out read of the request, and closing idle connections.</span><br><span class="line">#最大连接数</span><br><span class="line">      --web.max-connections&#x3D;512  Maximum number of simultaneous connections.</span><br><span class="line"></span><br><span class="line">#可从外部访问Prometheus的URL（例如，如果Prometheus是通过反向代理提供的）。 用于生成返回到Prometheus本身的相对和绝对链接。 如果URL包含路径部分，它将被用作Prometheus服务的所有HTTP端点的前缀。 如果省略，则会自动派生相关的URL组件。</span><br><span class="line">      --web.external-url&#x3D;&lt;URL&gt;   The URL under which Prometheus is externally reachable (for example, if Prometheus is served via a reverse proxy). Used for generating relative and absolute links back to</span><br><span class="line">                                 Prometheus itself. If the URL has a path portion, it will be used to prefix all HTTP endpoints served by Prometheus. If omitted, relevant URL components will be derived</span><br><span class="line">                                 automatically.</span><br><span class="line">#内部路由的前缀。 默认为--web.external-url的路径。</span><br><span class="line">      --web.route-prefix&#x3D;&lt;path&gt;  Prefix for the internal routes of web endpoints. Defaults to path of --web.external-url.</span><br><span class="line">#静态资源目录的路径，位于&#x2F; user</span><br><span class="line">      --web.user-assets&#x3D;&lt;path&gt;   Path to static asset directory, available at &#x2F;user.</span><br><span class="line">#启用是否通过HTTP请求重新加载</span><br><span class="line">      --web.enable-lifecycle     Enable shutdown and reload via HTTP request.</span><br><span class="line">#管理控制操作启用API端点</span><br><span class="line">      --web.enable-admin-api     Enable API endpoints for admin control actions.</span><br><span class="line">#模板目录的路径，位于&#x2F;consoles</span><br><span class="line">      --web.console.templates&#x3D;&quot;consoles&quot;</span><br><span class="line">                                 Path to the console template directory, available at &#x2F;consoles.</span><br><span class="line">#控制台库目录的路径</span><br><span class="line">      --web.console.libraries&#x3D;&quot;console_libraries&quot;</span><br><span class="line">                                 Path to the console library directory.</span><br><span class="line">#Prometheus实例页面的文档标题</span><br><span class="line">      --web.page-title&#x3D;&quot;Prometheus Time Series Collection and Processing Server&quot;</span><br><span class="line">                                 Document title of Prometheus instance.</span><br><span class="line">#用于CORS来源的正则表达式。</span><br><span class="line">      --web.cors.origin&#x3D;&quot;.*&quot;     Regex for CORS origin. It is fully anchored. Example: &#39;https?:&#x2F;&#x2F;(domain1|domain2)\.com&#39;</span><br><span class="line">#指标(数据）存储的基本路径</span><br><span class="line">      --storage.tsdb.path&#x3D;&quot;data&#x2F;&quot;</span><br><span class="line">                                 Base path for metrics storage.</span><br><span class="line">#将数据保留多长时间。 此标志已被弃用，请改用“ storage.tsdb.retention.time”。</span><br><span class="line">      --storage.tsdb.retention&#x3D;STORAGE.TSDB.RETENTION</span><br><span class="line">                                 [DEPRECATED] How long to retain samples in storage. This flag has been deprecated, use &quot;storage.tsdb.retention.time&quot; instead.</span><br><span class="line">#将数据保留多长时间。默认15天</span><br><span class="line">      --storage.tsdb.retention.time&#x3D;STORAGE.TSDB.RETENTION.TIME</span><br><span class="line">                                 How long to retain samples in storage. When this flag is set it overrides &quot;storage.tsdb.retention&quot;. If neither this flag nor &quot;storage.tsdb.retention&quot; nor</span><br><span class="line">                                 &quot;storage.tsdb.retention.size&quot; is set, the retention time defaults to 15d.</span><br><span class="line">#可以为块存储的最大字节数。 支持的单位：KB，MB，GB，TB，PB。</span><br><span class="line">      --storage.tsdb.retention.size&#x3D;STORAGE.TSDB.RETENTION.SIZE</span><br><span class="line">                                 [EXPERIMENTAL] Maximum number of bytes that can be stored for blocks. Units supported: KB, MB, GB, TB, PB. This flag is experimental and can be changed in future releases.</span><br><span class="line">#不在数据目录中创建锁文件</span><br><span class="line">      --storage.tsdb.no-lockfile</span><br><span class="line">                                 Do not create lockfile in data directory.</span><br><span class="line">#允许重叠的块，从而启用垂直压缩和垂直查询合并。</span><br><span class="line">      --storage.tsdb.allow-overlapping-blocks</span><br><span class="line">                                 [EXPERIMENTAL] Allow overlapping blocks, which in turn enables vertical compaction and vertical query merge.</span><br><span class="line">#压缩tsdb WAL</span><br><span class="line">      --storage.tsdb.wal-compression</span><br><span class="line">                                 Compress the tsdb WAL.</span><br><span class="line">#关闭或配置重新加载时等待刷写数据的时间</span><br><span class="line">      --storage.remote.flush-deadline&#x3D;&lt;duration&gt;</span><br><span class="line">                                 How long to wait flushing sample on shutdown or config reload.</span><br><span class="line">#在单个查询中通过远程读取接口返回的最大样本总数。 0表示没有限制。 对于流式响应类型，将忽略此限制。</span><br><span class="line">      --storage.remote.read-sample-limit&#x3D;5e7</span><br><span class="line">                                 Maximum overall number of samples to return via the remote read interface, in a single query. 0 means no limit. This limit is ignored for streamed response types.</span><br><span class="line">#并发远程读取调用的最大数目。 0表示没有限制。</span><br><span class="line">      --storage.remote.read-concurrent-limit&#x3D;10</span><br><span class="line">                                 Maximum number of concurrent remote read calls. 0 means no limit.</span><br><span class="line">#用于流式传输远程读取响应类型的单个帧中的最大字节数。 请注意，客户端也可能会限制帧大小。 1MB为默认情况下由protobuf推荐</span><br><span class="line"></span><br><span class="line">--storage.remote.read-max-bytes-in-frame&#x3D;1048576</span><br><span class="line">                                 Maximum number of bytes in a single frame for streaming remote read response types before marshalling. Note that client might have limit on frame size as well. 1MB as</span><br><span class="line">                                 recommended by protobuf by default.</span><br><span class="line">#容忍中断以恢复警报“ for”状态的最长时间。</span><br><span class="line">      --rules.alert.for-outage-tolerance&#x3D;1h</span><br><span class="line">                                 Max time to tolerate prometheus outage for restoring &quot;for&quot; state of alert.</span><br><span class="line">#警报和恢复的“ for”状态之间的最短持续时间。 仅对于配置的“ for”时间大于宽限期的警报，才保持此状态。</span><br><span class="line">      --rules.alert.for-grace-period&#x3D;10m</span><br><span class="line">                                 Minimum duration between alert and restored &quot;for&quot; state. This is maintained only for alerts with configured &quot;for&quot; time greater than grace period.</span><br><span class="line">#将警报重新发送到Alertmanager之前等待的最短时间。</span><br><span class="line">      --rules.alert.resend-delay&#x3D;1m</span><br><span class="line">                                 Minimum amount of time to wait before resending an alert to Alertmanager.</span><br><span class="line">#等待的Alertmanager通知的队列容量。</span><br><span class="line">      --alertmanager.notification-queue-capacity&#x3D;10000</span><br><span class="line">                                 The capacity of the queue for pending Alertmanager notifications.</span><br><span class="line">#向Alertmanager发送警报的超时。</span><br><span class="line">      --alertmanager.timeout&#x3D;10s</span><br><span class="line">                                 Timeout for sending alerts to Alertmanager.</span><br><span class="line">#在表达式求值期间检索指标的最大回溯持续时间。</span><br><span class="line">      --query.lookback-delta&#x3D;5m  The maximum lookback duration for retrieving metrics during expression evaluations.</span><br><span class="line">#最大查询时间。</span><br><span class="line">      --query.timeout&#x3D;2m         Maximum time a query may take before being aborted.</span><br><span class="line">#最大查询并发数</span><br><span class="line">      --query.max-concurrency&#x3D;20</span><br><span class="line">                                 Maximum number of queries executed concurrently.</span><br><span class="line">#单个查询可以加载到内存中的最大样本数。 请注意，如果查询尝试将更多的样本加载到内存中，则查询将失败，因此这也限制了查询可以返回的样本数。</span><br><span class="line"></span><br><span class="line">      --query.max-samples&#x3D;50000000</span><br><span class="line">                                 Maximum number of samples a single query can load into memory. Note that queries will fail if they try to load more samples than this into memory, so this also limits the</span><br><span class="line">                                 number of samples a query can return.</span><br><span class="line">#日志级别</span><br><span class="line">      --log.level&#x3D;info           Only log messages with the given severity or above. One of: [debug, info, warn, error]</span><br><span class="line">#日志格式</span><br><span class="line">      --log.format&#x3D;logfmt        Output format of log messages. One of: [logfmt, json]</span><br></pre></td></tr></table></figure>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhoujinyi/p/11934062.html">https://www.cnblogs.com/zhoujinyi/p/11934062.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7k8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7k8s%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Prometheus监控k8s集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 14:56:38" itemprop="dateCreated datePublished" datetime="2021-03-22T14:56:38+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Prometheus/" itemprop="url" rel="index"><span itemprop="name">Prometheus</span></a>
        </span>
    </span>

  
    <span id="/2021/03/22/Prometheus%E7%9B%91%E6%8E%A7k8s%E9%9B%86%E7%BE%A4/" class="post-meta-item leancloud_visitors" data-flag-title="Prometheus监控k8s集群" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、特征"><a href="#1、特征" class="headerlink" title="1、特征"></a>1、特征</h3><p>普罗米修斯的主要特点是：</p>
<ul>
<li>一个多维<a target="_blank" rel="noopener" href="https://prometheus.io/docs/concepts/data_model/">数据模型，</a>其中包含通过度量标准名称和键/值对标识的时间序列数据</li>
<li>PromQL，一种<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/basics/">灵活的查询语言</a> ，可利用此维度</li>
<li>不依赖分布式存储；单服务器节点是自治的</li>
<li>时间序列收集通过HTTP上的拉模型进行</li>
<li>通过中间网关支持<a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/pushing/">推送时间序列</a></li>
<li>通过服务发现或静态配置发现目标</li>
<li>多种图形和仪表板支持模式</li>
</ul>
<h3 id="2、组件"><a href="#2、组件" class="headerlink" title="2、组件"></a>2、组件</h3><p>Prometheus生态系统包含多个组件，其中许多是可选的：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus">Prometheus</a>主<a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus">服务器</a>，它会刮取并存储时间序列数据</li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/clientlibs/">客户端库，</a>用于检测应用程序代码</li>
<li>一个支持短期工作的<a target="_blank" rel="noopener" href="https://github.com/prometheus/pushgateway">推送网关</a></li>
<li>诸如HAProxy，StatsD，Graphite等服务的专用<a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/exporters/">出口商</a></li>
<li>一个<a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager">alertmanager</a>处理警报</li>
<li>各种支持工具</li>
</ul>
<p>大多数Prometheus组件都是用<a target="_blank" rel="noopener" href="https://golang.org/">Go</a>编写的，因此易于构建和部署为静态二进制文件。</p>
<h3 id="3、架构"><a href="#3、架构" class="headerlink" title="3、架构"></a>3、架构</h3><p>下图说明了Prometheus的体系结构及其某些生态系统组件：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/architecture.png" alt="普罗米修斯建筑"></p>
<p>​        从上图可以看出，Prometheus 的主要模块包括：Prometheus server, exporters, Pushgateway, PromQL, Alertmanager 以及图形界面。Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。</p>
<h4 id="Prometheus工作流程"><a href="#Prometheus工作流程" class="headerlink" title="Prometheus工作流程"></a>Prometheus工作流程</h4><p>​        1.Prometheus server 定期从配置好的 jobs 或者 exporters 中拉取 metrics，或者从Pushgateway 拉取metrics，或者从其他的 Prometheus server 中拉 metrics。</p>
<p>​        2.Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。记录新的时间序列或者向 Alertmanager 推送警报。</p>
<p>​        3.Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。</p>
<h3 id="4、安装"><a href="#4、安装" class="headerlink" title="4、安装"></a>4、安装</h3><p>前提需要有helm环境：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226101438796.png" alt="image-20191226101438796"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm  install  prometheus   stable&#x2F;prometheus</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226102249663.png" alt="image-20191226102249663"></p>
<p>安装成功，查看pod状态会发现有两个处于pending状态，是因为需要请求pv</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226102456756.png" alt="image-20191226102456756"></p>
<p>这里使用hostPath来创建pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-pv1</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  -  ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &#x2F;app&#x2F;prometheus&#x2F;pv1</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226104015715.png" alt="image-20191226104015715"></p>
<p>查看pod状态会发现有个pod会报错，并查看日志是报错是容器名不同</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226110521033.png" alt="image-20191226110521033"></p>
<p>真正的原因是因为使用的hoatPath，pvc请求的权限不够，到worker节点给对应的hostpath加777的权限即可，这是我通过rancher查看到的报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg&#x3D;&quot;Error opening query log file&quot; file&#x3D;&#x2F;data&#x2F;queries.active err&#x3D;&quot;open &#x2F;data&#x2F;queries.active: permission denied&quot;</span><br></pre></td></tr></table></figure>
<h3 id="5、访问web界面"><a href="#5、访问web界面" class="headerlink" title="5、访问web界面"></a>5、访问web界面</h3><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226110837974.png" alt="image-20191226110837974"></p>
<p>这里还需要修改Prometheus-server的Port类型为NodePort。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226111719532.png" alt="image-20191226111719532"></p>
<h3 id="6、安装grafana"><a href="#6、安装grafana" class="headerlink" title="6、安装grafana"></a>6、安装grafana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm  pull  stable&#x2F;grafana</span><br><span class="line">tar xvf grafana-4.2.2.tgz</span><br><span class="line">vim grafana&#x2F;values.yaml    #设置admin的密码为admin123</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226123259170.png" alt="image-20191226123259170"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm  install grafana  .&#x2F;grafana</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226112115185.png" alt="image-20191226112115185"></p>
<p>由于grafana没有使用持久存储，根据需求修改为hostpath持久存储，需要注意的是，宿主机目录也需要777的权限</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226112409792.png" alt="image-20191226112409792"></p>
<p>还需要需改grafana的svc类型为NodePort</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226112700284.png" alt="image-20191226112700284"></p>
<p>访问web界面，用户admin，密码：admin123</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226112917716.png" alt="image-20191226112917716"></p>
<h3 id="7、导入Prometheus"><a href="#7、导入Prometheus" class="headerlink" title="7、导入Prometheus"></a>7、导入Prometheus</h3><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226123838456.png" alt="image-20191226123838456"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226123903143.png" alt="image-20191226123903143"></p>
<p>填入Prometheus的地址</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124039501.png" alt="image-20191226124039501"></p>
<p>则表示验证通过</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124212726.png" alt="image-20191226124212726"></p>
<p>导入grafana的模板</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124257031.png" alt="image-20191226124257031"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124315485.png" alt="image-20191226124315485"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124336333.png" alt="image-20191226124336333"></p>
<p>这里选择Prometheus</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124409629.png" alt="image-20191226124409629"></p>
<p>即可看到灰常华丽的仪表盘了</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226124450163.png" alt="image-20191226124450163"></p>
<p>这里提供几个模板的编号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10000，315，7249，5228，8685，8588</span><br></pre></td></tr></table></figure>
<h3 id="8、配置alertmanager告警"><a href="#8、配置alertmanager告警" class="headerlink" title="8、配置alertmanager告警"></a>8、配置alertmanager告警</h3><h4 id="8-1关联alertmanager和prometheus"><a href="#8-1关联alertmanager和prometheus" class="headerlink" title="8.1关联alertmanager和prometheus"></a>8.1关联alertmanager和prometheus</h4><p>添加alertmanager的服务名称</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alertmanagers:</span><br><span class="line">- static_configs:</span><br><span class="line">   - targets: [<span class="string">&quot;prometheus-alertmanager:80&quot;</span>]</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/1611813608(1).jpg" alt="1611813608(1)"></p>
<p>添加告警规则</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/1611813573(1).jpg" alt="1611813573(1)"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">rules.yml: |</span><br><span class="line">  groups:</span><br><span class="line">  - name: Host</span><br><span class="line">    rules:</span><br><span class="line">    - alert: HostMemory Usage</span><br><span class="line">      expr: sum(kube_pod_container_resource_requests_memory_bytes) / sum(kube_node_status_allocatable_memory_bytes) * 100 &gt;  80</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        name: Memory</span><br><span class="line">        team: wechat</span><br><span class="line">        severity: Warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot; &#123;&#123; <span class="variable">$labels</span>.appname &#125;&#125; &quot;</span></span><br><span class="line">        description: <span class="string">&quot;宿主机内存使用率超过80%.&quot;</span></span><br><span class="line">        value: <span class="string">&quot;&#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br><span class="line">    - alert: HostCPU Usage</span><br><span class="line">      expr: sum(kube_pod_container_resource_requests_cpu_cores) / sum(kube_node_status_allocatable_cpu_cores) * 100 &gt; 60</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        name: CPU</span><br><span class="line">        team: wechat</span><br><span class="line">        severity: Warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot; &#123;&#123; <span class="variable">$labels</span>.appname &#125;&#125; &quot;</span></span><br><span class="line">        description: <span class="string">&quot;宿主机CPU使用率超过60%.&quot;</span></span><br><span class="line">        value: <span class="string">&quot;&#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br><span class="line">    - alert: HostFilesystem Usage</span><br><span class="line">      expr: (sum(node_filesystem_size_bytes&#123;device!=<span class="string">&quot;rootfs&quot;</span>&#125;) - sum(node_filesystem_free_bytes&#123;device!=<span class="string">&quot;rootfs&quot;</span>&#125;)) / sum(node_filesystem_size_bytes&#123;device!=<span class="string">&quot;rootfs&quot;</span>&#125;) &gt;  0.8</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        name: Disk</span><br><span class="line">        team: wechat</span><br><span class="line">        severity: Warning</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot; &#123;&#123; <span class="variable">$labels</span>.appname &#125;&#125; &quot;</span></span><br><span class="line">        description: <span class="string">&quot; 宿主机 [ &#123;&#123; <span class="variable">$labels</span>.mountpoint &#125;&#125; ]分区使用超过80%.&quot;</span></span><br><span class="line">        value: <span class="string">&quot;&#123;&#123; <span class="variable">$value</span> &#125;&#125;%&quot;</span></span><br></pre></td></tr></table></figure>
<p>保存后重新启动Prometheus服务。</p>
<h4 id="8-2配置企业微信告警"><a href="#8-2配置企业微信告警" class="headerlink" title="8.2配置企业微信告警"></a>8.2配置企业微信告警</h4><p>编写告警模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  wechat.tmpl: |</span><br><span class="line">    &#123;&#123; define <span class="string">&quot;wechat.default.message&quot;</span> &#125;&#125;</span><br><span class="line">    &#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">    ========start==========</span><br><span class="line">    告警程序: prometheus_alert</span><br><span class="line">    告警级别: &#123;&#123; .Labels.severity &#125;&#125;</span><br><span class="line">    告警类型: &#123;&#123; .Labels.alertname &#125;&#125;</span><br><span class="line">    故障主机: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class="line">    告警主题: &#123;&#123; .Annotations.summary &#125;&#125;</span><br><span class="line">    告警详情: &#123;&#123; .Annotations.description &#125;&#125;</span><br><span class="line">    触发时间: &#123;&#123; .StartsAt.Format <span class="string">&quot;2006-01-02 15:04:05&quot;</span> &#125;&#125;</span><br><span class="line">    ========end==========</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br><span class="line">    &#123;&#123; end &#125;&#125;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: wechat-tmpl</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure>
<p>修改prometheus-alertmanager的yaml文件，将微信配置挂载进来</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/1616395467(1).jpg" alt="1616395467(1)"></p>
<p>登录企业微信，创建机器人</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/1616395487(1).jpg" alt="1616395487(1)"></p>
<p>获取api_secret和agent_id</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/1616395498(1).jpg" alt="1616395498(1)"></p>
<p>点击我的企业、企业信息，获取corp_id</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/asdw.jpg" alt="asdw"></p>
<p>需要报警的组，获取to_party</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/1616395516(1).jpg" alt="1616395516(1)"></p>
<p>修改prometheus-alertmanager的configmap文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">    route:</span><br><span class="line">      group_interval: 5m</span><br><span class="line">      group_wait: 10s</span><br><span class="line">      receiver: email</span><br><span class="line">      repeat_interval: 10m</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: wechat</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        match:</span><br><span class="line">          team: wechat</span><br><span class="line">    templates:</span><br><span class="line">      - <span class="string">&quot;/etc/alertmanager-tmpl/wechat.tmpl&quot;</span></span><br><span class="line">    receivers:</span><br><span class="line">    - name: wechat</span><br><span class="line">      wechat_configs:</span><br><span class="line">      - corp_id: ww8e2ba8bad3ee2df5</span><br><span class="line">        to_party: 1</span><br><span class="line">        agent_id: 1000002</span><br><span class="line">        api_secret: HbyB2SNaa26y9fziO7zt3FQnd34wT1i_iB6Q0I6KG60</span><br><span class="line">        send_resolved: <span class="literal">true</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus-alertmanager</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure>
<p>重启alertmanager服务即可，如果需要测试，在告警规则降低阈值即可。</p>
<h4 id="8-3配置邮件告警"><a href="#8-3配置邮件告警" class="headerlink" title="8.3配置邮件告警"></a>8.3配置邮件告警</h4><p>修改alertmanager的configmap文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  alertmanager.yml: |</span><br><span class="line">    global:</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      smtp_smarthost: smtp.qq.com:587       <span class="comment">#端口有的是465，有的是587</span></span><br><span class="line">      smtp_from: 982012556@qq.com         <span class="comment">#邮箱地址</span></span><br><span class="line">      smtp_auth_username: 982012556@qq.com     <span class="comment">#邮箱地址</span></span><br><span class="line">      smtp_auth_password: hblcukkqnzwebdai     <span class="comment">#在邮箱中开启SMTP服务所得的密码</span></span><br><span class="line">      smtp_require_tls: <span class="literal">true</span></span><br><span class="line">    route:</span><br><span class="line">      group_interval: 5m</span><br><span class="line">      group_wait: 10s</span><br><span class="line">      receiver: email</span><br><span class="line">      repeat_interval: 10m</span><br><span class="line">      routes:</span><br><span class="line">      - receiver: email</span><br><span class="line">        group_wait: 10s</span><br><span class="line">        match:</span><br><span class="line">          team: wechat          <span class="comment">#这是我设置的规则组，可在Prometheus的配置文件中随意设置</span></span><br><span class="line">    receivers:</span><br><span class="line">    - name: email</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: 982012556@qq.com</span><br><span class="line">        send_resolved: <span class="literal">true</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus-alertmanager</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/1616395526(1).jpg" alt="1616395526(1)"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/18/dockerignore%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/18/dockerignore%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">dockerignore文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-18 17:27:27" itemprop="dateCreated datePublished" datetime="2021-03-18T17:27:27+08:00">2021-03-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">容器</span></a>
        </span>
    </span>

  
    <span id="/2021/03/18/dockerignore%E6%96%87%E4%BB%B6/" class="post-meta-item leancloud_visitors" data-flag-title="dockerignore文件" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>​    该.dockerignore文件是隐藏文件也是一个工具，可以帮助你定义你真正需要的Docker构建上下文。使用此文件，你可以为这些文件和文件夹规则指定忽略规则和异常，这些规则和异常将不包含在构建上下文中，因此不会打包到存档中并上载到Docker服务器。</p>
<h2 id="1、dockerignore语法"><a href="#1、dockerignore语法" class="headerlink" title="1、dockerignore语法"></a>1、dockerignore语法</h2><p>​    该.dockerignore文件类似于gitignore该git工具使用的文件。与.gitignore文件类似，它允许你为生成构建上下文时Docker客户端应忽略的文件和文件夹指定模式。虽然.dockerignore用于描述忽略模式的文件语法类似于.gitignore，但它并不相同。<br>​    该.dockerignore模式匹配的语法是基于filepath.Match()和filepath.clean的功能，包括一些补充。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Docker还支持一个**匹配任意数量目录（包括零）的特殊通配符字符串。例如，**&#x2F;*.go将排除.go 在所有目录中找到的以该结尾的所有文件，包括构建上下文的根。</span><br></pre></td></tr></table></figure>
<h2 id="2、以下是完整的语法-dockerignore："><a href="#2、以下是完整的语法-dockerignore：" class="headerlink" title="2、以下是完整的语法.dockerignore："></a>2、以下是完整的语法.dockerignore：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pattern:</span><br><span class="line">&#123;term&#125;</span><br><span class="line">术语：</span><br><span class="line">&#39;*&#39;      匹配任何非分隔符字符序列</span><br><span class="line">&#39;？&#39;     匹配任何单个非分隔符</span><br><span class="line">&#39;[&#39;[&#39;^&#39;] &#123;character-range&#125;&#39;]&#39;</span><br><span class="line">字符类（必须是非空的）</span><br><span class="line">c匹配字符c  （c！&#x3D;&#39;*&#39;，&#39;？&#39;，&#39;\\&#39;，&#39;[&#39;）</span><br><span class="line">&#39;\\&#39;    c匹配字符c</span><br><span class="line"></span><br><span class="line">字符范围：</span><br><span class="line">c匹配字符c  （c！&#x3D;&#39;\\&#39;，&#39; - &#39;，&#39;]&#39;）</span><br><span class="line">&#39;\\&#39;    c匹配字符c</span><br><span class="line">lo&#39; - &#39;hi匹配字符c for lo＆lt; &#x3D; c＆lt; &#x3D; hi</span><br><span class="line"></span><br><span class="line">补充：</span><br><span class="line">&#39;**&#39;    匹配任意数量的目录（包括零）</span><br><span class="line">&#39;！&#39;     行开头！ （感叹号）可用于排除例外情况</span><br><span class="line">以此字符开头的&#39;＃&#39;行将被忽略：将其用于评论</span><br></pre></td></tr></table></figure>
<h2 id="3、示例"><a href="#3、示例" class="headerlink" title="3、示例"></a>3、示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">＃ignore除了README-secret.md以外的所有README*.md和旁边的所有markdown文件（md）格式的都不要</span><br><span class="line">*.MD</span><br><span class="line">！README*.MD</span><br><span class="line">README-secret.md</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">＃ignore所有文件夹中的所有*.class文件，包括构建根目录</span><br><span class="line">**&#x2F;*.class</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">＃ignore .git和.cache文件夹</span><br><span class="line">.git</span><br><span class="line">.cache</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 排除名称以temp根目录的任何直接子目录开头的文件或者目录，如&#x2F;somedir&#x2F;tempfile.txt,录&#x2F;somedir&#x2F;temp&#x2F;</span><br><span class="line">*&#x2F;temp*</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># temp从以下两级以下的任何子目录开始排除文件和目录。例如，&#x2F;somedir&#x2F;subdir&#x2F;temporary.txt被排除在外。</span><br><span class="line">*&#x2F;*&#x2F;temp*</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 排除根目录中的文件和目录，其名称是单字符扩展名temp。例如，&#x2F;tempa与&#x2F;tempb被排除在外</span><br><span class="line">temp?</span><br></pre></td></tr></table></figure>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.linuxea.com/2297.html">https://www.linuxea.com/2297.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">羊皮裘老头</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":null,"app_key":null,"server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<!-- calendar widget -->
{% if theme.CloudCalendar.enable %}
    <script src="{{ theme.CloudCalendar.calendarCdn }}"></script>
    <script src="{{ theme.CloudCalendar.langCdn }}"></script>
    <script>
    $(function() {
        $('#CloudCalendar').aCalendar('{{ theme.CloudCalendar.language }}',
            $.extend(
                '', {
                    single:{{ theme.CloudCalendar.single }},
                    root:'{{ theme.CloudCalendar.root }}'
                }
            )
        );
    });
    </script>
{% endif %}

</body>
</html>
