<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-55HKMllCks">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic%7CAmita:300,300italic,400,400italic,700,700italic%7CMontserrat:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="羊皮裘老头">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="羊皮裘老头">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="羊皮裘老头">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/10/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/10/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>羊皮裘老头</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">羊皮裘老头</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">28</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">116</span></a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="羊皮裘老头"
      src="/images/bb.jpg">
  <p class="site-author-name" itemprop="name">羊皮裘老头</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


<!-- CloudCalendar -->
<div class="widget-wrap" style="width: 90%;margin-left: auto;margin-right: auto; opacity: 0.97;">
	<div class="widget" id="CloudCalendar"></div>
</div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">


	<div class="tag-cloud">
	  <div class="tag-cloud-tags" id="tags">
		<a href="/tags/Calico/" style="font-size: 16px; color: #fff">Calico</a> <a href="/tags/Containerd/" style="font-size: 16px; color: #fff">Containerd</a> <a href="/tags/Docker/" style="font-size: 16px; color: #fff">Docker</a> <a href="/tags/Drone/" style="font-size: 16px; color: #fff">Drone</a> <a href="/tags/Elasticsearch/" style="font-size: 16px; color: #fff">Elasticsearch</a> <a href="/tags/Filebeat/" style="font-size: 16px; color: #fff">Filebeat</a> <a href="/tags/Gitlab/" style="font-size: 16px; color: #fff">Gitlab</a> <a href="/tags/Golang/" style="font-size: 16px; color: #fff">Golang</a> <a href="/tags/Harbor/" style="font-size: 16px; color: #fff">Harbor</a> <a href="/tags/Helm/" style="font-size: 16px; color: #fff">Helm</a> <a href="/tags/Hexo/" style="font-size: 16px; color: #fff">Hexo</a> <a href="/tags/Istio/" style="font-size: 16px; color: #fff">Istio</a> <a href="/tags/Jenkins/" style="font-size: 16px; color: #fff">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 16px; color: #fff">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 16px; color: #fff">Linux</a> <a href="/tags/Logstash/" style="font-size: 16px; color: #fff">Logstash</a> <a href="/tags/Mariadb/" style="font-size: 16px; color: #fff">Mariadb</a> <a href="/tags/MetalLB/" style="font-size: 16px; color: #fff">MetalLB</a> <a href="/tags/Minio/" style="font-size: 16px; color: #fff">Minio</a> <a href="/tags/Mysql/" style="font-size: 16px; color: #fff">Mysql</a> <a href="/tags/Nexus/" style="font-size: 16px; color: #fff">Nexus</a> <a href="/tags/PostgreSQL/" style="font-size: 16px; color: #fff">PostgreSQL</a> <a href="/tags/Prometheus/" style="font-size: 16px; color: #fff">Prometheus</a> <a href="/tags/Rancher/" style="font-size: 16px; color: #fff">Rancher</a> <a href="/tags/Redis/" style="font-size: 16px; color: #fff">Redis</a> <a href="/tags/Shell/" style="font-size: 16px; color: #fff">Shell</a> <a href="/tags/Sonarqube/" style="font-size: 16px; color: #fff">Sonarqube</a> <a href="/tags/VMware/" style="font-size: 16px; color: #fff">VMware</a>
	  </div>
	</div>
	<br>

	<script type="text/javascript">
     var alltags = document.getElementsByClassName('tag-cloud-tags');
     var tags = alltags[0].getElementsByTagName('a');
     for (var i = tags.length - 1; i >= 0; i--) {
       var r=Math.floor(Math.random()*75+130);
       var g=Math.floor(Math.random()*75+100);
       var b=Math.floor(Math.random()*75+80);
       tags[i].style.background = "rgb("+r+","+g+","+b+")";
     }
</script>

<style>
  .tag-cloud-tags{
    /*font-family: Helvetica, Tahoma, Arial;*/
    /*font-weight: 100;*/
    text-align: center;
    counter-reset: tags;
  }
  .tag-cloud-tags a{
    border-radius: 6px;
    padding-right: 5px;
    padding-left: 5px;
    margin: 8px 5px 0px 0px;
  }
  .tag-cloud-tags a:before{
    content: "?";
  }

  .tag-cloud-tags a:hover{
     box-shadow: 0px 5px 15px 0px rgba(0,0,0,.4);
     transform: scale(1.1);
     /*box-shadow: 10px 10px 15px 2px rgba(0,0,0,.12), 0 0 6px 0 rgba(104, 104, 105, 0.1);*/
     transition-duration: 0.15s;
  }
</style>

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/EFK%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/EFK%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">EFK收集K8s日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 17:21:22" itemprop="dateCreated datePublished" datetime="2021-03-16T17:21:22+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elk/" itemprop="url" rel="index"><span itemprop="name">Elk</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/EFK%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/" class="post-meta-item leancloud_visitors" data-flag-title="EFK收集K8s日志" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>备注：所需镜像都会去外网拉取，所以镜像需要自己想办法！！！</p>
<p>环境介绍：</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311104450873.png" alt="image-20200311104450873"></p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311104505003.png" alt="image-20200311104505003"></p>
<h3 id="一、下载elasticsearch安装包"><a href="#一、下载elasticsearch安装包" class="headerlink" title="一、下载elasticsearch安装包"></a>一、下载elasticsearch安装包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm pull stable&#x2F;elasticsearch</span><br><span class="line">tar xvf elasticsearch-1.32.4.tgz      #可以根据自己需求修改elasticsearch&#x2F;values.yaml文件</span><br><span class="line">helm install elasticsearch -n efk .&#x2F;elasticsearch</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311105442100.png" alt="image-20200311105442100"></p>
<p>创建pv</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311115637255.png" alt="image-20200311115637255"></p>
<p>查看pod状态</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311115704635.png" alt="image-20200311115704635"></p>
<h3 id="二、安装kibana"><a href="#二、安装kibana" class="headerlink" title="二、安装kibana"></a>二、安装kibana</h3><p>下载解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm pull stable&#x2F;kibana</span><br><span class="line">tar xvf kibana-3.2.6.tgz</span><br><span class="line">vim kibana&#x2F;values.yaml             #修改类型为NodePort</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311135212537.png" alt="image-20200311135212537"></p>
<p>安装</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311135317733.png" alt="image-20200311135317733"></p>
<p>关联es</p>
<p>通过svc可以看到es的service名称为elasticsearch-client</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311135913621.png" alt="image-20200311135913621"></p>
<p>修改kibana的ConfigMap文件</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311140103657.png" alt="image-20200311140103657"></p>
<h3 id="三、安装fluentd"><a href="#三、安装fluentd" class="headerlink" title="三、安装fluentd"></a>三、安装fluentd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm pull stable&#x2F;fluentd</span><br><span class="line">tar xvf fluentd-2.4.0.tgz</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311150432250.png" alt="image-20200311150432250"></p>
<p>修改输出的es地址</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311151240927.png" alt="image-20200311151240927"></p>
<p>挂载日志目录</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311154522739.png" alt="image-20200311154522739"></p>
<p>修改fluetd的configmap文件</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200311155734588.png" alt="image-20200311155734588"></p>
<p>添加以下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">containers.input.conf: |-</span><br><span class="line">  &lt;source&gt;</span><br><span class="line">    @id fluentd-containers.log</span><br><span class="line">    @type tail</span><br><span class="line">    path &#x2F;var&#x2F;log&#x2F;*&#x2F;*.log    #fluentd容器中所挂载的日志目录</span><br><span class="line">    pos_file &#x2F;var&#x2F;log&#x2F;es-containers.log.pos</span><br><span class="line">    tag raw.kubernetes.*</span><br><span class="line">    read_from_head true</span><br><span class="line">    &lt;parse&gt;</span><br><span class="line">      @type multi_format</span><br><span class="line">      &lt;pattern&gt;</span><br><span class="line">        format json</span><br><span class="line">        time_key time</span><br><span class="line">        time_format %Y-%m-%dT%H:%M:%S.%NZ</span><br><span class="line">      &lt;&#x2F;pattern&gt;</span><br><span class="line">      &lt;pattern&gt;</span><br><span class="line">        format &#x2F;^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$&#x2F;</span><br><span class="line">        time_format %Y-%m-%dT%H:%M:%S.%N%:z</span><br><span class="line">      &lt;&#x2F;pattern&gt;</span><br><span class="line">    &lt;&#x2F;parse&gt;</span><br><span class="line">  &lt;&#x2F;source&gt;</span><br><span class="line">  # Detect exceptions in the log output and forward them as one log entry.</span><br><span class="line">  &lt;match raw.kubernetes.**&gt;</span><br><span class="line">    @id raw.kubernetes</span><br><span class="line">    @type detect_exceptions</span><br><span class="line">    remove_tag_prefix raw</span><br><span class="line">    message log</span><br><span class="line">    stream stream</span><br><span class="line">    multiline_flush_interval 5</span><br><span class="line">    max_bytes 500000</span><br><span class="line">    max_lines 1000</span><br><span class="line">  &lt;&#x2F;match&gt;</span><br></pre></td></tr></table></figure>
<h3 id="四、访问kibana"><a href="#四、访问kibana" class="headerlink" title="四、访问kibana"></a>四、访问kibana</h3><p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200312102202960.png" alt="image-20200312102202960"></p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200312102235114.png" alt="image-20200312102235114"></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/K8s%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/K8s%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">K8s健康检测</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:41:41" itemprop="dateCreated datePublished" datetime="2021-03-16T10:41:41+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/K8s%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B/" class="post-meta-item leancloud_visitors" data-flag-title="K8s健康检测" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>健康检测的探测方式有哪些</li>
<li>健康检测的探针有哪些</li>
<li>如何选择探测方式</li>
<li>探测实例</li>
</ol>
<h2 id="1-健康检测的探测方式"><a href="#1-健康检测的探测方式" class="headerlink" title="1.健康检测的探测方式"></a>1.健康检测的探测方式</h2><ul>
<li><p><strong>LivenessProbe存活探测：</strong><br>用于判断容器是否存活，即Pod是否为running状态，如果LivenessProbe探针探测到容器不健康，则kubelet将kill掉容器，并根据容器的重启策略是否重启，如果一个容器不包含LivenessProbe探针，则Kubelet认为容器的LivenessProbe探针的返回值永远成功。</p>
</li>
<li><p><strong>ReadinessProbe就绪探测：</strong><br>用于判断容器是否启动完成，即容器的Ready是否为True，可以接收请求，如果ReadinessProbe探测失败，则容器的Ready将为False，控制器将此Pod的Endpoint从对应的service的Endpoint列表中移除，从此不再将任何请求调度此Pod上，直到下次探测成功。</p>
</li>
<li><p><strong>startupProbe启动探测：</strong> （1.16版本）</p>
<p>指示容器中的应用程序是否已启动。如果提供了启动探针，则将禁用所有其他探针，直到成功。如果启动探针失败，则kubelet将杀死Container，并且Container将接受其重启策略。如果容器未提供启动探针，则默认状态为Success。</p>
</li>
</ul>
<h2 id="2-健康检测的探针"><a href="#2-健康检测的探针" class="headerlink" title="2.健康检测的探针"></a>2.健康检测的探针</h2><p><strong>Liveness 指针和 Readiness 指针支持三种不同的探测方式：</strong></p>
<ul>
<li>1，第一种是 httpGet。它是通过发送 http Get 请求来进行判断的，当返回码是 200-399 之间的状态码时，标识这个应用是健康的；</li>
<li>2，第二种探测方式是 Exec。它是通过执行容器中的一个命令来判断当前的服务是否是正常的，当命令行的返回结果是 0，则标识容器是健康的；</li>
<li>3，第三种探测方式是 tcpSocket 。它是通过探测容器的 IP 和 Port 进行 TCP 健康检查，如果这个 TCP 的链接能够正常被建立，那么标识当前这个容器是健康的。</li>
</ul>
<p>第一种探测方式和第三种非常相似，一般常用的是第一和第二种的探测方式。</p>
<p> 每种检查动作都可能有三种返回状态。</p>
<p>Success，表示通过了健康检查</p>
<p>Failure，表示没有通过健康检查</p>
<p>Unknown，表示检查动作失败</p>
<p><em>restartPolicy   Always或 OnFailure</em></p>
<p>Always: 重启异常退出容器，pod的phase是Running<br>OnFailure: 重启异常退出容器，pod的phase是Running<br>Never: pod的phase变成Failed.</p>
<h2 id="3-探测方式的选择"><a href="#3-探测方式的选择" class="headerlink" title="3.探测方式的选择"></a>3.探测方式的选择</h2><h5 id="Liveness和Readness两种探测机制比较"><a href="#Liveness和Readness两种探测机制比较" class="headerlink" title="Liveness和Readness两种探测机制比较"></a><strong>Liveness和Readness两种探测机制比较</strong></h5><p><strong>Liveness和Readness两种探测机制的使用场景：</strong> Liveness 指针适用场景是支持那些可以重新拉起的应用，而 Readiness 指针主要应对的是启动之后无法立即对外提供服务的这些应用。 （可用于服务更新）</p>
<p><strong>Liveness和Readness两种探测机制的相同点和不同点：</strong> 相同点是根据探测pod内某个应用或文件，来检查pod的健康状况，不同点是liveness如果探测失败会重启pod，而readliness则在连续3次探测（默认探测三次）失败之后，会将pod设置为不可用的状态，并不会重启pod。</p>
<p>1.您的Container中的进程在遇到问题或变得不正常时能够自行崩溃，则不一定需要进行活动调查；kubelet将根据Pod的自动执行正确的操作<code>restartPolicy</code></p>
<p>2.在探测失败时杀死并重启容器，请指定存活探测或（1.16版可选启动探测） 并指定 restartPolicy  Always或OnFailure。</p>
<p> 3.探测成功后才开始向Pod发送流量，请指定就绪探测器  就绪探针可能与存活探针相同，但是规范中存在就绪探针意味着Pod将在不接收任何流量的情况下启动，并且仅在探针开始成功之后才开始接收流量。如果您的容器需要在启动过程中加载大型数据，配置文件或迁移，请指定就绪探测。</p>
<p>4.Container能够自行拆卸下来进行维护，则可以指定一个准备就绪探针，该探针检查特定于准备就绪的端点</p>
<p>5.只是希望在删除Pod时能够耗尽请求，则不一定需要准备就绪探针。删除后，无论是否准备就绪探针，Pod都会自动将自己置于未就绪状态。等待Pod中的Container停止时，Pod仍处于未就绪状态。</p>
<p>该<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/admin/kubelet/">kubelet</a>使用活跃度探头知道什么时候重新启动的Container。例如，活动性探针可能会陷入僵局，而应用程序正在运行，但无法取得进展。在这种状态下重新启动Container可以帮助应用程序尽管存在错误也更可用。</p>
<p>6.Kubelet使用就绪性探测器来了解何时Container准备开始接受流量。当Pod的所有Container都准备就绪时，即视为准备就绪。此信号的一种用法是控制将哪些Pod用作服务的后端。当Pod尚未就绪时，会将其从服务负载平衡器中删除。</p>
<p>4.Container通常以<code>initialDelaySeconds + failureThreshold × periodSeconds</code>开头，则应指定一个启动探针，该探针检查与活动探针相同的终结点。默认<code>periodSeconds</code>值为30秒。然后，应将其设置<code>failureThreshold</code>得足够高以允许Container启动，而不更改存活探针的默认值。这有助于防止死锁。</p>
<p>kubelet使用启动探针来了解何时启动Container应用程序。如果配置了这样的探针，它将禁用活动性和就绪性检查，直到成功为止，以确保这些探针不会干扰应用程序的启动。这可用于对启动缓慢的容器进行活动检查，避免它们在启动和运行之前被kubelet杀死。</p>
<h2 id="4-健康探测实例"><a href="#4-健康探测实例" class="headerlink" title="4.健康探测实例"></a>4.健康探测实例</h2><ul>
<li><code>initialDelaySeconds</code>：启动容器后，启动活动或就绪探针之前的秒数。默认为0秒。最小值为0。</li>
<li><code>periodSeconds</code>：执行探测的频率（以秒为单位）。默认为10秒。最小值为1。</li>
<li><code>timeoutSeconds</code>：探测超时的秒数。默认为1秒。最小值为1。</li>
<li><code>successThreshold</code>：探测失败后，连续最小成功探测为成功。默认值为1。为保持活力，必须为1。最小值为1。</li>
<li><code>failureThreshold</code>：当Pod启动并且探测失败时，Kubernetes会尝试尝试<code>failureThreshold</code>多次，然后放弃。放弃活动探针意味着重新启动容器。如果准备就绪，则将Pod标记为“未就绪”。默认值为3。最小值为1。</li>
</ul>
<p><strong>示例一：通过exec方式做健康探测</strong></p>
<p>查看pod内某个指定的文件是否存在，如果存在则认为状态为健康的，否则会根据设置的重启重启策略重启pod。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness</span><br><span class="line">  labels:</span><br><span class="line">    name: liveness</span><br><span class="line">spec:</span><br><span class="line">  restartPolicy: OnFailure    ##定义重启策略，仅在pod对象出现错误时才重启</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    args:</span><br><span class="line">    - &#x2F;bin&#x2F;sh</span><br><span class="line">    - -c</span><br><span class="line">    - touch &#x2F;tmp&#x2F;test; sleep 30; rm -rf &#x2F;tmp&#x2F;test; sleep 300  #创建文件，并且在30秒后将文件进行删除</span><br><span class="line">    livenessProbe:      #执行活跃度探测</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">        - cat      #探测&#x2F;tmp目录下是有test文件，有则代表健康，没有则执行重启pod策略。</span><br><span class="line">        - &#x2F;tmp&#x2F;test</span><br><span class="line">      initialDelaySeconds: 10        #当容器运行多久之后开始探测（单位是s）</span><br><span class="line">      periodSeconds: 5     #探测频率（单位s），每隔5秒探测一次。</span><br></pre></td></tr></table></figure>
<p>容器执行livenessProbe检查，periodSeconds字段指定kubelet每5s执行一次检查，检查的命令为cat /tmp/healthy，initialDelaySeconds字段告诉kubelet应该在执行第一次检查之前等待10秒， 如果命令执行成功，则返回0，那么kubelet就认为容器是健康的，如果为非0，则Kubelet会Kill掉容器并根据重启策略来决定是否需要重启。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;bin&#x2F;sh -c &quot;touch &#x2F;tmp&#x2F;test; sleep 30; rm -rf &#x2F;tmp&#x2F;test; sleep 300&quot;</span><br></pre></td></tr></table></figure>
<p>容器的前30秒，有一个**/tmp/healthy<strong>文件。因此，在前30秒内，该命令</strong>cat /tmp/healthy<strong>返回成功代码。30秒后，</strong>cat /tmp/healthy**返回失败代码。</p>
<p>可用以下命令查看状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod liveness-exec</span><br></pre></td></tr></table></figure>
<p>在配置文件中，使用k8s.gcr.io/liveness镜像，创建出一个Pod，其中<strong>periodSeconds</strong>字段指定kubelet每3秒执行一次探测，<strong>initialDelaySeconds</strong>字段告诉kubelet延迟等待3秒，探测方式为向容器中运行的服务发送HTTP GET请求，请求8080端口下的**/healthz**, 任何大于或等于200且小于400的代码表示成功。任何其他代码表示失败。</p>
<p><strong>示例二：通过TCP方式做健康探测</strong></p>
<p>Kubelet将尝试在指定的端口上打开容器上的套接字，如果能建立连接，则表明容器健康。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: k8s.gcr.io&#x2F;goproxy:0.1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br></pre></td></tr></table></figure>
<p><strong>示例三：通过HTTP方式做健康探测</strong></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#httpgetaction-v1-core">HTTP探针</a> 还有其他可以设置的字段<code>httpGet</code>：</p>
<ul>
<li><code>host</code>：要连接的主机名，默认为Pod IP。您可能要改为在httpHeaders中设置“主机”。</li>
<li><code>scheme</code>：用于连接到主机（HTTP或HTTPS）的方案。默认为HTTP。</li>
<li><code>path</code>：HTTP服务器上的访问路径。</li>
<li><code>httpHeaders</code>：要在请求中设置的自定义标头。HTTP允许重复的标头。</li>
<li><code>port</code>：要在容器上访问的端口的名称或端口号。编号必须在1到65535之间。</li>
</ul>
<p>readiness加liveness  服务未准备就绪，是0/1    访问拒绝，当状态为正常时，访问正常，容器删除，服务重启</p>
<p>k8s会根据service关联到pod的podIP信息组合成一个endpoint。通过负载转发策略将请求转发到后端的各个pod上，kube-proxy负责service的实现，通过侦听service更新事件，更新service相关的iptables规则，同时也侦听endpoint更新事件，更新endpoint相关的iptables规则，然后将包请求转入endpoint对应的Pod，如果某个service尚没有Pod创建，那么针对此service的请求将会被drop掉。</p>
<p>readiness就是通过service来解决请求，只有当容器创建成功service才会更新pod的信息，请求才会被接受，反之请求会被负载到service中存在的容器上，</p>
<p>liveness则是当pods创建后service就会更新pod信息，请求被接受但是连接拒绝，等到pods正常时访问才正常</p>
<h2 id="服务依赖"><a href="#服务依赖" class="headerlink" title="服务依赖"></a>服务依赖</h2><h4 id="理解Init-Container"><a href="#理解Init-Container" class="headerlink" title="理解Init Container"></a>理解Init Container</h4><p>一个pod中可以有一或多个Init Container。Pod的中多个Init Container启动顺序为yaml文件中的描述顺序，且串行方式启动，下一个Init/app Container必须等待上一个Init Container完成后方可启动。例如，Init Container1-&gt; … -&gt; Init Containern -&gt; app Container[1-n]。Init Container1成功启动并且完成后，后续的Init Container和app Container才可以启动，如Init Container启动或执行相关检查失败，后续的init Container和应用Container将不会被执行启动命令。</p>
<p>因此可利用Init Container来判断app Container中被依赖的服务是否成功启动。如被依赖的app Container服务启动失败，那么利用Init Container启动失败可以阻止后续app Container服务的启动。</p>
<p>由于Init Container必须要在pod状态变为Ready之前完成，所以其不需要readiness探针。另外在资源的requests与limits上与普通Container有细微差别，详见</p>
<p>Resources</p>
<p>，除以上2点外，Init Container与普通Container并无明显区别。</p>
<h4 id="Init-Containers用途"><a href="#Init-Containers用途" class="headerlink" title="Init Containers用途"></a>Init Containers用途</h4><ol>
<li>前文已经提及，由于Init Container必须在app Containers启动之前完成，所以可利用其特性，用作服务依赖处理。比如某一个服务A，需依赖db或memcached，那么可以利用服务A pod的Init Container判断db/memcached是否正常提供服务，如果启动服务失败或工作异常，设置Init Container启动失败，那么pod中的服务A就不会被启动了。</li>
<li>应用镜像因安全原因等没办法安装或运行的工具，可放到Init Container中运行。另外，Init Container独立于业务服务，与业务无关的工具如sed, awk, python, dig等也可以按需放到Init Container之中。最后，Init Container也可以被授权访问应用Container无权访问的内容。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/%E6%97%A0%E4%BA%BA%E6%9C%BADrone%E8%BF%90%E8%A1%8Cpipeline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/%E6%97%A0%E4%BA%BA%E6%9C%BADrone%E8%BF%90%E8%A1%8Cpipeline/" class="post-title-link" itemprop="url">无人机Drone运行pipeline</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:24:06" itemprop="dateCreated datePublished" datetime="2021-03-16T10:24:06+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/%E6%97%A0%E4%BA%BA%E6%9C%BADrone%E8%BF%90%E8%A1%8Cpipeline/" class="post-meta-item leancloud_visitors" data-flag-title="无人机Drone运行pipeline" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、pipeline类型"><a href="#1、pipeline类型" class="headerlink" title="1、pipeline类型"></a>1、pipeline类型</h3><p>​        无人机支持不同类型的管道执行环境，其中每种类型都有自己的自定义yaml规范。kind和type属性定义管道的类型和目标执行环境。</p>
<h4 id="1-1-Docker管道"><a href="#1-1-Docker管道" class="headerlink" title="1.1  Docker管道"></a>1.1  Docker管道</h4><p>​        在隔离的Docker容器内执行管道命令。一个docker管道是一个管道来执行壳Docker容器内部的命令。Docker容器提供隔离，可在同一台机器上安全地执行并发管道。容器管道的主要好处是能够以Docker镜像的形式带来自己的构建环境。无人机会在运行时自动下载docker镜像</p>
<p><a target="_blank" rel="noopener" href="https://docker-runner.docs.drone.io/configuration/overview/">https://docker-runner.docs.drone.io/configuration/overview/</a></p>
<h4 id="1-2-Kubernetes管道"><a href="#1-2-Kubernetes管道" class="headerlink" title="1.2  Kubernetes管道"></a>1.2  Kubernetes管道</h4><p>​        在pod内执行管道命令，其中每个管道步骤都由pod中的容器表示。一个kubernetes管道执行管道作为Kubernetes吊舱内的容器几步之遥。容器提供隔离，可以安全地在同一台计算机上执行并发管道。基于容器的管道的主要优点是能够以Docker镜像的形式带来自己的构建环境。无人机会在运行时自动下载docker镜像。</p>
<h6 id="请注意，Kubernetes管道不是Docker管道的直接替代。配置和运行时行为可能有所不同。"><a href="#请注意，Kubernetes管道不是Docker管道的直接替代。配置和运行时行为可能有所不同。" class="headerlink" title="请注意，Kubernetes管道不是Docker管道的直接替代。配置和运行时行为可能有所不同。"></a>请注意，Kubernetes管道不是Docker管道的直接替代。配置和运行时行为可能有所不同。</h6><p><a target="_blank" rel="noopener" href="https://kube-runner.docs.drone.io/configuration/overview/">https://kube-runner.docs.drone.io/configuration/overview/</a></p>
<h4 id="1-3-SSH管道"><a href="#1-3-SSH管道" class="headerlink" title="1.3  SSH管道"></a>1.3  SSH管道</h4><p>​        使用SSH协议在远程计算机上执行管道命令，需要直接在主机上运行或不太适合在容器内部执行的工作负载很有用。</p>
<p><a target="_blank" rel="noopener" href="https://ssh-runner.docs.drone.io/configuration/overview/">https://ssh-runner.docs.drone.io/configuration/overview/</a></p>
<h3 id="2、Docker与Kubernetes的区别"><a href="#2、Docker与Kubernetes的区别" class="headerlink" title="2、Docker与Kubernetes的区别"></a>2、Docker与Kubernetes的区别</h3><p>Kubernetes管道和Docker管道具有许多相似之处，但不应将它们视为彼此的直接替代。在配置语法和运行时行为方面存在一些显着差异。</p>
<ul>
<li>Kubernetes管道计划在同一Pod中执行，因此共享同一网络。这意味着可以通过<code>localhost</code>地址而不是自定义主机名访问服务。</li>
<li>Kubernetes管道由Kubernetes调度，它提供了高级的亲和力选项。Kubernetes运行器使用该node_selector属性向管道公开节点选择器功能。</li>
<li>Kubernetes容器会自动将服务帐户凭据安装到<code>/var/run/secrets/kubernetes.io/serviceaccount</code>。这可能会带来安全隐患，并可能影响与Kubernetes集成的插件。</li>
</ul>
<h3 id="3、GitLib安装Drone服务器"><a href="#3、GitLib安装Drone服务器" class="headerlink" title="3、GitLib安装Drone服务器"></a>3、GitLib安装Drone服务器</h3><h4 id="3-1创建一个GitLab-OAuth应用程序"><a href="#3-1创建一个GitLab-OAuth应用程序" class="headerlink" title="3.1创建一个GitLab OAuth应用程序"></a>3.1创建一个GitLab OAuth应用程序</h4><p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102105951929.png" alt="image-20200102105951929"></p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102142822011.png" alt="image-20200102142822011"></p>
<h4 id="3-2创建共享秘密"><a href="#3-2创建共享秘密" class="headerlink" title="3.2创建共享秘密"></a>3.2创建共享秘密</h4><p>创建一个共享密钥，以验证跑步者与中央Drone服务器之间的通信。</p>
<p>您可以使用openssl生成共享机密：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -hex 16</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102105012955.png" alt="image-20200102105012955"></p>
<h4 id="3-3启动服务器"><a href="#3-3启动服务器" class="headerlink" title="3.3启动服务器"></a>3.3启动服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --volume&#x3D;&#x2F;var&#x2F;lib&#x2F;drone:&#x2F;data \</span><br><span class="line">  --env&#x3D;DRONE_AGENTS_ENABLED&#x3D;true \</span><br><span class="line">  --env&#x3D;DRONE_GITLAB_SERVER&#x3D;http:&#x2F;&#x2F;gitlab.econage.com \</span><br><span class="line">  --env&#x3D;DRONE_GITLAB_CLIENT_ID&#x3D;b6f0a6323c57da1ade470546b5b3f07817ec12ca4dcc964b626affd0dfbb46e3 \</span><br><span class="line">  --env&#x3D;DRONE_GITLAB_CLIENT_SECRET&#x3D;76b6f5159f158337cd637ff120ff3f15206ad5b3aeb40b6d6da6469c40242dd1 \</span><br><span class="line">  --env&#x3D;DRONE_RPC_SECRET&#x3D;5c2a265111e08953de1028451ae866d7 \</span><br><span class="line">  --env&#x3D;DRONE_SERVER_HOST&#x3D;192.168.10.14 \</span><br><span class="line">  --env&#x3D;DRONE_GIT_ALWAYS_AUTH&#x3D;true \</span><br><span class="line">  --env&#x3D;DRONE_USER_CREATE&#x3D;username:docker,admin:true \</span><br><span class="line">  --env&#x3D;DRONE_SERVER_PROTO&#x3D;http \</span><br><span class="line">  --publish&#x3D;80:80 \</span><br><span class="line">  --restart&#x3D;always \</span><br><span class="line">  --detach&#x3D;true \</span><br><span class="line">  --name&#x3D;drone \</span><br><span class="line">  drone&#x2F;drone</span><br></pre></td></tr></table></figure>
<h4 id="3-4配置"><a href="#3-4配置" class="headerlink" title="3.4配置"></a>3.4配置</h4><ul>
<li>DRONE_GITLAB_CLIENT_ID<br>必需的字符串值提供您的GitLab oauth客户端ID。</li>
<li>DRONE_GITLAB_CLIENT_SECRET<br>必需的字符串值提供您的GitLab oauth客户端密钥。</li>
<li>DRONE_GITLAB_SERVER<br>选项字符串值提供您的GitLab服务器网址。默认值为的gitlab.com服务器地址<a target="_blank" rel="noopener" href="https://gitlab.com./">https://gitlab.com。</a></li>
<li>DRONE_GIT_ALWAYS_AUTH<br>可选的布尔值将Drone配置为在克隆公共存储库时进行身份验证。仅在将自托管的GitLab与私有模式启用一起使用时，才应启用此功能。</li>
<li>DRONE_RPC_SECRET<br>必需的字符串值提供了无人机共享机密。这用于验证到服务器的rpc连接。必须为服务器和代理提供相同的秘密值。</li>
<li>DRONE_SERVER_HOST<br>必需的字符串值提供您的外部主机名或IP地址。如果使用IP地址，则可以包括端口。</li>
<li>DRONE_SERVER_PROTO<br>必需的字符串值提供了您的外部协议方案。此值应设置为http或https。如果您配置ssl或acme，则此字段默认为https。</li>
</ul>
<h3 id="4、安装Docker-Runner"><a href="#4、安装Docker-Runner" class="headerlink" title="4、安装Docker Runner"></a>4、安装Docker Runner</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock \</span><br><span class="line">  -e DRONE_RPC_PROTO&#x3D;http \</span><br><span class="line">  -e DRONE_RPC_HOST&#x3D;192.168.10.14 \</span><br><span class="line">  -e DRONE_RPC_SECRET&#x3D;3ab0479b9718d8337e111796c445eefe \</span><br><span class="line">  -e DRONE_RUNNER_CAPACITY&#x3D;2 \</span><br><span class="line">  -e DRONE_RUNNER_NAME&#x3D;$&#123;HOSTNAME&#125; \</span><br><span class="line">  -p 3000:3000 \</span><br><span class="line">  --restart always \</span><br><span class="line">  --name runner \</span><br><span class="line">  drone&#x2F;drone-runner-docker</span><br></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DRONE_RPC_HOST</span><br></pre></td></tr></table></figure>
<p>提供您的Drone服务器的主机名（和可选端口）。运行程序在主机地址连接到服务器，以接收执行管线。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DRONE_RPC_PROTO</span><br></pre></td></tr></table></figure>
<p>提供用于连接到Drone服务器的协议。该值必须是http或https。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DRONE_RPC_SECRET</span><br></pre></td></tr></table></figure>
<p>提供用于与您的Drone服务器进行身份验证的共享密钥。这必须与您的Drone服务器配置中定义的机密匹配。</p>
<h3 id="5、访问web界面"><a href="#5、访问web界面" class="headerlink" title="5、访问web界面"></a>5、访问web界面</h3><p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102120147875.png" alt="image-20200102120147875"></p>
<p>同意后就能看到界面</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102120321933.png" alt="image-20200102120321933"></p>
<p>设置你想要开启得库</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102134133266.png" alt="image-20200102134133266"></p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102134245163.png" alt="image-20200102134245163"></p>
<p>这里最主要的是需要.drone.yaml文件，下面是应用于K8s集群的yaml文件，由于我们公司环境复杂，所以使用了ssh模块，k8s模块功能比较单一</p>
<p>k8s模块地址：<a target="_blank" rel="noopener" href="http://plugins.drone.io/mactynow/drone-kubernetes/">http://plugins.drone.io/mactynow/drone-kubernetes/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">kind: pipeline</span><br><span class="line">type: docker</span><br><span class="line">name: base</span><br><span class="line"></span><br><span class="line">#主要是缓存maven依赖包，可不用变化，直接使用</span><br><span class="line">steps:</span><br><span class="line">  - name: restore-cache</span><br><span class="line">    image: drillster&#x2F;drone-volume-cache</span><br><span class="line">    settings:</span><br><span class="line">      restore: true</span><br><span class="line">      mount:</span><br><span class="line">        - .&#x2F;repository</span><br><span class="line">    volumes:</span><br><span class="line">      - name: cache</span><br><span class="line">        path: &#x2F;cache</span><br><span class="line">    when:</span><br><span class="line">      event: push     #push事件的时候触发</span><br><span class="line"></span><br><span class="line">  - name: mvn</span><br><span class="line">    image: registry.hello.com&#x2F;maven:3-jdk-8    #harbor仓库maven镜像</span><br><span class="line">    commands:</span><br><span class="line">#maven打包命令，公司使用的是自己的私服，需要指明setting文件地址</span><br><span class="line">    - mvn clean package -Dmaven.test.skip&#x3D;true -Dmaven.repo.local&#x3D;.&#x2F;repository -s &#x2F;root&#x2F;.m2&#x2F;settings.xml</span><br><span class="line">    - mv helloworld&#x2F;target&#x2F;helloworld-*.jar helloworld&#x2F;target&#x2F;app.jar</span><br><span class="line">#改名是为了Dockerfile文件方便构建镜像</span><br><span class="line"></span><br><span class="line">  - name: rebuild-cache</span><br><span class="line">    image: drillster&#x2F;drone-volume-cache</span><br><span class="line">    settings:</span><br><span class="line">      rebuild: true</span><br><span class="line">      mount:</span><br><span class="line">        - .&#x2F;repository</span><br><span class="line">    volumes:</span><br><span class="line">      - name: cache</span><br><span class="line">        path: &#x2F;cache</span><br><span class="line">    when:</span><br><span class="line">      event: push</span><br><span class="line"></span><br><span class="line">  - name: docker-build</span><br><span class="line">    image: docker</span><br><span class="line">    commands:</span><br><span class="line">      - docker login -u admin -p hello.123 registry.hello.com</span><br><span class="line">      - docker build -t registry.hello.com&#x2F;helloworld:$DRONE_COMMIT .&#x2F;helloworld</span><br><span class="line">      - docker push registry.hello.com&#x2F;helloworld:$DRONE_COMMIT</span><br><span class="line">    volumes:</span><br><span class="line">      - name: deamon</span><br><span class="line">        path: &#x2F;var&#x2F;run&#x2F;docker.sock</span><br><span class="line">    when:</span><br><span class="line">      event: push</span><br><span class="line">      branch: [dev]</span><br><span class="line"></span><br><span class="line">  - name: deploy-k8s</span><br><span class="line">    image: appleboy&#x2F;drone-ssh</span><br><span class="line">    settings:</span><br><span class="line">      host: 192.168.0.10    #k8s集群master节点的ip</span><br><span class="line">      username: root</span><br><span class="line">      password:</span><br><span class="line">        from_secret: ssh_password   #在web界面中设置密码</span><br><span class="line">      port: 22</span><br><span class="line">      envs:</span><br><span class="line">        - DRONE_BRANCH</span><br><span class="line">        - DRONE_COMMIT</span><br><span class="line">      script:</span><br><span class="line">#替换deoloy中的镜像</span><br><span class="line">        - kubectl set image deployment&#x2F;helloworld helloworld&#x3D;registry.hello.com&#x2F;helloworld:$DRONE_COMMIT -n $DRONE_BRANCH</span><br><span class="line">    when:</span><br><span class="line">      event: push</span><br><span class="line">      branch: [dev]</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  - name: deamon</span><br><span class="line">    host:</span><br><span class="line">      path: &#x2F;var&#x2F;run&#x2F;docker.sock</span><br><span class="line">  - name: cache</span><br><span class="line">    host:</span><br><span class="line">      path: &#x2F;opt&#x2F;drone&#x2F;cache</span><br></pre></td></tr></table></figure>
<p>支持的变量有：</p>
<p><a target="_blank" rel="noopener" href="https://autoscale.drone.io/reference/">https://autoscale.drone.io/reference/</a></p>
<p>Dockerfile文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM registry.hello.com&#x2F;jdk:1.8_232</span><br><span class="line"></span><br><span class="line">ADD .&#x2F;target&#x2F;app.jar  app.jar</span><br><span class="line"></span><br><span class="line">CMD [&quot;java -jar app.jar -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap&quot;]</span><br></pre></td></tr></table></figure>
<p>设置远程连接k8s中master节点的密钥</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20200102141822239.png" alt="image-20200102141822239"></p>
<p>设置前端node的打包，只需更换打包基础镜像和命令即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: npm</span><br><span class="line">  image: registry.hello.com&#x2F;node:6.11</span><br><span class="line">  commands:</span><br><span class="line">  - npm install --unsafe-perm</span><br><span class="line">  - npm run build</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/K8s%E4%B8%ADPod%E6%97%B6%E9%97%B4%E8%AE%BE%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/K8s%E4%B8%ADPod%E6%97%B6%E9%97%B4%E8%AE%BE%E7%BD%AE/" class="post-title-link" itemprop="url">K8s中Pod时间设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:20:43" itemprop="dateCreated datePublished" datetime="2021-03-16T10:20:43+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/K8s%E4%B8%ADPod%E6%97%B6%E9%97%B4%E8%AE%BE%E7%BD%AE/" class="post-meta-item leancloud_visitors" data-flag-title="K8s中Pod时间设置" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、-时间介绍"><a href="#1、-时间介绍" class="headerlink" title="1、 时间介绍"></a>1、 时间介绍</h3><h4 id="1-1-GMT"><a href="#1-1-GMT" class="headerlink" title="1.1    GMT"></a>1.1    GMT</h4><p>​    格林威治时间。即格林威治所在地的标准时间。</p>
<h4 id="1-2-UTC"><a href="#1-2-UTC" class="headerlink" title="1.2    UTC"></a>1.2    UTC</h4><p>​    世界标准时间（即 GMT）。即：UTC = GMT + 0。容器中的时间就是 UTC。</p>
<h3 id="1-3-CST"><a href="#1-3-CST" class="headerlink" title="1.3    CST"></a>1.3    CST</h3><p>​    中国标准时间。CST = GMT + 8。</p>
<h4 id="1-4-EST"><a href="#1-4-EST" class="headerlink" title="1.4    EST"></a>1.4    EST</h4><p>​    东部时间。EST = GMT - 5。如果当前机子所在时区是纽约，那么日期显示就是 EST。</p>
<h3 id="2、-设置pod时间"><a href="#2、-设置pod时间" class="headerlink" title="2、 设置pod时间"></a>2、 设置pod时间</h3><p>​        通常情况云服务器的时区为世界标准时间，和中国标准时间相差8个小时。</p>
<h4 id="2-1挂在宿主机的时间到容器中"><a href="#2-1挂在宿主机的时间到容器中" class="headerlink" title="2.1挂在宿主机的时间到容器中"></a>2.1挂在宿主机的时间到容器中</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  volumeMounts:</span><br><span class="line">  - mountPath: &#x2F;etc&#x2F;localtime</span><br><span class="line">    name: localtime</span><br><span class="line">volumes:</span><br><span class="line">- hostPath:</span><br><span class="line">    path: &#x2F;etc&#x2F;localtime</span><br><span class="line">    type: &quot;&quot;</span><br><span class="line">  name: localtime</span><br></pre></td></tr></table></figure>
<h4 id="2-2传参到pod中"><a href="#2-2传参到pod中" class="headerlink" title="2.2传参到pod中"></a>2.2传参到pod中</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - env:</span><br><span class="line">    - name: TZ</span><br><span class="line">      value: Asia&#x2F;Shanghai</span><br></pre></td></tr></table></figure>
<h4 id="2-3传参到pod中"><a href="#2-3传参到pod中" class="headerlink" title="2.3传参到pod中"></a>2.3传参到pod中</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - env:</span><br><span class="line">    - name: TZ</span><br><span class="line">      value: CST-8</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/filebeat%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/filebeat%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">filebeat收集K8s日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:17:25" itemprop="dateCreated datePublished" datetime="2021-03-16T10:17:25+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elk/" itemprop="url" rel="index"><span itemprop="name">Elk</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/filebeat%E6%94%B6%E9%9B%86K8s%E6%97%A5%E5%BF%97/" class="post-meta-item leancloud_visitors" data-flag-title="filebeat收集K8s日志" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-filebeat-options.html">https://www.elastic.co/guide/en/beats/filebeat/current/configuration-filebeat-options.html</a></p>
<h3 id="1、Filebeat概述"><a href="#1、Filebeat概述" class="headerlink" title="1、Filebeat概述"></a>1、Filebeat概述</h3><p>​        Filebeat是用于转发和集中日志数据的轻量级传送程序。作为服务器上的代理安装，Filebeat监视您指定的日</p>
<p>志文件或位置，收集日志事件，并将其转发给<a target="_blank" rel="noopener" href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>或 <a target="_blank" rel="noopener" href="https://www.elastic.co/products/logstash">Logstash</a>进行索引。</p>
<p>​        Filebeat的工作方式如下：启动Filebeat时，它将启动一个或多个输入，这些输入将在为日志数据指定的位置</p>
<p>中查找。对于Filebeat所找到的每个日志，Filebeat都会启动收集器。每个收割机都读取单个日志以获取新内容，</p>
<p>并将新日志数据发送到libbeat，libbeat将聚集事件并将聚集的数据发送到为Filebeat配置的输出。</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20191224102720177.png" alt="image-20191224102720177"></p>
<h3 id="2、Filebeat输入类型"><a href="#2、Filebeat输入类型" class="headerlink" title="2、Filebeat输入类型"></a>2、Filebeat输入类型</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html">Log</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-stdin.html">Stdin</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-container.html">Container</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-kafka.html">Kafka</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-redis.html">Redis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-udp.html">UDP</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-docker.html">Docker</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-tcp.html">TCP</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-syslog.html">Syslog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-s3.html">s3</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-netflow.html">NetFlow</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-google-pubsub.html">Google Pub/Sub</a></li>
</ul>
<h3 id="3、在Kubernetes上运行Filebeat"><a href="#3、在Kubernetes上运行Filebeat" class="headerlink" title="3、在Kubernetes上运行Filebeat"></a>3、在Kubernetes上运行Filebeat</h3><p>​        将Filebeat部署为DaemonSet， 以确保集群的每个节点上都有一个正在运行的实例。Docker日志主机文件夹</p>
<p>（/var/lib/docker/containers）安装在Filebeat容器上。Filebeat会开始输入文件，并在文件出现在文件夹中后立</p>
<p>即开始收集它们。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://raw.githubusercontent.com/elastic/beats/7.5/deploy/kubernetes/filebeat-kubernetes.yaml</span><br></pre></td></tr></table></figure>
<h3 id="4、设置"><a href="#4、设置" class="headerlink" title="4、设置"></a>4、设置</h3><p>默认情况下，Filebeat将事件发送到现有的Elasticsearch部署（如果存在）。要指定其他目标，请在清单文件中更</p>
<p>改以下参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">env:</span><br><span class="line">- name: ELASTICSEARCH_HOST</span><br><span class="line">  value: elasticsearch</span><br><span class="line">- name: ELASTICSEARCH_PORT</span><br><span class="line">  value: &quot;9200&quot;</span><br><span class="line">- name: ELASTICSEARCH_USERNAME</span><br><span class="line">  value: elastic</span><br><span class="line">- name: ELASTICSEARCH_PASSWORD</span><br><span class="line">  value: changeme</span><br><span class="line">- name: ELASTIC_CLOUD_ID</span><br><span class="line">  value:</span><br><span class="line">- name: ELASTIC_CLOUD_AUTH</span><br><span class="line">  value:</span><br></pre></td></tr></table></figure>
<p>输出到logstash：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat-config</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: filebeat</span><br><span class="line">data:</span><br><span class="line">  filebeat.yml: |-</span><br><span class="line">    filebeat.config:</span><br><span class="line">      inputs:</span><br><span class="line">        # Mounted &#96;filebeat-inputs&#96; configmap:</span><br><span class="line">        path: $&#123;path.config&#125;&#x2F;inputs.d&#x2F;*.yml</span><br><span class="line">        # Reload inputs configs as they change:</span><br><span class="line">        reload.enabled: false</span><br><span class="line">      modules:</span><br><span class="line">        path: $&#123;path.config&#125;&#x2F;modules.d&#x2F;*.yml</span><br><span class="line">        # Reload module configs as they change:</span><br><span class="line">        reload.enabled: false</span><br><span class="line"></span><br><span class="line">    # To enable hints based autodiscover, remove &#96;filebeat.config.inputs&#96; configuration and uncomment this:</span><br><span class="line">    #filebeat.autodiscover:</span><br><span class="line">    #  providers:</span><br><span class="line">    #    - type: kubernetes</span><br><span class="line">    #      hints.enabled: true</span><br><span class="line"></span><br><span class="line">    processors:</span><br><span class="line">      - add_cloud_metadata:</span><br><span class="line"></span><br><span class="line">    #cloud.id: $&#123;ELASTIC_CLOUD_ID&#125;</span><br><span class="line">    #cloud.auth: $&#123;ELASTIC_CLOUD_AUTH&#125;</span><br><span class="line"></span><br><span class="line">    #output.elasticsearch:</span><br><span class="line">      #hosts: [&#39;$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;&#39;]</span><br><span class="line">      #username: $&#123;ELASTICSEARCH_USERNAME&#125;</span><br><span class="line">      #password: $&#123;ELASTICSEARCH_PASSWORD&#125;</span><br><span class="line">    output.logstash:</span><br><span class="line">      hosts: [&quot;192.168.0.104:5044&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat-inputs</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: filebeat</span><br><span class="line">data:</span><br><span class="line">  kubernetes.yml: |-</span><br><span class="line">    - type: log    #设置类型为log</span><br><span class="line">        paths:</span><br><span class="line">          - &#x2F;var&#x2F;lib&#x2F;docker&#x2F;logs&#x2F;*.log</span><br><span class="line">        #fields:</span><br><span class="line">          #app: k8s</span><br><span class="line">          #type: docker-log</span><br><span class="line">        fields_under_root: true</span><br><span class="line">        json.keys_under_root: true</span><br><span class="line">        json.overwrite_keys: true</span><br><span class="line">        encoding: utf-8</span><br><span class="line">        fields.sourceType: docker-log         #索引名格式</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: filebeat</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: filebeat</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: filebeat</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      containers:</span><br><span class="line">      - name: filebeat</span><br><span class="line">        image: docker.elastic.co&#x2F;beats&#x2F;filebeat:6.5.4       #提前准备好镜像，需要翻墙下载</span><br><span class="line">        args: [</span><br><span class="line">          &quot;-c&quot;, &quot;&#x2F;etc&#x2F;filebeat.yml&quot;,</span><br><span class="line">          &quot;-e&quot;,</span><br><span class="line">        ]</span><br><span class="line">        securityContext:</span><br><span class="line">          runAsUser: 0</span><br><span class="line">          # If using Red Hat OpenShift uncomment this:</span><br><span class="line">          #privileged: true</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;filebeat.yml</span><br><span class="line">          readOnly: true</span><br><span class="line">          subPath: filebeat.yml</span><br><span class="line">        - name: inputs</span><br><span class="line">          mountPath: &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;inputs.d</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;data</span><br><span class="line">        - name: logs</span><br><span class="line">          mountPath: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;logs</span><br><span class="line">          readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          defaultMode: 0600</span><br><span class="line">          name: filebeat-config</span><br><span class="line">      - name: logs</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;logs</span><br><span class="line">      - name: inputs</span><br><span class="line">        configMap:</span><br><span class="line">          defaultMode: 0600</span><br><span class="line">          name: filebeat-inputs</span><br><span class="line">      # data folder stores a registry of read status for all files, so we don&#39;t send everything again on a Filebeat pod restart</span><br><span class="line">      #data文件夹存储所有文件的读取状态的注册表</span><br><span class="line">      - name: data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;lib&#x2F;filebeat-data</span><br><span class="line">          type: DirectoryOrCreate</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: filebeat</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: filebeat</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: filebeat</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - watch</span><br><span class="line">  - list</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: filebeat</span><br></pre></td></tr></table></figure>
<p>运行</p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20191224105720755.png" alt="image-20191224105720755"></p>
<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20191224105648509.png" alt="image-20191224105648509"></p>
<p>能看到上面日志，则表示启动成功。</p>
<h3 id="5、排错"><a href="#5、排错" class="headerlink" title="5、排错"></a>5、排错</h3><p>如果没启动成功，查看logstash的日志，报错如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2019-12-20T19:53:14,049][ERROR][logstash.outputs.elasticsearch] Could not index event to Elasticsearch. &#123;:status&#x3D;&gt;400, :action&#x3D;&gt;[&quot;index&quot;, &#123;:_id&#x3D;&gt;nil, :_index&#x3D;&gt;&quot;dev-%&#123;[fields][sourceType]&#125;-2019-12-20&quot;, :_type&#x3D;&gt;&quot;doc&quot;, :routing&#x3D;&gt;nil&#125;, #&lt;LogStash::Event:0x4c8737db&gt;], :response&#x3D;&gt;&#123;&quot;index&quot;&#x3D;&gt;&#123;&quot;_index&quot;&#x3D;&gt;&quot;dev-%&#123;[fields][sourceType]&#125;-2019-12-20&quot;, &quot;_type&quot;&#x3D;&gt;&quot;doc&quot;, &quot;_id&quot;&#x3D;&gt;nil, &quot;status&quot;&#x3D;&gt;400, &quot;error&quot;&#x3D;&gt;&#123;&quot;type&quot;&#x3D;&gt;&quot;invalid_index_name_exception&quot;, &quot;reason&quot;&#x3D;&gt;&quot;Invalid index name [dev-%&#123;[fields][sourceType]&#125;-2019-12-20], must be lowercase&quot;, &quot;index_uuid&quot;&#x3D;&gt;&quot;_na_&quot;, &quot;index&quot;&#x3D;&gt;&quot;dev-%&#123;[fields][sourceType]&#125;-2019-12-20&quot;&#125;&#125;&#125;&#125;</span><br><span class="line">[2019-12-20T19:53:14,049][ERROR][logstash.outputs.</span><br></pre></td></tr></table></figure>
<p>原因是logstash中output的index不能有大写：</p>
<p>我原来的logstash的conf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">            hosts &#x3D;&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">            index &#x3D;&gt; &#39;%&#123;platform&#125;-%&#123;[fields][sourceType]&#125;-%&#123;+YYYY-MM-dd&#125;&#39;</span><br><span class="line">            template &#x3D;&gt; &quot;&#x2F;opt&#x2F;logstash-6.5.2&#x2F;config&#x2F;af-template.json&quot;</span><br><span class="line">            template_overwrite &#x3D;&gt; true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改后的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">            hosts &#x3D;&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">            index &#x3D;&gt; &quot;k8s-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">            template &#x3D;&gt; &quot;&#x2F;opt&#x2F;logstash-6.5.2&#x2F;config&#x2F;af-template.json&quot;</span><br><span class="line">            template_overwrite &#x3D;&gt; true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完美结束！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/K8s%E8%BF%9E%E6%8E%A5harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/K8s%E8%BF%9E%E6%8E%A5harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">K8s连接harbor私有仓库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:07:24" itemprop="dateCreated datePublished" datetime="2021-03-16T10:07:24+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/K8s%E8%BF%9E%E6%8E%A5harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/" class="post-meta-item leancloud_visitors" data-flag-title="K8s连接harbor私有仓库" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、登录Docker"><a href="#1、登录Docker" class="headerlink" title="1、登录Docker"></a>1、登录Docker</h3><p>通过注册表进行身份验证才能提取私有映像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login  registry.hello.com</span><br></pre></td></tr></table></figure>

<p>出现提示时，输入您的Docker用户名和密码。登录过程将创建或更新config.json包含授权令牌的文件。</p>
<p>查看config.json文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat ~&#x2F;.docker&#x2F;config.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;registry.hello.com&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;YWRtaW46YWRtaW4xMjM&#x3D;&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client&#x2F;18.09.0 (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、根据现有Docker凭证创建密钥"><a href="#2、根据现有Docker凭证创建密钥" class="headerlink" title="2、根据现有Docker凭证创建密钥"></a>2、根据现有Docker凭证创建密钥</h3><p>Kubernetes集群使用Secret docker-registry类型的密钥通过容器注册表进行身份验证以提取私有映像。如果您已</p>
<p>经运行过docker login，则可以将该凭证复制到Kubernetes中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic harbor \    #命名为harbor</span><br><span class="line">    --from-file&#x3D;.dockerconfigjson&#x3D;&#x2F;root&#x2F;.docker&#x2F;config.json \</span><br><span class="line">    --type&#x3D;kubernetes.io&#x2F;dockerconfigjson</span><br></pre></td></tr></table></figure>
<p>如果您需要更多控制权（例如，在新密钥上设置名称空间或标签），则可以在存储密钥之前自定义密钥。</p>
<p>务必：</p>
<p>​    将数据项的名称设置为 .dockerconfigjson</p>
<p>​    base64对docker文件进行编码并粘贴该字符串，将其作为字段的值不间断 data[“.dockerconfigjson”]</p>
<p>​    设置type为kubernetes.io/dockerconfigjson</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS5jbi1oYW5nemhvdS5hbGl5dW5jcy5jb20iOnsicGFzc3dvcmQiOiJFY29uYWdlQGs4cyIsInVzZXJuYW1lIjoiazhzQGVjb25hZ2UifX19</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor</span><br><span class="line">  namespace: default</span><br><span class="line">type: kubernetes.io&#x2F;dockerconfigjson</span><br></pre></td></tr></table></figure>
<p>如果收到错误消息 <code>error: no objects passed to create</code>，这可能意味着 base64 编码的字符串无效。如果您收到的错误类似 <code>Secret &quot;myregistrykey&quot; is invalid: data[.dockerconfigjson]: invalid value ...</code>，这意味着数据已成功地编码为 un-base64，但无法解析为一个 <code>.docker/config.json</code> 文件。</p>
<h3 id="3、在-pod-上引用-imagePullSecrets"><a href="#3、在-pod-上引用-imagePullSecrets" class="headerlink" title="3、在 pod 上引用 imagePullSecrets"></a>3、在 pod 上引用 imagePullSecrets</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">imagePullSecrets:</span><br><span class="line">name: harbor</span><br></pre></td></tr></table></figure>


<p><img src="https://gitee.com/jianshen-bao/blog-img/raw/master//img/image-20191213023009033.png" alt="image-20191213023009033"></p>
<h3 id="4、使用-Docker-配置创建一个-Secret"><a href="#4、使用-Docker-配置创建一个-Secret" class="headerlink" title="4、使用 Docker 配置创建一个 Secret"></a>4、使用 Docker 配置创建一个 Secret</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry myregistrykey \</span><br><span class="line">--docker-server&#x3D;registry.hello.com --docker-username&#x3D;admin \</span><br><span class="line">--docker-password&#x3D;admin123</span><br></pre></td></tr></table></figure>
<p>Pod 只能引用它们自己命名空间中的镜像拉取 secret，因此，每个命名空间都需要完成一次此过程</p>
<h3 id="5、应用场景"><a href="#5、应用场景" class="headerlink" title="5、应用场景"></a>5、应用场景</h3><p>有许多配置私有仓库的解决方案。以下是一些常见的用例和建议的解决方案。</p>
<p>​    1.集群只运行非专有（例如，开放源码）镜像。不需要隐藏镜像。在 Docker hub 上使用公共镜像</p>
<ul>
<li>​            不需要配置。</li>
<li>​            在 GCE 或 GKE 上，自动使用本地镜像来提高速度和可用性。</li>
</ul>
<p>​    2.集群运行一些私有镜像，这些镜像应该对公司以外用户进行隐藏，但对所有集群用户都是可见的。</p>
<ul>
<li>​            使用托管的 Docker 仓库。它可能托管在 Docker Hub 上，或其它地方。像上面描述的那样在每个节点上手动配置 .docker/config.json。</li>
<li>​            或者，在防火墙后面运行内部私有仓库，并打开读取访问权限。不需要 Kubernetes 配置。</li>
<li>​            或者，在 GCE 或 GKE 上，使用项目的 Google 容器仓库。与手动节点配置相比，集群自动伸缩会更好地工作。</li>
<li>​            或者，在更改节点配置不方便的集群上，使用 imagePullSecrets。</li>
</ul>
<p>​    3.拥有专有镜像的集群，其中一些需要更严格的访问控制。</p>
<ul>
<li>​            确保 AlwaysPullImages 准入控制器 打开。否则，所有 pod 都可能访问所有的镜像。</li>
<li>​            将敏感数据移动到 “Secret” 资源中，而不是将其打包到镜像中。</li>
</ul>
<p>​    4.多租户集群，每个租户都需要自己的私有仓库。</p>
<ul>
<li>​            确保 AlwaysPullImages 准入控制器 打开。否则，所有 pod 都可能访问所有的镜像。</li>
<li>​            运行需要授权的私有仓库。为每个租户生成仓库凭证，将其转换为 secret，并将 secret 填充到每个租户命名空间。</li>
<li>​            租户将该 secret 添加到每个命名空间的 imagePullSecrets 中。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/Kubeadm%E9%83%A8%E7%BD%B2Kubernetes1-14-1%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/16/Kubeadm%E9%83%A8%E7%BD%B2Kubernetes1-14-1%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Kubeadm部署Kubernetes1.14.1集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-16 10:03:58" itemprop="dateCreated datePublished" datetime="2021-03-16T10:03:58+08:00">2021-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
    <span id="/2021/03/16/Kubeadm%E9%83%A8%E7%BD%B2Kubernetes1-14-1%E9%9B%86%E7%BE%A4/" class="post-meta-item leancloud_visitors" data-flag-title="Kubeadm部署Kubernetes1.14.1集群" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、环境说明"><a href="#一、环境说明" class="headerlink" title="一、环境说明"></a><strong>一、环境说明</strong></h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>角色</th>
<th>系统</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-node-1</td>
<td>192.168.120.128</td>
<td>k8s-master</td>
<td>Centos7.6</td>
</tr>
<tr>
<td>k8s-node-2</td>
<td>192.168.120.129</td>
<td>k8s-node</td>
<td>Centos7.6</td>
</tr>
<tr>
<td>k8s-node-3</td>
<td>192.168.120.130</td>
<td>k8s-node</td>
<td>Centos7.6</td>
</tr>
</tbody></table>
<p>注意：官方建议每台机器至少双核2G内存，同时需确保MAC和product_uuid唯一（参考下面的命令查看）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip link</span><br><span class="line">cat &#x2F;sys&#x2F;class&#x2F;dmi&#x2F;id&#x2F;product_uuid</span><br></pre></td></tr></table></figure>
<h2 id="二、环境配置"><a href="#二、环境配置" class="headerlink" title="二、环境配置"></a><strong>二、环境配置</strong></h2><p><strong>以下命令在三台主机上均需运行</strong></p>
<h3 id="1、设置阿里云yum源（可选）"><a href="#1、设置阿里云yum源（可选）" class="headerlink" title="1、设置阿里云yum源（可选）"></a><strong>1、设置阿里云yum源（可选）</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">rm -rf /var/cache/yum &amp;&amp; yum makecache &amp;&amp; yum -y update &amp;&amp; yum -y autoremove</span><br></pre></td></tr></table></figure>
<h3 id="2、安装依赖包"><a href="#2、安装依赖包" class="headerlink" title="2、安装依赖包"></a><strong>2、安装依赖包</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release conntrack ipvsadm ipset jq sysstat curl iptables libseccomp</span><br></pre></td></tr></table></figure>
<p><strong>3、关闭防火墙</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="4、关闭SELinux"><a href="#4、关闭SELinux" class="headerlink" title="4、关闭SELinux"></a><strong>4、关闭SELinux</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h3 id="5、关闭-swap-分区"><a href="#5、关闭-swap-分区" class="headerlink" title="5、关闭 swap 分区"></a><strong>5、关闭 swap 分区</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>
<h3 id="6、加载内核模块"><a href="#6、加载内核模块" class="headerlink" title="6、加载内核模块"></a><strong>6、加载内核模块</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">modprobe -- br_netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure>
<h3 id="7、设置内核参数"><a href="#7、设置内核参数" class="headerlink" title="7、设置内核参数"></a><strong>7、设置内核参数</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.ipv6.conf.all.disable_ipv6=1</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>
<h3 id="8、安装Docker"><a href="#8、安装Docker" class="headerlink" title="8、安装Docker"></a><strong>8、安装Docker</strong></h3><p>1、首先卸载旧版：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">           docker-client \</span><br><span class="line">           docker-client-latest \</span><br><span class="line">           docker-common \</span><br><span class="line">           docker-latest \</span><br><span class="line">           docker-latest-logrotate \</span><br><span class="line">           docker-logrotate \</span><br><span class="line">           docker-selinux \</span><br><span class="line">           docker-engine-selinux \</span><br><span class="line">           docker-engine</span><br></pre></td></tr></table></figure>
<p>2、安装依赖包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>
<p>3、设置安装源（阿里云）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<p>4、启用测试库（可选）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --enable docker-ce-edge</span><br><span class="line">yum-config-manager --enable docker-ce-test</span><br></pre></td></tr></table></figure>
<p>5、安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br><span class="line">yum install -y docker-ce-18.09.6</span><br></pre></td></tr></table></figure>
<p>6、启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<p>Docker建议配置阿里云镜像加速</p>
<p>安装完成后配置启动时的命令，否则docker会将iptables FORWARD chain的默认策略设置为DROP</p>
<p>另外Kubeadm建议将systemd设置为cgroup驱动，所以还要修改daemon.json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;13i ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT&quot; /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://bk6kzfqm.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> overlay2也是一个联合目录挂载文件系统</span></span><br></pre></td></tr></table></figure>
<h3 id="9、安装kubeadm和kubelet"><a href="#9、安装kubeadm和kubelet" class="headerlink" title="9、安装kubeadm和kubelet"></a><strong>9、安装kubeadm和kubelet</strong></h3><p>配置源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line">systemctl enable kubelet</span><br><span class="line"></span><br><span class="line">vim /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">设置kubelet的cgroup driver</span></span><br><span class="line">KUBELET_KUBECONFIG_ARGS=--cgroup-driver=systemd</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br></pre></td></tr></table></figure>
<h3 id="10、拉取所需镜像"><a href="#10、拉取所需镜像" class="headerlink" title="10、拉取所需镜像"></a><strong>10、拉取所需镜像</strong></h3><p>先从阿里云拉取所需的镜像，不然会从谷歌拉取，导致拉取失败。</p>
<p>拉取镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list | sed -e &#x27;s/^/docker pull /g&#x27; -e &#x27;s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/google_containers#g&#x27; | sh -x</span><br><span class="line">docker images | grep registry.cn-hangzhou.aliyuncs.com/google_containers | awk &#x27;&#123;print &quot;docker tag&quot;,$1&quot;:&quot;$2,$1&quot;:&quot;$2&#125;&#x27; | sed -e &#x27;s/registry.cn-hangzhou.aliyuncs.com\/google_containers/k8s.gcr.io/2&#x27; | sh -x</span><br><span class="line">docker images | grep registry.cn-hangzhou.aliyuncs.com/google_containers | awk &#x27;&#123;print &quot;docker rmi &quot;&quot;&quot;$1&quot;&quot;&quot;:&quot;&quot;&quot;$2&#125;&#x27; | sh -x</span><br></pre></td></tr></table></figure>
<h2 id="三、初始化集群"><a href="#三、初始化集群" class="headerlink" title="三、初始化集群"></a><em>三、初始化集群</em></h2><p>以下命令如无特殊说明，均在k8s-node-1上执行</p>
<h3 id="1、使用kubeadm-init初始化集群（注意修改最后为本机IP）"><a href="#1、使用kubeadm-init初始化集群（注意修改最后为本机IP）" class="headerlink" title="1、使用kubeadm init初始化集群（注意修改最后为本机IP）"></a><strong>1、使用kubeadm init初始化集群（注意修改最后为本机IP）</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --kubernetes-version=v1.14.3 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --apiserver-advertise-address=192.168.120.128</span><br></pre></td></tr></table></figure>
<p>初始化成功后会输出类似下面的加入命令，暂时无需运行，先记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.120.128:6443 --token duz8m8.njvafly3p2jrshfx --discovery-token-ca-cert-hash sha256:60e15ba0f562a9f29124914a1540bd284e021a37ebdbcea128f4e257e25002db</span><br></pre></td></tr></table></figure>
<h3 id="2、为需要使用kubectl的用户进行配置"><a href="#2、为需要使用kubectl的用户进行配置" class="headerlink" title="2、为需要使用kubectl的用户进行配置"></a><strong>2、为需要使用kubectl的用户进行配置</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p>检查集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure>
<h3 id="3、安装Pod-Network（使用七牛云镜像）"><a href="#3、安装Pod-Network（使用七牛云镜像）" class="headerlink" title="3、安装Pod Network（使用七牛云镜像）"></a><strong>3、安装Pod Network（使用七牛云镜像）</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -o kube-flannel.yml https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">sed -i &quot;s/quay.io\/coreos\/flannel/quay-mirror.qiniu.com\/coreos\/flannel/g&quot; kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line">rm -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>使用下面的命令确保所有的Pod都处于Running状态，可能要等到许久。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide</span><br></pre></td></tr></table></figure>
<h3 id="4、向Kubernetes集群中添加Node节点"><a href="#4、向Kubernetes集群中添加Node节点" class="headerlink" title="4、向Kubernetes集群中添加Node节点"></a><strong>4、向Kubernetes集群中添加Node节点</strong></h3><p>在k8s-node-2和k8s-node-3上运行之前在k8s-node-1输出的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.120.128:6443 --token duz8m8.njvafly3p2jrshfx --discovery-token-ca-cert-hash sha256:60e15ba0f562a9f29124914a1540bd284e021a37ebdbcea128f4e257e25002db</span><br></pre></td></tr></table></figure>
<p>查看集群中的节点状态，可能要等等许久才Ready</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<h3 id="5、kube-proxy开启ipvs"><a href="#5、kube-proxy开启ipvs" class="headerlink" title="5、kube-proxy开启ipvs"></a><strong>5、kube-proxy开启ipvs</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap kube-proxy -n kube-system -o yaml &gt; kube-proxy-configmap.yaml</span><br><span class="line">sed -i &#x27;s/mode: &quot;&quot;/mode: &quot;ipvs&quot;/&#x27; kube-proxy-configmap.yaml</span><br><span class="line">kubectl apply -f kube-proxy-configmap.yaml</span><br><span class="line">rm -f kube-proxy-configmap.yaml</span><br><span class="line">kubectl get pod -n kube-system | grep kube-proxy | awk &#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/20/elasticsearch%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7rally/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/01/20/elasticsearch%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7rally/" class="post-title-link" itemprop="url">elasticsearch性能测试工具rally</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-20 11:01:15" itemprop="dateCreated datePublished" datetime="2021-01-20T11:01:15+08:00">2021-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elk/" itemprop="url" rel="index"><span itemprop="name">Elk</span></a>
        </span>
    </span>

  
    <span id="/2021/01/20/elasticsearch%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7rally/" class="post-meta-item leancloud_visitors" data-flag-title="elasticsearch性能测试工具rally" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、esrally功能：es的性能测试工具"><a href="#1、esrally功能：es的性能测试工具" class="headerlink" title="1、esrally功能：es的性能测试工具"></a>1、esrally功能：es的性能测试工具</h2><p>esrally不支持windows版本，目前只支持Linux和Mac OS。</p>
<h3 id="1-1-依赖环境"><a href="#1-1-依赖环境" class="headerlink" title="1.1 依赖环境"></a>1.1 依赖环境</h3><p>Install Python 3.8+ including <code>pip3</code>, git 1.9+ and an appropriate JDK to run ElasticsearchBe sure that <code>JAVA_HOME</code> points to that JDK</p>
<h3 id="1-2安装Python3"><a href="#1-2安装Python3" class="headerlink" title="1.2安装Python3"></a>1.2安装Python3</h3><p>官网： <a target="_blank" rel="noopener" href="https://www.python.org/downloads/source/">https://www.python.org/downloads/source/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc make cmake zlib-devel bzip2 bzip2-devel readline-devel sqlite sqlite-devel openssl-devel xz xz-devel libffi-devel</span><br><span class="line">tar xvf Python-3.8.5.tgz</span><br><span class="line">.&#x2F;configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">python3 -V</span><br><span class="line"></span><br><span class="line">#卸载python</span><br><span class="line">rpm -qa|grep python|xargs rpm -ev --allmatches --nodeps ##强制删除已安装程序及其关联</span><br><span class="line">whereis python |xargs rm -frv ##删除所有残余文件 ##xargs，允许你对输出执行其他某些命令</span><br><span class="line">whereis python ##验证删除，返回无结果</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806113743822.png" alt="image-20200806113743822"></p>
<h3 id="1-3安装pip3"><a href="#1-3安装pip3" class="headerlink" title="1.3安装pip3"></a>1.3安装pip3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#首先安装setuptools</span><br><span class="line">wget --no-check-certificate  https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;4f&#x2F;20&#x2F;b97449e107801263cf6df2eceaeed290ee63262ac2c6f736df6964a90879&#x2F;setuptools-49.2.1.zip</span><br><span class="line"></span><br><span class="line">unzip setuptools-49.2.1.zip</span><br><span class="line">cd setuptools-49.2.1&#x2F;</span><br><span class="line">python3 setup.py build</span><br><span class="line">python3 setup.py install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget  --no-check-certificate  https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;68&#x2F;1a&#x2F;8cfcf3a8cba0dd0f125927c986b1502f2eed284c63fdfd6797ea74300ae4&#x2F;pip-20.2.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar xvf pip-20.2.1.tar.gz</span><br><span class="line">cd pip-20.2.1&#x2F;</span><br><span class="line">python3 setup.py build</span><br><span class="line">python3 setup.py install</span><br><span class="line">pip3 -V</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806114132939.png" alt="image-20200806114132939"></p>
<h3 id="1-4安装git"><a href="#1-4安装git" class="headerlink" title="1.4安装git"></a>1.4安装git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖</span><br><span class="line">yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc perl-ExtUtils-MakeMaker</span><br><span class="line">wget https:&#x2F;&#x2F;mirrors.edge.kernel.org&#x2F;pub&#x2F;software&#x2F;scm&#x2F;git&#x2F;git-2.8.0.tar.gz</span><br><span class="line">tar xvf git-2.8.0.tar.gz</span><br><span class="line">cd git-2.8.0&#x2F;</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;profile</span><br><span class="line">export PATH&#x3D;$PATH:&#x2F;root&#x2F;git-2.8.0&#x2F;bin</span><br><span class="line"></span><br><span class="line">source &#x2F;etc&#x2F;profile</span><br></pre></td></tr></table></figure>
<p>环境准备完毕</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806142208386.png" alt="image-20200806142208386"></p>
<h2 id="2、安装Rally"><a href="#2、安装Rally" class="headerlink" title="2、安装Rally"></a>2、安装Rally</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install esrally</span><br></pre></td></tr></table></figure>
<p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR: THESE PACKAGES DO NOT MATCH THE HASHES FROM THE REQUIREMENTS FILE. If you have updated the package versions, please update the hashes. Otherwise, examine the package contents carefully; someone may have tampered with them.</span><br><span class="line">    esrally from https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;84&#x2F;b6&#x2F;b4ff1889355508c78ed34c7772a84b3b54b1fcbf62d2f8433d4f0eb0f6a4&#x2F;esrally-2.0.1-py3-none-any.whl#sha256&#x3D;e12c735f7058d555835daa58a8a7dd27f1ad8575ad18052ac3d864c6cd6766d8:</span><br><span class="line">        Expected sha256 e12c735f7058d555835daa58a8a7dd27f1ad8575ad18052ac3d864c6cd6766d8</span><br><span class="line">             Got        bba4f1907942fec7284bc8d099d1881b0a5b2ba87631e289240b086fb2cef9e0</span><br></pre></td></tr></table></figure>
<p>解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --user --upgrade pip</span><br></pre></td></tr></table></figure>
<p>再次执行安装</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806134605060.png" alt="image-20200806134605060"></p>
<h2 id="3、配置"><a href="#3、配置" class="headerlink" title="3、配置"></a>3、配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esrally configure                #首次配置 检测环境</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806153619205.png" alt="image-20200806153619205"></p>
<p>3.1 track介绍</p>
<p>​        默认使用的track是geonames 。track 是赛道的意思，在这里是指压测用的数据和测试策略。esrally 自带的track都在 github 上，地址在这里 <a target="_blank" rel="noopener" href="https://github.com/elastic/rally-tracks%E3%80%82%E5%9C%A8%E8%AF%A5">https://github.com/elastic/rally-tracks。在该</a> repository 中，有很多测试数据，比如 geonames、geopoint、logging、nested 等，每个数据文件夹中的 README.md 中有详细的数据介绍，而 track.json 便是压测策略的定义文件。</p>
<p>​        附上esrally本身自带的数据集：主要用来压力测试的数据。默认测试就是选择geonames数据</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806170040030.png" alt="image-20200806170040030"></p>
<p>这里的需求很简单，需要测试的是现有集群，所以使用pipeline方式，官方自带的数据样本必须要安装git ,然后下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esrally  --target-hosts&#x3D;127.0.0.1:9200  --pipeline&#x3D;benchmark-only  --track&#x3D;percolator        #测试远端的集群。更换IP即可</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806170202853.png" alt="image-20200806170202853"></p>
<p>成功截图，很长截取了最后部分</p>
<p><strong><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200806170302756.png" alt="image-20200806170302756"></strong></p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/52155481">https://blog.csdn.net/laoyang360/article/details/52155481</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/elastic/rally">https://github.com/elastic/rally</a></p>
<p><a target="_blank" rel="noopener" href="https://esrally.readthedocs.io/en/latest/quickstart.html">https://esrally.readthedocs.io/en/latest/quickstart.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/20/Linux%E5%AE%89%E8%A3%85elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/01/20/Linux%E5%AE%89%E8%A3%85elasticsearch/" class="post-title-link" itemprop="url">Linux安装elasticsearch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-20 10:55:58" itemprop="dateCreated datePublished" datetime="2021-01-20T10:55:58+08:00">2021-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elk/" itemprop="url" rel="index"><span itemprop="name">Elk</span></a>
        </span>
    </span>

  
    <span id="/2021/01/20/Linux%E5%AE%89%E8%A3%85elasticsearch/" class="post-meta-item leancloud_visitors" data-flag-title="Linux安装elasticsearch" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、准备Java环境"><a href="#1、准备Java环境" class="headerlink" title="1、准备Java环境"></a>1、准备Java环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tar xvf jdk-8u231-linux-x64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">mv jdk1.8.0_231 java</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;profile.d&#x2F;java</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;java</span><br><span class="line">export PATH&#x3D;$JAVA_HOME&#x2F;bin:$PATH</span><br><span class="line"></span><br><span class="line">source &#x2F;etc&#x2F;profile.d&#x2F;java</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>
<h2 id="2、安装es"><a href="#2、安装es" class="headerlink" title="2、安装es"></a>2、安装es</h2><h3 id="2-1-创建用户和数据存放目录"><a href="#2-1-创建用户和数据存放目录" class="headerlink" title="2.1 创建用户和数据存放目录"></a>2.1 创建用户和数据存放目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useradd elk</span><br><span class="line">passwd elk</span><br><span class="line">mkdir &#x2F;opt&#x2F;esdata</span><br><span class="line">chown -R elk:elk &#x2F;opt&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="2-2配置系统参数"><a href="#2-2配置系统参数" class="headerlink" title="2.2配置系统参数"></a>2.2配置系统参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br><span class="line"></span><br><span class="line">elk hard nofile 65536</span><br><span class="line">elk soft nofile 65536</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line">vm.max_map_count &#x3D; 655360</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="2-3安装es"><a href="#2-3安装es" class="headerlink" title="2.3安装es"></a>2.3安装es</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">tar xvf elasticsearch-6.5.3.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line"></span><br><span class="line">vim jvm.options</span><br><span class="line"></span><br><span class="line">-Xms8g</span><br><span class="line">-Xmx8g     #实际内存的50%</span><br><span class="line"></span><br><span class="line">vim elasticsearch.yml</span><br><span class="line"></span><br><span class="line">cluster.name: elk    #集群模式这里必须相同</span><br><span class="line">node.name: elk01</span><br><span class="line"># 自定义属性添加到节点上</span><br><span class="line">node.attr.rack: r1</span><br><span class="line"></span><br><span class="line">node.master: true</span><br><span class="line">#node.voting_only: true</span><br><span class="line">node.data: true</span><br><span class="line">#node.ingest: true</span><br><span class="line">#node.ml: false</span><br><span class="line">#开启监控xpack</span><br><span class="line">xpack.monitoring.enabled: true</span><br><span class="line">#机器学习关闭</span><br><span class="line">xpack.ml.enabled: false</span><br><span class="line"># 是否使用http协议对外提供服务，默认为true，开启</span><br><span class="line">#http.enabled: true</span><br><span class="line"></span><br><span class="line">cluster.remote.connect: false</span><br><span class="line">path.data: &#x2F;data01&#x2F;elasticsearch&#x2F;lib</span><br><span class="line">path.logs: &#x2F;data01&#x2F;elasticsearch&#x2F;logs</span><br><span class="line">#锁定物理内存地址，防止es内存被交换出去，也就是避免es使用swap交换分区，频繁的交换，会导致IOPS变高</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 192.168.88.128</span><br><span class="line">http.port: 9200</span><br><span class="line">##discovery.zen.ping.unicast.hosts旧版配置</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.88.128&quot;,&quot;192.168.99.92&quot;,&quot;192.168.99.93&quot;]</span><br><span class="line">#Elasticsearch7新增参数，写入候选主节点的设备地址，来开启服务时就可以被选为主节点</span><br><span class="line">cluster.initial_master_nodes: [&quot;192.168.88.128&quot;,&quot;192.168.99.92&quot;,&quot;192.168.99.93&quot;]</span><br><span class="line"># 设置集群中N个节点启动时进行数据恢复，默认为1。</span><br><span class="line">gateway.recover_after_nodes: 1</span><br><span class="line">#设置是否可以通过正则或者_all删除或者关闭索引</span><br><span class="line">action.destructive_requires_name: true</span><br><span class="line">discovery.zen.minimum_master_nodes: 1   #node.master数量&#x2F;2+1</span><br><span class="line">indices.fielddata.cache.size: 20%     #内存回收机制</span><br><span class="line"></span><br><span class="line">network.tcp.no_delay: true</span><br><span class="line">network.tcp.keep_alive: true</span><br><span class="line">network.tcp.reuse_address: true</span><br><span class="line">network.tcp.send_buffer_size: 128mb</span><br><span class="line">network.tcp.receive_buffer_size: 128mb</span><br><span class="line">#transport.tcp.port: 9301</span><br><span class="line">transport.tcp.compress: true</span><br><span class="line">http.max_content_length: 200mb</span><br><span class="line">#开启跨域访问</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"></span><br><span class="line">cluster.fault_detection.leader_check.interval: 15s</span><br><span class="line">discovery.cluster_formation_warning_timeout: 30s</span><br><span class="line">cluster.join.timeout: 120s</span><br><span class="line">cluster.publish.timeout: 90s</span><br><span class="line">cluster.routing.allocation.cluster_concurrent_rebalance: 16</span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries: 16</span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries: 16</span><br><span class="line"></span><br><span class="line">#6&#x2F;5新增</span><br><span class="line">thread_pool.write.size: 5</span><br><span class="line">thread_pool.write.queue_size: 400</span><br><span class="line">thread_pool.search.size: 7</span><br><span class="line">thread_pool.search.queue_size: 300</span><br><span class="line">thread_pool.search.min_queue_size: 5</span><br><span class="line">thread_pool.search.max_queue_size: 500</span><br><span class="line">thread_pool.search.auto_queue_frame_size: 1000</span><br><span class="line">thread_pool.search.target_response_time: 3s</span><br></pre></td></tr></table></figure>
<p>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#调整index的merge过程的并发度</span><br><span class="line">curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_all&#x2F;_settings?preserve_existing&#x3D;true&#39; -d &#39;&#123;&quot;index.merge.scheduler.max_thread_count&quot; : &quot;1&quot;&#125;&#39;</span><br><span class="line"></span><br><span class="line">#提高refresh的时间间隔，降低系统开销</span><br><span class="line">curl -H &quot;Content-Type: application&#x2F;json&quot; -XPUT &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_all&#x2F;_settings?preserve_existing&#x3D;true&#39; -d &#39;&#123;&quot;index.refresh_interval&quot; : &quot;30s&quot;&#125;&#39;</span><br><span class="line"></span><br><span class="line">#查看es集群状态</span><br><span class="line">curl &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_cluster&#x2F;health?pretty&#39;</span><br><span class="line"></span><br><span class="line">#查看es所有索引</span><br><span class="line">curl &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_cat&#x2F;indices?v&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看集群所在磁盘的分配状况</span><br><span class="line">curl &#39;http:&#x2F;&#x2F;127.0.0.1:9200&#x2F;_cat&#x2F;allocation?v&#39;</span><br><span class="line">#分片数（shards）:集群中各节点的分片数相同</span><br><span class="line">#索引所占空间（disk.indices）:该节点中所有索引在该磁盘所点的空间。</span><br><span class="line">#磁盘使用容量（disk.used）:已经使用空间</span><br><span class="line">#磁盘可用容量（disk.avail）:可用空间</span><br><span class="line">#磁盘总容量（disk.total）:总共容量</span><br><span class="line">#磁盘便用率（disk.percent）:磁盘使用率</span><br><span class="line"></span><br><span class="line">#查看节点信息</span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;localhost:9200&#x2F;_cat&#x2F;nodes?v&amp;pretty&quot;</span><br><span class="line"></span><br><span class="line">#查看分片信息</span><br><span class="line">curl -XGET &quot;http:&#x2F;&#x2F;localhost:9200&#x2F;_cat&#x2F;shards?v&amp;pretty&quot;</span><br><span class="line"></span><br><span class="line">#查看集群静态信息</span><br><span class="line">curl -XGET &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_cluster&#x2F;stats?pretty&#x3D;true&#39;</span><br><span class="line"></span><br><span class="line">#删除索引</span><br><span class="line">curl -XDELETE &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;app-2019.05,app-2019.05&#39;</span><br><span class="line"></span><br><span class="line">#查询es当前线程</span><br><span class="line">curl -XGET &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;_nodes&#x2F;stats&#x2F;thread_pool?pretty&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3、-logstash调优"><a href="#3、-logstash调优" class="headerlink" title="3、 logstash调优"></a>3、 logstash调优</h2><p>​    当batch.size增大，es处理的事件数就会变少，写入也就越快了。具体的worker/output.workers数量建议等于CPU数，batch.size/batch.delay根据实际的数据量逐渐增大来测试最优值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pipeline.workers: 24</span><br><span class="line">pipeline.output.workers: 24</span><br><span class="line">pipeline.batch.size: 10000</span><br><span class="line">pipeline.batch.delay: 10</span><br></pre></td></tr></table></figure>
<p>配置参考：<a target="_blank" rel="noopener" href="https://www.iteye.com/blog/shihlei-2418651">https://www.iteye.com/blog/shihlei-2418651</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/20/logstash%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bb.jpg">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/01/20/logstash%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2/" class="post-title-link" itemprop="url">logstash字符转换</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-01-20 10:53:32" itemprop="dateCreated datePublished" datetime="2021-01-20T10:53:32+08:00">2021-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Elk/" itemprop="url" rel="index"><span itemprop="name">Elk</span></a>
        </span>
    </span>

  
    <span id="/2021/01/20/logstash%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2/" class="post-meta-item leancloud_visitors" data-flag-title="logstash字符转换" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>项目需求</p>
<p>request_time， upstream_response_time 等的数据类型需要改为float</p>
<h2 id="1、nginx配置json格式日志"><a href="#1、nginx配置json格式日志" class="headerlink" title="1、nginx配置json格式日志"></a>1、nginx配置json格式日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format json &#39;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#39;</span><br><span class="line">                     &#39;&quot;server_addr&quot;:&quot;$server_addr&quot;,&#39;</span><br><span class="line">                     &#39;&quot;remote_addr&quot;:&quot;$remote_addr&quot;,&#39;</span><br><span class="line">                     &#39;&quot;cookie_JSESSIONID&quot;:&quot;$cookie_JSESSIONID&quot;,&#39;</span><br><span class="line">                     &#39;&quot;body_bytes_sent&quot;:$body_bytes_sent,&#39;</span><br><span class="line">                     &#39;&quot;request_uri&quot;:&quot;$request_uri&quot;,&#39;</span><br><span class="line">                     &#39;&quot;request_method&quot;:&quot;$request_method&quot;,&#39;</span><br><span class="line">                     &#39;&quot;server_protocol&quot;:&quot;$server_protocol&quot;,&#39;</span><br><span class="line">                     &#39;&quot;scheme&quot;:&quot;$scheme&quot;,&#39;</span><br><span class="line">                     &#39;&quot;request_time&quot;:$request_time,&#39;</span><br><span class="line">                     &#39;&quot;upstream_response_time&quot;:&quot;$upstream_response_time&quot;,&#39;</span><br><span class="line">                     &#39;&quot;upstream_addr&quot;:&quot;$upstream_addr&quot;,&#39;</span><br><span class="line">                     &#39;&quot;hostname&quot;:&quot;$hostname&quot;,&#39;</span><br><span class="line">                     &#39;&quot;http_host&quot;:&quot;$http_host&quot;,&#39;</span><br><span class="line">                     &#39;&quot;uri&quot;:&quot;$uri&quot;,&#39;</span><br><span class="line">                     &#39;&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,&#39;</span><br><span class="line">                     &#39;&quot;http_referer&quot;:&quot;$http_referer&quot;,&#39;</span><br><span class="line">                     &#39;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#39;</span><br><span class="line">                     &#39;&quot;X-Forwarded-Proto&quot;:&quot;$http_x_forwarded_proto&quot;,&#39;</span><br><span class="line">                     &#39;&quot;cookie&quot;:&quot;$http_cookie&quot;,&#39;</span><br><span class="line">                     &#39;&quot;status&quot;:&quot;$status&quot;&#125;&#39;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        access_log  logs&#x2F;pc.access.log  json;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2、filebeat收集日志"><a href="#2、filebeat收集日志" class="headerlink" title="2、filebeat收集日志"></a>2、filebeat收集日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - &#x2F;data&#x2F;nginx&#x2F;*.log</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.overwrite_keys: true</span><br><span class="line">  encoding: utf-8</span><br><span class="line">  fields:</span><br><span class="line">    document_type: nginx_access_log</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;localhost:5044&quot;]</span><br><span class="line"></span><br><span class="line">#输出到es中</span><br><span class="line">#output.elasticsearch:</span><br><span class="line">#  hosts: [&quot;192.168.1.30:9200&quot;]</span><br><span class="line">#  index: &quot;nginx-%&#123;+YYYY-MM-dd&#125;&quot;</span><br><span class="line">#setup.template.name: &quot;access&quot;</span><br><span class="line">#setup.template.pattern: &quot;access-*&quot;</span><br></pre></td></tr></table></figure>
<h2 id="3、logstash配置"><a href="#3、logstash配置" class="headerlink" title="3、logstash配置"></a>3、logstash配置</h2><p>需java环境</p>
<p>配置startup.options文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LS_HOME&#x3D;&#x2F;opt&#x2F;logstash-6.5.3</span><br><span class="line">LS_SETTINGS_DIR&#x3D;&quot;$&#123;LS_HOME&#125;&#x2F;config&quot;</span><br><span class="line">LS_OPTS&#x3D;&quot;--path.settings $&#123;LS_SETTINGS_DIR&#125;&quot;</span><br><span class="line">LS_PIDFILE&#x3D;&#x2F;var&#x2F;run&#x2F;logstash.pid</span><br><span class="line">LS_USER&#x3D;elk</span><br><span class="line">LS_GROUP&#x3D;elk</span><br><span class="line">LS_GC_LOG_FILE&#x3D;&#x2F;opt&#x2F;logstash-6.5.3&#x2F;logs&#x2F;gc.log</span><br><span class="line">LS_OPEN_FILES&#x3D;16384</span><br><span class="line">LS_NICE&#x3D;19</span><br><span class="line">SERVICE_NAME&#x3D;&quot;logstash&quot;</span><br><span class="line">SERVICE_DESCRIPTION&#x3D;&quot;logstash&quot;</span><br></pre></td></tr></table></figure>
<p>配置template_nginxlog.json模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;index_patterns&quot; : [&quot;nginx-*&quot;],</span><br><span class="line"></span><br><span class="line">  &quot;version&quot; : 60001,</span><br><span class="line"></span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line"></span><br><span class="line">    &quot;index.refresh_interval&quot; : &quot;5s&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &quot;mappings&quot; : &#123;</span><br><span class="line"></span><br><span class="line">    &quot;_doc&quot; : &#123;</span><br><span class="line"></span><br><span class="line">      &quot;dynamic_templates&quot; : [ &#123;</span><br><span class="line"></span><br><span class="line">        &quot;message_field&quot; : &#123;</span><br><span class="line"></span><br><span class="line">          &quot;path_match&quot; : &quot;message&quot;,</span><br><span class="line"></span><br><span class="line">          &quot;match_mapping_type&quot; : &quot;string&quot;,</span><br><span class="line"></span><br><span class="line">          &quot;mapping&quot; : &#123;</span><br><span class="line"></span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line"></span><br><span class="line">            &quot;norms&quot; : false</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;, &#123;</span><br><span class="line"></span><br><span class="line">        &quot;string_fields&quot; : &#123;</span><br><span class="line"></span><br><span class="line">          &quot;match&quot; : &quot;*&quot;,</span><br><span class="line"></span><br><span class="line">          &quot;match_mapping_type&quot; : &quot;string&quot;,</span><br><span class="line"></span><br><span class="line">          &quot;mapping&quot; : &#123;</span><br><span class="line"></span><br><span class="line">            &quot;type&quot; : &quot;text&quot;, &quot;norms&quot; : false,</span><br><span class="line"></span><br><span class="line">            &quot;fields&quot; : &#123;</span><br><span class="line"></span><br><span class="line">              &quot;keyword&quot; : &#123; &quot;type&quot;: &quot;keyword&quot;, &quot;ignore_above&quot;: 2048 &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; ],</span><br><span class="line"></span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line"></span><br><span class="line">        &quot;@timestamp&quot;: &#123; &quot;type&quot;: &quot;date&quot;&#125;,</span><br><span class="line"></span><br><span class="line">        &quot;@version&quot;: &#123; &quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class="line"></span><br><span class="line">        &quot;geoip&quot;  : &#123;</span><br><span class="line"></span><br><span class="line">          &quot;dynamic&quot;: true,</span><br><span class="line"></span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line"></span><br><span class="line">            &quot;ip&quot;: &#123; &quot;type&quot;: &quot;ip&quot; &#125;,</span><br><span class="line"></span><br><span class="line">            &quot;location&quot; : &#123; &quot;type&quot; : &quot;geo_point&quot; &#125;,</span><br><span class="line"></span><br><span class="line">            &quot;latitude&quot; : &#123; &quot;type&quot; : &quot;half_float&quot; &#125;,</span><br><span class="line"></span><br><span class="line">            &quot;longitude&quot; : &#123; &quot;type&quot; : &quot;half_float&quot; &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写conf配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port &#x3D;&gt; 5044</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  if [fields][document_type] &#x3D;&#x3D; &quot;nginx_access_log&quot; &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      gsub &#x3D;&gt; [&quot;message&quot;, &quot;\\x&quot;, &quot;\\\x&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    json &#123;</span><br><span class="line">      source &#x3D;&gt; &quot;message&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if &quot;-&quot; in [upstream_response_time] &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        replace &#x3D;&gt; &#123;</span><br><span class="line">          &quot;upstream_response_time&quot; &#x3D;&gt; &quot;0&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">      convert &#x3D;&gt; [ &quot;upstream_response_time&quot;, &quot;float&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      gsub &#x3D;&gt; [</span><br><span class="line">        &quot;cookie&quot;, &quot;\\x22&quot;, &#39;&quot;&#39;</span><br><span class="line">      ]</span><br><span class="line">      gsub &#x3D;&gt; [</span><br><span class="line">        &quot;cookie&quot;, &quot;\\x0A&quot;, &quot;\n&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [fields][document_type] &#x3D;&#x3D; &quot;nginx_access_log&quot; &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; [&quot;192.168.1.30:9200&quot;]</span><br><span class="line">    index &#x3D;&gt; &#39;nginx-%&#123;+YYYY-MM-dd&#125;&#39;</span><br><span class="line">    template &#x3D;&gt; &quot;&#x2F;opt&#x2F;logstash-6.5.3&#x2F;config&#x2F;template_nginxlog.json&quot;</span><br><span class="line">    #template_name &#x3D;&gt; &quot;nginxlog&quot;</span><br><span class="line">    template_overwrite &#x3D;&gt; true</span><br><span class="line">    document_type &#x3D;&gt; &quot;_doc&quot;   #es报错文件格式不匹配</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>es报错信息，文件格式不匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to put mappings on indices [[[nginx-2020-11-18&#x2F;ueZB7rY1QPilUWjk3S9ykg]]], type [doc]java.lang.IllegalArgumentException: Rejecting mapping update to [nginx-2020-11-18] as the final mapping would have more than 1 type: [_doc, doc]</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">羊皮裘老头</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
<!--
-->

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":null,"app_key":null,"server_url":null,"security":true}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<!-- calendar widget -->
{% if theme.CloudCalendar.enable %}
    <script src="{{ theme.CloudCalendar.calendarCdn }}"></script>
    <script src="{{ theme.CloudCalendar.langCdn }}"></script>
    <script>
    $(function() {
        $('#CloudCalendar').aCalendar('{{ theme.CloudCalendar.language }}',
            $.extend(
                '', {
                    single:{{ theme.CloudCalendar.single }},
                    root:'{{ theme.CloudCalendar.root }}'
                }
            )
        );
    });
    </script>
{% endif %}

</body>
</html>
