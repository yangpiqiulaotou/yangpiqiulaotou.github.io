<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="羊皮裘老头">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="羊皮裘老头">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="羊皮裘老头">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>羊皮裘老头</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">羊皮裘老头</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">28</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">116</span></a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">羊皮裘老头</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/01/Jenkins%E6%9E%84%E5%BB%BA%E6%97%B6%E9%80%89%E6%8B%A9Git%E5%88%86%E6%94%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/01/Jenkins%E6%9E%84%E5%BB%BA%E6%97%B6%E9%80%89%E6%8B%A9Git%E5%88%86%E6%94%AF/" class="post-title-link" itemprop="url">Jenkins构建时选择Git分支</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-01 15:16:48" itemprop="dateCreated datePublished" datetime="2021-04-01T15:16:48+08:00">2021-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、安装Git-Parameter插件"><a href="#1、安装Git-Parameter插件" class="headerlink" title="1、安装Git Parameter插件"></a>1、安装<a target="_blank" rel="noopener" href="https://wiki.jenkins-ci.org/display/JENKINS/Git+Parameter+Plugin">Git Parameter</a>插件</h2><p>在系统管理中的插件管理下载Git Parameter，下图是我已经安装</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210401150031254.png" alt="image-20210401150031254"></p>
<h2 id="2、配置参数化构建"><a href="#2、配置参数化构建" class="headerlink" title="2、配置参数化构建"></a>2、配置参数化构建</h2><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210401150709595.png" alt="image-20210401150709595"></p>
<p>在源代码库选择分支中使用变量接收</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210401150908867.png" alt="image-20210401150908867"></p>
<p>点击构建项目就能选择特性分支进行构建</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210401151022235.png" alt="image-20210401151022235"></p>
<p><strong>备注：如果配置了自动化构建，默认拉取的是master分支的代码！</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/01/Rancher%E5%AE%95%E6%9C%BA%E5%90%8E%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A5%E7%AE%A1K8s%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/01/Rancher%E5%AE%95%E6%9C%BA%E5%90%8E%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A5%E7%AE%A1K8s%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Rancher宕机后命令行接管K8s集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-01 15:15:05" itemprop="dateCreated datePublished" datetime="2021-04-01T15:15:05+08:00">2021-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Rancher/" itemprop="url" rel="index"><span itemprop="name">Rancher</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>​        使用rancher创建的k8s集群，当rancher的UI宕机不能访问后，不能接续使用<code>kubectl</code>接管集群，从 Rancher v2.2.2 开始，从 Rancher UI 创建的集群默认开启<code>授权集群访问地址</code>。创建好集群后 Rancher UI 生成的 kubecfg 文件中将显示多个 master 节点 IP 对应的 <code>server</code>。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210331142119003.png" alt="image-20210331142119003"></p>
<h2 id="1、命令行访问集群"><a href="#1、命令行访问集群" class="headerlink" title="1、命令行访问集群"></a>1、命令行访问集群</h2><p>​        自行下载好kubectl文件，在.kube/config中配置好集群访问地址。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210331142403423.png" alt="image-20210331142403423"></p>
<p>在命令行查看</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210331142458066.png" alt="image-20210331142458066"></p>
<h2 id="2、切换server控制端"><a href="#2、切换server控制端" class="headerlink" title="2、切换server控制端"></a>2、切换server控制端</h2><p>查看集群可使用的context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config view</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20210331142807728.png" alt="image-20210331142807728"></p>
<p>查看现在集群默认使用的context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config current-context</span><br></pre></td></tr></table></figure>
<p>通过context：name来切换，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context  test-docker2</span><br></pre></td></tr></table></figure>
<p>即可实现rancher宕机后也可继续接管集群了。</p>
<h2 id="3、未保存kubeconfig文件"><a href="#3、未保存kubeconfig文件" class="headerlink" title="3、未保存kubeconfig文件"></a>3、未保存kubeconfig文件</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.xtplayer.cn/rancher/restore-kubecfg/">https://www.xtplayer.cn/rancher/restore-kubecfg/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/gitlab%E4%BD%BF%E7%94%A8minio%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/gitlab%E4%BD%BF%E7%94%A8minio%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" class="post-title-link" itemprop="url">gitlab使用minio实现分布式存储</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:25:17" itemprop="dateCreated datePublished" datetime="2021-03-25T11:25:17+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:33" itemprop="dateModified" datetime="2022-04-17T17:07:33+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、分布式优势"><a href="#1、分布式优势" class="headerlink" title="1、分布式优势"></a>1、分布式优势</h2><h3 id="1-minio分布式介绍"><a href="#1-minio分布式介绍" class="headerlink" title="1.minio分布式介绍"></a>1.minio分布式介绍</h3><p>​        分布式模式下的MinIO使您可以将多个驱动器（甚至在不同的计算机上）合并到一个对象存储服务器中。由于驱动器分布在多个节点上，因此分布式MinIO可以承受多个节点故障，但仍可以确保完整的数据保护。</p>
<p>​        分布式模式下的MinIO可以帮助您通过单个对象存储部署来设置高可用性存储系统。借助分布式MinIO，无论存储设备在网络中的位置如何，您都可以最佳地使用存储设备。</p>
<h3 id="2-数据保护"><a href="#2-数据保护" class="headerlink" title="2.数据保护"></a>2.数据保护</h3><p>​        分布式MinIO 使用擦除代码提供针对多个节点/驱动器故障和位腐烂的保护。由于分布式MinIO所需的最小磁盘为4（与擦除编码所需的最小磁盘相同），因此在启动分布式MinIO时，擦除代码会自动启动。</p>
<h3 id="3-高可用性"><a href="#3-高可用性" class="headerlink" title="3.高可用性"></a>3.高可用性</h3><p>​        如果托管磁盘的服务器脱机，则独立的MinIO服务器将关闭。相反，只要n / 2个或更多磁盘在线，具有n个磁盘的分布式MinIO设置将使您的数据安全。不过，您至少需要（n / 2 + 1）个法定磁盘来创建新对象。</p>
<p>例如，即使最多有8台服务器处于脱机状态，一个16节点的分布式MinIO设置（每个节点具有16个磁盘）仍可继续提供文件。但是，您至少需要在线9台服务器才能创建新对象。</p>
<h3 id="4-限度"><a href="#4-限度" class="headerlink" title="4.限度"></a>4.限度</h3><p>​        与独立模式下的MinIO一样，分布式MinIO的每个租户限制为最少2个，最多32个服务器。这些服务器上的磁盘数量没有限制。如果您需要多租户设置，则可以轻松启动由协调工具（如Kubernetes，Docker Swarm等）管理的多个MinIO实例。</p>
<p>​        请注意，使用分布式MinIO，只要遵守限制，就可以处理节点和驱动器的数量。例如，您可以有2个节点，每个节点4个驱动器，4个节点每个4个驱动器，8个节点每个2个驱动器，32个服务器每个64个驱动器，依此类推。</p>
<h3 id="5-一致性保证"><a href="#5-一致性保证" class="headerlink" title="5.一致性保证"></a>5.一致性保证</h3><p>​        MinIO遵循严格的读后写和列表后读 /一致性模型的所有输入输出都在分布式和独立模式操作。</p>
<h2 id="2、使用Helm-Chart部署MinIO"><a href="#2、使用Helm-Chart部署MinIO" class="headerlink" title="2、使用Helm Chart部署MinIO"></a>2、使用Helm Chart部署MinIO</h2><p>前提条件：</p>
<p>​    1.一个k8s集群</p>
<p>​    2.具备helm环境</p>
<h3 id="1-部署minio"><a href="#1-部署minio" class="headerlink" title="1.部署minio"></a>1.部署minio</h3><p>创建minio需要的pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#vim  pv1.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: minio-pv1</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  -  ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &#x2F;helm&#x2F;minio&#x2F;pv1</span><br></pre></td></tr></table></figure>
<p>在此使用的是hostpath，在worker节点创建相应的目录。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212211059077.png" alt="image-20191212211059077"></p>
<h3 id="2-安装minio"><a href="#2-安装minio" class="headerlink" title="2.安装minio"></a>2.安装minio</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#先拉到本地在安装</span><br><span class="line">helm  pull  stable&#x2F;minio</span><br><span class="line">tar  -zxvf  minio-3.0.4.tgz</span><br><span class="line">helm  install  minio  .&#x2F;minio</span><br><span class="line"></span><br><span class="line">#或者直接安装</span><br><span class="line">helm  install  minio  stable&#x2F;minio</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212211624813.png" alt="image-20191212211624813"></p>
<p>查看pod状态</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212212110685.png" alt="image-20191212212110685"></p>
<h3 id="3-登录访问minio"><a href="#3-登录访问minio" class="headerlink" title="3.登录访问minio"></a>3.登录访问minio</h3><p>默认参数：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/1576157102(1)_%E7%9C%8B%E5%9B%BE%E7%8E%8B_%E7%9C%8B%E5%9B%BE%E7%8E%8B.png"></p>
<p>访问web界面</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212213046502.png" alt="image-20191212213046502"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212213103278.png" alt="image-20191212213103278"></p>
<p>access Key和secret Key都是默认的，上图配置中</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212213237181.png" alt="image-20191212213237181"></p>
<h2 id="3、gitlab和minio进行关联"><a href="#3、gitlab和minio进行关联" class="headerlink" title="3、gitlab和minio进行关联"></a>3、gitlab和minio进行关联</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy minio -oyaml    查看关联Key</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212213506646.png" alt="image-20191212213506646"></p>
<p>在gitlab的yaml文件中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deploy gitlab-gitlab-ce</span><br><span class="line"></span><br><span class="line">- name: MINIO_ACCESS_KEY</span><br><span class="line">  valueFrom:</span><br><span class="line">    secretKeyRef:</span><br><span class="line">      key: accesskey</span><br><span class="line">      name: minio</span><br><span class="line">- name: MINIO_SECRET_KEY</span><br><span class="line">  valueFrom:</span><br><span class="line">     secretKeyRef:</span><br><span class="line">       key: secretkey</span><br><span class="line">       name: minio</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212213738745.png" alt="image-20191212213738745"></p>
<p>查看到状态正常</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212214106629.png" alt="image-20191212214106629"></p>
<p>登录gitlab创建一个文件</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212222659865.png" alt="image-20191212222659865"></p>
<p>删除原来的pod</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212223057279.png" alt="image-20191212223057279"></p>
<p>gitlab的pod启动时间有点长，等启动完成访问界面可以看到</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191212223514760.png" alt="image-20191212223514760"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/helm3%E4%BD%BF%E7%94%A8minio%E8%87%AA%E5%BB%BA%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/helm3%E4%BD%BF%E7%94%A8minio%E8%87%AA%E5%BB%BA%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">helm3使用minio自建仓库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:24:11" itemprop="dateCreated datePublished" datetime="2021-03-25T11:24:11+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、helm3存储库更改"><a href="#1、helm3存储库更改" class="headerlink" title="1、helm3存储库更改"></a>1、helm3存储库更改</h3><p>​    在Helm 2中，默认情况下包括稳定的图表存储库。在Helm 3中，默认情况下不包含任何存储库。因此需要做的第一件事就是添加一个存储库。官方图表存储库将在有限的时间内继续接收补丁，但是将不再作为默认存储库包含在Helm客户端中。</p>
<h3 id="2、minio介绍"><a href="#2、minio介绍" class="headerlink" title="2、minio介绍"></a>2、minio介绍</h3><p>​    MinIO 是一个基于Apache License  v2.0开源协议的对象存储服务。它兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等，而一个对象文件可以是任意大小，从几kb到最大5T不等。</p>
<p>​    MinIO是一个非常轻量的服务,可以很简单的和其他应用的结合，类似 NodeJS, Redis 或者 MySQL。</p>
<h3 id="3、安装minio服务端和客户端"><a href="#3、安装minio服务端和客户端" class="headerlink" title="3、安装minio服务端和客户端"></a>3、安装minio服务端和客户端</h3><h4 id="3-1使用容器安装服务端"><a href="#3-1使用容器安装服务端" class="headerlink" title="3.1使用容器安装服务端"></a>3.1使用容器安装服务端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio&#x2F;minio</span><br><span class="line">docker run -p 9000:9000 minio&#x2F;minio server &#x2F;data</span><br></pre></td></tr></table></figure>
<h4 id="3-2使用二进制安装服务端"><a href="#3-2使用二进制安装服务端" class="headerlink" title="3.2使用二进制安装服务端"></a>3.2使用二进制安装服务端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget  https:&#x2F;&#x2F;dl.min.io&#x2F;server&#x2F;minio&#x2F;release&#x2F;linux-amd64&#x2F;minio</span><br><span class="line">chmod +x minio</span><br><span class="line">mkdir  -p  &#x2F;chart</span><br><span class="line">.&#x2F;minio server &#x2F;chart</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130171343371.png" alt="image-20191130171343371"></p>
<p>访问Browser Access地址：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130171714286.png" alt="image-20191130171714286"></p>
<p>在启动日志中获取access  key和secret  key</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130171906111.png" alt="image-20191130171906111"></p>
<p>看到这个页面则表示登陆成功</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130172024345.png" alt="image-20191130172024345"></p>
<p>至此服务端部署完成。</p>
<h3 id="4、安装minio客户端"><a href="#4、安装minio客户端" class="headerlink" title="4、安装minio客户端"></a>4、安装minio客户端</h3><h4 id="1-使用容器安装客户端"><a href="#1-使用容器安装客户端" class="headerlink" title="1.使用容器安装客户端"></a>1.使用容器安装客户端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio&#x2F;mc</span><br><span class="line">docker run minio&#x2F;mc ls play</span><br></pre></td></tr></table></figure>
<h4 id="2-使用二进制安装客户端"><a href="#2-使用二进制安装客户端" class="headerlink" title="2.使用二进制安装客户端"></a>2.使用二进制安装客户端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget  https:&#x2F;&#x2F;dl.min.io&#x2F;client&#x2F;mc&#x2F;release&#x2F;linux-amd64&#x2F;mc</span><br><span class="line">chmod +x mc</span><br><span class="line">.&#x2F;mc</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130172613972.png" alt="image-20191130172613972"></p>
<h4 id="3-连接至服务端"><a href="#3-连接至服务端" class="headerlink" title="3.连接至服务端"></a>3.连接至服务端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mc config host add myminio http:&#x2F;&#x2F;172.17.0.1:9000 XH2LCA4AJIP52RDB4P5M CDDCuoS2FNsdW8S0bodkcs2729N+TH5lFov+rrT3</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130172936479.png" alt="image-20191130172936479"></p>
<p>服务端启动时候的access  key和secret  key</p>
<h4 id="4-mc的shell使用别名"><a href="#4-mc的shell使用别名" class="headerlink" title="4.mc的shell使用别名"></a>4.mc的shell使用别名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls&#x3D;&#39;mc ls&#39;</span><br><span class="line">cp&#x3D;&#39;mc cp&#39;</span><br><span class="line">cat&#x3D;&#39;mc cat&#39;</span><br><span class="line">mkdir&#x3D;&#39;mc mb&#39;</span><br><span class="line">pipe&#x3D;&#39;mc pipe&#39;</span><br><span class="line">find&#x3D;&#39;mc find&#39;</span><br></pre></td></tr></table></figure>
<h4 id="5-创建bucket"><a href="#5-创建bucket" class="headerlink" title="5.创建bucket"></a>5.创建bucket</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mc mb myminio&#x2F;minio-helm-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130173348740.png" alt="image-20191130173348740"></p>
<h4 id="6-设置bucket和objects匿名访问"><a href="#6-设置bucket和objects匿名访问" class="headerlink" title="6.设置bucket和objects匿名访问"></a>6.设置bucket和objects匿名访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mc policy set download myminio&#x2F;minio-helm-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130173746863.png" alt="image-20191130173746863"></p>
<h4 id="7-helm创建与仓库连接的index-yaml文件"><a href="#7-helm创建与仓库连接的index-yaml文件" class="headerlink" title="7.helm创建与仓库连接的index.yaml文件"></a>7.helm创建与仓库连接的index.yaml文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;root&#x2F;helm&#x2F;repo</span><br><span class="line">helm repo index helm&#x2F;repo&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="5、helm与minio仓库进行连接"><a href="#5、helm与minio仓库进行连接" class="headerlink" title="5、helm与minio仓库进行连接"></a>5、helm与minio仓库进行连接</h3><h4 id="1-将index-yaml文件推送到backet中去"><a href="#1-将index-yaml文件推送到backet中去" class="headerlink" title="1.将index.yaml文件推送到backet中去"></a>1.将index.yaml文件推送到backet中去</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mc cp helm&#x2F;repo&#x2F;index.yaml myminio&#x2F;minio-helm-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174336894.png" alt="image-20191130174336894"></p>
<h4 id="2-helm连接私仓"><a href="#2-helm连接私仓" class="headerlink" title="2.helm连接私仓"></a>2.helm连接私仓</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add fengnan http:&#x2F;&#x2F;192.168.0.119:9000&#x2F;minio-helm-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174456212.png" alt="image-20191130174456212"></p>
<h4 id="3-更新repo仓库"><a href="#3-更新repo仓库" class="headerlink" title="3.更新repo仓库"></a>3.更新repo仓库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174603525.png" alt="image-20191130174603525"></p>
<h4 id="4-查看repo"><a href="#4-查看repo" class="headerlink" title="4.查看repo"></a>4.查看repo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174649812.png" alt="image-20191130174649812"></p>
<h5 id="5-查看repo中的文件"><a href="#5-查看repo中的文件" class="headerlink" title="5.查看repo中的文件"></a>5.查看repo中的文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mc ls myminio&#x2F;minio-helm-repo</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174754911.png" alt="image-20191130174754911"></p>
<h4 id="6-登录服务端web界面查看"><a href="#6-登录服务端web界面查看" class="headerlink" title="6.登录服务端web界面查看"></a>6.登录服务端web界面查看</h4><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191130174845497.png" alt="image-20191130174845497"></p>
<p>完美结束！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/helm3%E5%AE%89%E8%A3%85gitlab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/helm3%E5%AE%89%E8%A3%85gitlab/" class="post-title-link" itemprop="url">helm3安装gitlab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:22:52" itemprop="dateCreated datePublished" datetime="2021-03-25T11:22:52+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、添加helm源"><a href="#1、添加helm源" class="headerlink" title="1、添加helm源"></a>1、添加helm源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable https:&#x2F;&#x2F;kubernetes-charts.storage.googleapis.com</span><br><span class="line">helm repo add aliyun https:&#x2F;&#x2F;kubernetes.oss-cn-hangzhou.aliyuncs.com&#x2F;charts</span><br><span class="line">helm repo add  apphub https:&#x2F;&#x2F;apphub.aliyuncs.com&#x2F;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208143345136.png" alt="image-20191208143345136"></p>
<h3 id="2、下载gitlab-ce"><a href="#2、下载gitlab-ce" class="headerlink" title="2、下载gitlab-ce"></a>2、下载gitlab-ce</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm pull stable&#x2F;gitlab-ce</span><br><span class="line">tar  -zxvf  gitlab-ce-0.2.2.tgz</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208162422584.png" alt="image-20191208162422584"></p>
<h3 id="3、修改values-yaml文件"><a href="#3、修改values-yaml文件" class="headerlink" title="3、修改values.yaml文件"></a>3、修改values.yaml文件</h3><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208164650121.png" alt="image-20191208164650121"></p>
<h3 id="4、安装"><a href="#4、安装" class="headerlink" title="4、安装"></a>4、安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install gitlab gitlab-ce</span><br></pre></td></tr></table></figure>
<p>备注：由于我是最新16.3的集群，所以这里会报错。如果你是16以下的版本这里不会报错</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208162724007.png" alt="image-20191208162724007"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; gitlab-ce | grep deployment</span><br><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; gitlab-ce | grep deploy | xargs sed -i &#39;s#extensions&#x2F;v1beta1#apps&#x2F;v1#g&#39;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208162849870.png" alt="image-20191208162849870"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在进行安装，错误原因是现有 k8s不支持gitlab-ce的deployment spec</span><br><span class="line">helm install gitlab gitlab-ce</span><br><span class="line">grep -irl &quot;apps&#x2F;v1&quot; gitlab-ce | grep deployment</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163017603.png" alt="image-20191208163017603"></p>
<p>依次修改配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim gitlab-ce&#x2F;templates&#x2F;deployment.yaml</span><br><span class="line">添加：</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; template &quot;gitlab-ce.fullname&quot; . &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208164344044.png" alt="image-20191208164344044"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim gitlab-ce&#x2F;charts&#x2F;postgresql&#x2F;templates&#x2F;deployment.yaml</span><br><span class="line">添加：</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; template &quot;postgresql.fullname&quot; . &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208164456496.png" alt="image-20191208164456496"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim gitlab-ce&#x2F;charts&#x2F;redis&#x2F;templates&#x2F;deployment.yaml</span><br><span class="line">添加：</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; template &quot;redis.fullname&quot; . &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208164543666.png" alt="image-20191208164543666"></p>
<p>再进行安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install gitlab gitlab-ce</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163321853.png" alt="image-20191208163321853"></p>
<h3 id="5、查看集群状态"><a href="#5、查看集群状态" class="headerlink" title="5、查看集群状态"></a>5、查看集群状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163410784.png" alt="image-20191208163410784"></p>
<p>由于资源需要请求pv，所以我们还需要创建pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pv</span><br><span class="line">kubectl get pvc</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163548128.png" alt="image-20191208163548128"></p>
<p>在worker节点创建hostpath挂在目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir  -p  &#x2F;data&#x2F;gitlab&#x2F;pv&#123;1..4&#125;</span><br></pre></td></tr></table></figure>
<p>在master节点创建pv文件</p>
<ul>
<li><pre><code>[root@node1 pv]# cat pv1.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-pv1
spec:
  capacity:
    storage: 10Gi
  volumeMode: Filesystem
  accessModes:

  -  ReadWriteOnce
     persistentVolumeReclaimPolicy: Retain
       hostPath:
     path: /data/gitlab/pv1</code></pre>
</li>
</ul>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163829783.png" alt="image-20191208163829783"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163904286.png" alt="image-20191208163904286"></p>
<p>再查看集群状态</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208163957511.png" alt="image-20191208163957511"></p>
<p>登录界面</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191208164012158.png" alt="image-20191208164012158"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/helm3%E5%AE%89%E8%A3%85harbor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/helm3%E5%AE%89%E8%A3%85harbor/" class="post-title-link" itemprop="url">helm3安装harbor</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:21:22" itemprop="dateCreated datePublished" datetime="2021-03-25T11:21:22+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、下载并修改"><a href="#1、下载并修改" class="headerlink" title="1、下载并修改"></a>1、下载并修改</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add harbor https:&#x2F;&#x2F;helm.goharbor.io</span><br><span class="line"></span><br><span class="line">helm pull harbor&#x2F;harbor --version 1.2.3</span><br></pre></td></tr></table></figure>
<p>修改values.yaml文件</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218094113775.png" alt="image-20191218094113775"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218095431741.png" alt="image-20191218095431741"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218094043836.png" alt="image-20191218094043836"></p>
<h2 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm install harbor .&#x2F;harbor</span><br><span class="line"></span><br><span class="line">Error: unable to build kubernetes objects from release manifest: unable to recognize &quot;&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#x2F;v1beta1&quot;</span><br></pre></td></tr></table></figure>
<p>由于我是最新版的k8s集群，所以不支持version “extensions/v1beta1”，下面修改版本为apps</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; harbor | grep deployment</span><br><span class="line"></span><br><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; harbor | grep deploy | xargs sed -i &#39;s#extensions&#x2F;v1beta1#apps&#x2F;v1#g&#39;</span><br></pre></td></tr></table></figure>
<p>再次执行安装</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218094627633.png" alt="image-20191218094627633"></p>
<p>服务需要请求pv，所以这里我们使用hostPath来创建pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor-pv1</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  -  ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &#x2F;helm&#x2F;harbor&#x2F;pv1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218094806015.png" alt="image-20191218094806015"></p>
<h2 id="3、访问web界面"><a href="#3、访问web界面" class="headerlink" title="3、访问web界面"></a>3、访问web界面</h2><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218095238237.png" alt="image-20191218095238237"></p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218095454993.png" alt="image-20191218095454993"></p>
<p>使用用户密码登录胡发现登录不了。我们查看pod日志会发现</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218095756759.png" alt="image-20191218095756759"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs harbor-harbor-redis-0</span><br><span class="line"></span><br><span class="line">1:M 18 Dec 02:00:08.032 * 10 changes in 300 seconds. Saving...</span><br><span class="line">1:M 18 Dec 02:00:08.033 * Background saving started by pid 97</span><br><span class="line">97:C 18 Dec 02:00:08.033 # Failed opening the RDB file dump.rdb (in server root dir &#x2F;var&#x2F;lib&#x2F;redis) for saving: Permission denied</span><br><span class="line">1:M 18 Dec 02:00:08.133 # Background saving error</span><br></pre></td></tr></table></figure>
<p>由于redis请求的pv权限不够</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pvc   #查看绑定的pv是主机的路径，然后给与777的权限即可</span><br><span class="line">chmod 777 &#x2F;helm&#x2F;harbor&#x2F;pv4&#x2F;</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218100454712.png" alt="image-20191218100454712"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs harbor-harbor-clair-c9757f6cb-9x8nr</span><br><span class="line"></span><br><span class="line">&#123;&quot;Event&quot;:&quot;could not download Oracle&#39;s update list&quot;,&quot;Level&quot;:&quot;error&quot;,&quot;Location&quot;:&quot;oracle.go:162&quot;,&quot;Time&quot;:&quot;2019-12-18 01:54:54.608195&quot;,&quot;error&quot;:&quot;Get https:&#x2F;&#x2F;linux.oracle.com&#x2F;oval&#x2F;com.oracle.elsa-20161292.xml: read tcp 10.244.2.34:35278-\u003e23.63.35.142:443: read: connection reset by peer&quot;&#125;</span><br><span class="line">&#123;&quot;Event&quot;:&quot;an error occured when fetching update&quot;,&quot;Level&quot;:&quot;error&quot;,&quot;Location&quot;:&quot;updater.go:246&quot;,&quot;Time&quot;:&quot;2019-12-18 01:54:54.609261&quot;,&quot;error&quot;:&quot;could not download requested resource&quot;,&quot;updater name&quot;:&quot;oracle&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>将pod删除，自动生成即可</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218101344298.png" alt="image-20191218101344298"></p>
<p>再次根据设置的密码登录，我这里是admin/admin12345</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191218101451910.png" alt="image-20191218101451910"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/helm3%E5%AE%89%E8%A3%85nexus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/helm3%E5%AE%89%E8%A3%85nexus/" class="post-title-link" itemprop="url">helm3安装nexus</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:20:11" itemprop="dateCreated datePublished" datetime="2021-03-25T11:20:11+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、环境介绍"><a href="#1、环境介绍" class="headerlink" title="1、环境介绍"></a>1、环境介绍</h3><p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216191648008.png" alt="image-20191216191648008"></p>
<h3 id="2、安装nexus"><a href="#2、安装nexus" class="headerlink" title="2、安装nexus"></a>2、安装nexus</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm search repo nexus</span><br><span class="line">helm  pull  stable&#x2F;sonatype-nexus</span><br><span class="line">tar  xvf  sonatype-nexus-1.21.2.tgz</span><br><span class="line">helm  install  nexus  .&#x2F;sonatype-nexus</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216192002575.png" alt="image-20191216192002575"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  get  pod</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216192102750.png" alt="image-20191216192102750"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod nexus-sonatype-nexus-79b5865bbc-4lb49</span><br></pre></td></tr></table></figure>
<p>从而得知在请求pvc，所以创建pv</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim  pv.yaml    #这里采用的hostpath</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: nexus-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  -  ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &#x2F;helm&#x2F;nexus</span><br><span class="line"></span><br><span class="line">mkdir  -p  &#x2F;helm&#x2F;nexus   #在worker节点创建相应的目录</span><br><span class="line">kubecel  apply  -f pv.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216192605851.png" alt="image-20191216192605851"></p>
<p>查看pod状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216193256502.png" alt="image-20191216193256502"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs nexus-sonatype-nexus-64c75f5786-gtvlg</span><br><span class="line"></span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: Cannot open file &#x2F;nexus-data&#x2F;log&#x2F;jvm.log due to No such file or directory</span><br><span class="line">Warning:  Cannot open log file: &#x2F;nexus-data&#x2F;log&#x2F;jvm.log</span><br><span class="line">Warning:  Forcing option -XX:LogFile&#x3D;&#x2F;tmp&#x2F;jvm.log</span><br><span class="line">Unable to update instance pid: Unable to create directory &#x2F;nexus-data&#x2F;instances</span><br><span class="line">&#x2F;nexus-data&#x2F;log&#x2F;karaf.log (No such file or directory)</span><br><span class="line">Unable to update instance pid: Unable to create directory &#x2F;nexus-data&#x2F;instances</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216193340495.png" alt="image-20191216193340495"></p>
<p>从而得知是目录/nexus-data/instances没有权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy nexus-sonatype-nexus -oyaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216193530490.png" alt="image-20191216193530490"></p>
<p>是因为我们创建的pv没有权限，在worker节点给与刚才创建pv的目录777权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 &#x2F;helm&#x2F;nexus&#x2F;</span><br><span class="line">kubectl delete pod nexus-sonatype-nexus-64c75f5786-gtvlg   #删掉原来的pod</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216193918028.png" alt="image-20191216193918028"></p>
<p>完美起来了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216194009883.png" alt="image-20191216194009883"></p>
<p>然后会发现端口不通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.18.10.12 30070</span><br><span class="line"></span><br><span class="line">Trying 192.18.10.12...</span><br><span class="line">telnet: connect to address 192.18.10.12: Connection refused</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;root&#x2F;nexus&#x2F;sonatype-nexus&#x2F;values.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216194304572.png" alt="image-20191216194304572"></p>
<p>可以看到8080并不是nexus的真正端口，而真正的端口是</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216194403061.png" alt="image-20191216194403061"></p>
<p>所以又要修改service文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc nexus-sonatype-nexus</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216194516370.png" alt="image-20191216194516370"></p>
<p>再访问即可进入</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191216194625975.png" alt="image-20191216194625975"></p>
<p>用户名是admin，密码是admin123</p>
<p>完美结束！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/helm3%E5%AE%89%E8%A3%85sonarqube/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/helm3%E5%AE%89%E8%A3%85sonarqube/" class="post-title-link" itemprop="url">helm3安装sonarqube</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:18:40" itemprop="dateCreated datePublished" datetime="2021-03-25T11:18:40+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、总览"><a href="#1、总览" class="headerlink" title="1、总览"></a>1、总览</h2><p>SonarQube平台由4个组件组成：<br><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/architecture-scanning.png" alt="SonarQube平台。"></p>
<ol>
<li>一台SonarQube Server启动3个主要过程：<ul>
<li>Web服务器，供开发人员，管理人员浏览高质量的快照并配置SonarQube实例</li>
<li>基于Elasticsearch的Search Server从UI进行后退搜索</li>
<li>Compute Engine服务器，负责处理代码分析报告并将其保存在SonarQube数据库中</li>
</ul>
</li>
<li>一个SonarQube数据库要存储：<ul>
<li>SonarQube实例的配置（安全性，插件设置等）</li>
<li>项目，视图等的质量快照。</li>
</ul>
</li>
<li>服务器上安装了多个SonarQube插件，可能包括语言，SCM，集成，身份验证和管理插件</li>
<li>在构建/持续集成服务器上运行一个或多个SonarScanner，以分析项目</li>
</ol>
<h2 id="2、架构"><a href="#2、架构" class="headerlink" title="2、架构"></a>2、架构</h2><p>以下架构显示了SonarQube如何与其他ALM工具集成以及使用SonarQube的各种组件的位置。<br><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/architecture-integrate.png" alt="SonarQube集成。"></p>
<ol>
<li>开发人员在其IDE中进行编码，并使用<a target="_blank" rel="noopener" href="https://sonarlint.org/">SonarLint</a>运行本地分析。</li>
<li>开发人员将他们的代码放入他们最喜欢的SCM中：git，SVN，TFVC等。</li>
<li>Continuous Integration Server会触发自动生成，并执行运行SonarQube分析所需的SonarScanner。</li>
<li>分析报告将发送到SonarQube服务器进行处理。</li>
<li>SonarQube Server处理分析报告结果并将其存储在SonarQube数据库中，并在UI中显示结果。</li>
<li>开发人员通过SonarQube UI审查，评论，挑战他们的问题，以管理和减少技术债务。</li>
<li>经理从分析中接收报告。Ops使用API自动执行配置并从SonarQube提取数据。运维人员使用JMX监视SonarQube Server。</li>
</ol>
<h2 id="3、关于服务器"><a href="#3、关于服务器" class="headerlink" title="3、关于服务器"></a>3、关于服务器</h2><ul>
<li>SonarQube平台不能具有多个SonarQube服务器（尽管该服务器可以<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/setup/install-cluster/">作为集群</a>安装）和一个SonarQube数据库。</li>
<li>为了获得最佳性能，应将每个组件（服务器，数据库，扫描仪）安装在单独的计算机上，并且服务器计算机应专用。</li>
<li>SonarScanners通过添加机器进行扩展。</li>
<li>所有机器必须时间同步。</li>
<li>SonarQube服务器和SonarQube数据库必须位于同一网络中</li>
<li>SonarScanners不需要与SonarQube Server位于同一网络上。</li>
<li>有<strong>没有沟通</strong>之间<strong>SonarScanners</strong>和<strong>SonarQube数据库</strong>。</li>
</ul>
<h2 id="4、安装"><a href="#4、安装" class="headerlink" title="4、安装"></a>4、安装</h2><p>前提环境需要k8s集群和helm</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226223315113.png" alt="image-20191226223315113"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm pull stable&#x2F;sonarqube</span><br><span class="line">tar xvf sonarqube-3.2.7.tgz</span><br><span class="line">vim sonarqube&#x2F;values.yaml</span><br></pre></td></tr></table></figure>
<p>设置用户和密码</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226223702365.png" alt="image-20191226223702365"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm install sonarqube .&#x2F;sonarqube</span><br><span class="line"></span><br><span class="line">#报错原因是我的集群是1.16版本了</span><br><span class="line">Error: unable to build kubernetes objects from release manifest: unable to recognize &quot;&quot;: no matches for kind &quot;Deployment&quot; in version &quot;extensions&#x2F;v1beta1&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; sonarqube | grep deployment</span><br><span class="line"></span><br><span class="line">grep -irl &quot;extensions&#x2F;v1beta1&quot; sonarqube | grep deploy | xargs sed -i &#39;s#extensions&#x2F;v1beta1#apps&#x2F;v1#g&#39;</span><br></pre></td></tr></table></figure>
<p>再次执行安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm install sonarqube .&#x2F;sonarqube</span><br><span class="line"></span><br><span class="line">Error: unable to build kubernetes objects from release manifest: error validating &quot;&quot;: error validating data: ValidationError(Deployment.spec): missing required field &quot;selector&quot; in io.k8s.api.apps.v1.DeploymentSpec</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -irl &quot;apps&#x2F;v1&quot; sonarqube | grep deployment</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226224502628.png" alt="image-20191226224502628"></p>
<p>依次修改以上文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sonarqube&#x2F;templates&#x2F;deployment.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226224706142.png" alt="image-20191226224706142"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sonarqube&#x2F;charts&#x2F;postgresql&#x2F;templates&#x2F;deployment.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226224831497.png" alt="image-20191226224831497"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sonarqube&#x2F;charts&#x2F;mysql&#x2F;templates&#x2F;deployment.yaml</span><br></pre></td></tr></table></figure>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226224933183.png" alt="image-20191226224933183"></p>
<p>再次执行安装</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226225015906.png" alt="image-20191226225015906"></p>
<p>pod需要请求pv，这里使用hostpath</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226225113200.png" alt="image-20191226225113200"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat pv&#x2F;pv1.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: sonarqube-pv1</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">  -  ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  hostPath:</span><br><span class="line">    path: &#x2F;helm&#x2F;sonarqube&#x2F;pv1</span><br></pre></td></tr></table></figure>
<p>稍等会儿就能看到pod状态</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20191226225808478.png" alt="image-20191226225808478"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/25/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2Helm3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/25/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2Helm3/" class="post-title-link" itemprop="url">安装部署Helm3</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-25 11:12:52" itemprop="dateCreated datePublished" datetime="2021-03-25T11:12:52+08:00">2021-03-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Helm/" itemprop="url" rel="index"><span itemprop="name">Helm</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1、新的功能"><a href="#1、新的功能" class="headerlink" title="1、新的功能"></a>1、新的功能</h3><p>Helm 3具有许多新功能，但其中一些功能应在此处重点介绍：</p>
<ul>
<li>版本以新格式存储</li>
<li>没有群集内（分iller）组件</li>
<li>Helm 3包括对新版Helm图表的支持（图表v2）</li>
<li>Helm 3还支持库图表-图表主要用作其他图表的资源。</li>
<li>用于在OCI注册表中存储Helm图表的实验支持（例如<a target="_blank" rel="noopener" href="https://github.com/docker/distribution">Docker Distribution</a>）可以进行测试。</li>
<li>现在在升级Kubernetes资源时将应用3向战略合并补丁。</li>
<li>现在可以根据JSON模式验证图表提供的值</li>
<li>为了使Helm更安全，可用和健壮，已进行了许多小的改进。</li>
</ul>
<h3 id="2、-Helm3-的内部实现已从-Helm2-发生了很大变化，使其与-Helm2-不兼容"><a href="#2、-Helm3-的内部实现已从-Helm2-发生了很大变化，使其与-Helm2-不兼容" class="headerlink" title="2、 Helm3 的内部实现已从 Helm2 发生了很大变化，使其与 Helm2 不兼容"></a>2、 <code>Helm3 </code>的内部实现已从 <code>Helm2 </code>发生了很大变化，使其与 <code>Helm2 </code>不兼容</h3><p><strong>该版本主要变化如下：</strong></p>
<p>1、最明显的变化是 <code>Tiller </code>的删除</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/640.webp" alt="img"></p>
<p><strong>2、</strong><code>Release</code> 不再是全局资源，而是存储在各自命名空间内</p>
<p>3、<code>Values </code>支持<code> JSON Schema</code>校验器，自动检查所有输入的变量格式</p>
<p>4、移除了用于本地临时搭建 <code>Chart Repository </code>的 <code>helm serve</code> 命令。</p>
<p>5、<code>helm install</code> 不再默认生成一个 Release 的名称，除非指定了 <code>--generate-name</code> 。</p>
<p><strong>6、</strong><code>Helm CLI </code>个别更名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm delete&#96; 更名为 &#96;helm uninstall</span><br><span class="line">helm inspect&#96; 更名为 &#96;helm show</span><br><span class="line">helm fetch&#96; 更名为 &#96;helm pull</span><br></pre></td></tr></table></figure>
<p>但以上旧的命令当前仍能使用。</p>
<h3 id="3、先决条件"><a href="#3、先决条件" class="headerlink" title="3、先决条件"></a>3、先决条件</h3><p>要成功且正确地确保使用Helm，必须满足以下先决条件。</p>
<ol>
<li>Kubernetes集群</li>
<li>确定要应用于安装的安全性配置（如果有）</li>
<li>安装和配置Helm。</li>
</ol>
<h3 id="4、安装Kubernetes或有权访问集群"><a href="#4、安装Kubernetes或有权访问集群" class="headerlink" title="4、安装Kubernetes或有权访问集群"></a>4、安装Kubernetes或有权访问集群</h3><ul>
<li>您必须安装Kubernetes。对于Helm的最新版本，我们建议使用Kubernetes的最新稳定版本，在大多数情况下，它是第二最新的次要版本。</li>
<li>您还应该具有的本地配置副本<code>kubectl</code>。</li>
</ul>
<p>注意：1.6之前的Kubernetes版本对基于角色的访问控制（RBAC）的支持有限或不支持。</p>
<h3 id="5、-从二进制版本"><a href="#5、-从二进制版本" class="headerlink" title="5、 从二进制版本"></a>5、 从二进制版本</h3><p>每一个<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">版本</a>helm提供多种操作系统的二进制版本。这些二进制版本可以手动下载和安装。</p>
<ol>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">所需版本</a></li>
<li>打开包装（<code>tar -zxvf helm-v3.0.0-linux-amd64.tgz</code>）</li>
<li><code>helm</code>在解压后的目录中找到二进制文件，然后将其移至所需的目标位置（<code>mv linux-amd64/helm /usr/local/bin/helm</code>）</li>
</ol>
<p>从那里，您应该能够运行客户端：<code>helm help</code>。</p>
<h3 id="6、从脚本"><a href="#6、从脚本" class="headerlink" title="6、从脚本"></a>6、从脚本</h3><p>Helm现在具有一个安装程序脚本，该脚本将自动获取最新版本的Helm并将<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3">其本地安装</a>。</p>
<p>您可以获取该脚本，然后在本地执行它。它有充分的文档记录，因此您可以在运行它之前通读它并了解它在做什么。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 &gt; get_helm.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod 700 get_helm.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./get_helm.sh</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/22/Redis%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="羊皮裘老头">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊皮裘老头">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 羊皮裘老头">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/22/Redis%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">Redis介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-22 15:13:32" itemprop="dateCreated datePublished" datetime="2021-03-22T15:13:32+08:00">2021-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-17 17:07:34" itemprop="dateModified" datetime="2022-04-17T17:07:34+08:00">2022-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">非关系型数据库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1、redis持久化"><a href="#1、redis持久化" class="headerlink" title="1、redis持久化"></a><strong>1、redis持久化</strong></h2><p>redis提供了两种持久化的方式，分别是RDB（Redis DataBase）和AOF（Append Only File）。</p>
<p>RDB，简而言之，就是在不同的时间点，将redis存储的数据生成快照并存储到磁盘等介质上；</p>
<p>AOF，则是换了一个角度来实现持久化，那就是将redis执行过的所有写指令记录下来，在下次redis重新启动时，只要把这些写指令从前到后再重复执行一遍，就可以实现数据恢复了。</p>
<p>其实RDB和AOF两种方式也可以同时使用，在这种情况下，如果redis重启的话，则会优先采用AOF方式来进行数据恢复，这是因为AOF方式的数据恢复完整度更高。</p>
<p>如果你没有数据持久化的需求，也完全可以关闭RDB和AOF方式，这样的话，redis将变成一个纯内存数据库，就像memcache一样。</p>
<h2 id="2、-RDB"><a href="#2、-RDB" class="headerlink" title="2、 RDB"></a><strong>2、 RDB</strong></h2><p>RDB方式，是将redis某一时刻的数据持久化到磁盘中，是一种快照式的持久化方法。</p>
<p>redis在进行数据持久化的过程中，会先将数据写入到一个临时文件中，待持久化过程都结束了，才会用这个临时文件替换上次持久化好的文件。正是这种特性，让我们可以随时来进行备份，因为快照文件总是完整可用的。</p>
<p>对于RDB方式，redis会单独创建（fork）一个子进程来进行持久化，而主进程是不会进行任何IO操作的，这样就确保了redis极高的性能。</p>
<p>如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。</p>
<p>虽然RDB有不少优点，但它的缺点也是不容忽视的。如果你对数据的完整性非常敏感，那么RDB方式就不太适合你，因为即使你每5分钟都持久化一次，当redis故障时，仍然会有近5分钟的数据丢失。所以，redis还提供了另一种持久化方式，那就是AOF。</p>
<h2 id="3、-AOF"><a href="#3、-AOF" class="headerlink" title="3、 AOF"></a><strong>3、 AOF</strong></h2><p>AOF，英文是Append Only File，即只允许追加不允许改写的文件。</p>
<p>如前面介绍的，AOF方式是将执行过的写指令记录下来，在数据恢复时按照从前到后的顺序再将指令都执行一遍，就这么简单。</p>
<p>我们通过配置redis.conf中的appendonly yes就可以打开AOF功能。如果有写操作（如SET等），redis就会被追加到AOF文件的末尾。</p>
<p>默认的AOF持久化策略是每秒钟fsync一次（fsync是指把缓存中的写指令记录到磁盘中），因为在这种情况下，redis仍然可以保持很好的处理性能，即使redis故障，也只会丢失最近1秒钟的数据。</p>
<p>如果在追加日志时，恰好遇到磁盘空间满、inode满或断电等情况导致日志写入不完整，也没有关系，redis提供了redis-check-aof工具，可以用来进行日志修复。</p>
<p>因为采用了追加方式，如果不做任何处理的话，AOF文件会变得越来越大，为此，redis提供了AOF文件重写（rewrite）机制，即当AOF文件的大小超过所设定的阈值时，redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集。举个例子或许更形象，假如我们调用了100次INCR指令，在AOF文件中就要存储100条指令，但这明显是很低效的，完全可以把这100条指令合并成一条SET指令，这就是重写机制的原理。</p>
<p>在进行AOF重写时，仍然是采用先写临时文件，全部完成后再替换的流程，所以断电、磁盘满等问题都不会影响AOF文件的可用性，这点大家可以放心。</p>
<p>AOF方式的另一个好处，我们通过一个“场景再现”来说明。某同学在操作redis时，不小心执行了FLUSHALL，导致redis内存中的数据全部被清空了，这是很悲剧的事情。不过这也不是世界末日，只要redis配置了AOF持久化方式，且AOF文件还没有被重写（rewrite），我们就可以用最快的速度暂停redis并编辑AOF文件，将最后一行的FLUSHALL命令删除，然后重启redis，就可以恢复redis的所有数据到FLUSHALL之前的状态了。是不是很神奇，这就是AOF持久化方式的好处之一。但是如果AOF文件已经被重写了，那就无法通过这种方法来恢复数据了。</p>
<p>虽然优点多多，但AOF方式也同样存在缺陷，比如在同样数据规模的情况下，AOF文件要比RDB文件的体积大。而且，AOF方式的恢复速度也要慢于RDB方式。</p>
<p>如果你直接执行BGREWRITEAOF命令，那么redis会生成一个全新的AOF文件，其中便包括了可以恢复现有数据的最少的命令集。</p>
<p>如果运气比较差，AOF文件出现了被写坏的情况，也不必过分担忧，redis并不会贸然加载这个有问题的AOF文件，而是报错退出。这时可以通过以下步骤来修复出错的文件：</p>
<p>1.备份被写坏的AOF文件<br> 2.运行redis-check-aof –fix进行修复<br> 3.用diff -u来看下两个文件的差异，确认问题点<br> 4.重启redis，加载修复后的AOF文件</p>
<h2 id="4、AOF重写"><a href="#4、AOF重写" class="headerlink" title="4、AOF重写"></a><strong>4、AOF重写</strong></h2><p>AOF重写的内部运行原理，我们有必要了解一下。</p>
<p>在重写即将开始之际，redis会创建（fork）一个“重写子进程”，这个子进程会首先读取现有的AOF文件，并将其包含的指令进行分析压缩并写入到一个临时文件中。</p>
<p>与此同时，主工作进程会将新接收到的写指令一边累积到内存缓冲区中，一边继续写入到原有的AOF文件中，这样做是保证原有的AOF文件的可用性，避免在重写过程中出现意外。</p>
<p>当“重写子进程”完成重写工作后，它会给父进程发一个信号，父进程收到信号后就会将内存中缓存的写指令追加到新AOF文件中。</p>
<p>当追加结束后，redis就会用新AOF文件来代替旧AOF文件，之后再有新的写指令，就都会追加到新的AOF文件中了。</p>
<h2 id="5、如何选择RDB和AOF"><a href="#5、如何选择RDB和AOF" class="headerlink" title="5、如何选择RDB和AOF"></a><strong>5、如何选择RDB和AOF</strong></h2><p>对于我们应该选择RDB还是AOF，官方的建议是两个同时使用。这样可以提供更可靠的持久化方案。</p>
<h2 id="6、主从模式"><a href="#6、主从模式" class="headerlink" title="6、主从模式"></a><strong>6、主从模式</strong></h2><p>主从模式的应用场景有点类似于数据库的主从集群，主从往往是为了读写分离、backup  等目的才使用的，所谓主从模式简单的说就是有多个节点，里面包含主节点和从节点，结构如下图：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/fe191ea03b8c313a4494ce5cd82f1e07.jpeg" alt="Redis中主从、哨兵、分片集群入门篇"></p>
<p>从节点在保持连接后每隔一个时间节点会主动的和主节点通信并发送同步请求，而后进行同步。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/077da3deb76b3b49498aec96e4c92bb8.jpeg" alt="Redis中主从、哨兵、分片集群入门篇"></p>
<p>其实在整个流程中，最需要主要的就是数据间的同步，主要的同步方式有两种也就是全量同步和增量同步。</p>
<p>全量同步：全量同步一般使用在从节点刚接入主节点时进行全量复制，当然你也可以根据你的需求进行主动的全量同步</p>
<p>增量同步：Redis增量复制是指从节点初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。   增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令，一般使用缓冲区、队列(先进先出)等方式辅助进行增量的同步。</p>
<h2 id="7、哨兵模式"><a href="#7、哨兵模式" class="headerlink" title="7、哨兵模式"></a><strong>7、哨兵模式</strong></h2><p>哨兵模式是为了保证redis的高可用产生的架构，简单地说就是通过构建1个或多个哨兵对节点进行监控，如果master发生故障下线之后，哨兵之间会进行投票，在2.8之后使用的是Raft算法进行master选举，关于这个算法其实这个算法也应用于zookeeper和某些网络拓扑中，简单说就是在选举的过程可通信节点达成共识后那个投票选举master，而后进行故障转移操作。</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/b006b2a827d407a68fc7b79182808d89.jpeg" alt="Redis中主从、哨兵、分片集群入门篇"></p>
<p>哨兵是作为一个进程单独运行在redis中，哨兵之间也是通过该进程进行通信的，这一点和zookeeper的原理也是类似的，假设一个6节点3个哨兵的集群的结构应该如下图：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200702100152234.png" alt="image-20200702100152234"></p>
<h2 id="8、那么哨兵是如何监控master下线的呢"><a href="#8、那么哨兵是如何监控master下线的呢" class="headerlink" title="8、那么哨兵是如何监控master下线的呢?"></a><strong>8、那么哨兵是如何监控master下线的呢?</strong></h2><p>前面也有看到哨兵之间会进行集群的检测和哨兵之间的互相监测，但是哨兵不用做什么配置，因为哨兵巧妙的利用了master的发布/订阅机制去自动发现其它也监控了统一master的sentinel节点，在监测master方面一般分为两种：</p>
<p>主观下线(Subjectively Down， 简称 SDOWN)指的是单个 Sentinel 实例对服务器做出的下线判断。</p>
<p>客观下线(Objectively Down， 简称 ODOWN)指的是多个 Sentinel 实例在对同一个服务器做出 SDOWN 判断，  并且通过命令互相交流之后， 得出的服务器下线判断。 一个 Sentinel 可以通过向另一个 Sentinel   发送命令来询问对方是否认为给定的服务器已下线。</p>
<h2 id="9、分片集群"><a href="#9、分片集群" class="headerlink" title="9、分片集群"></a><strong>9、分片集群</strong></h2><p>在上面的部分不管redis主从，还是高可用的 sentinel   哨兵模式。我们所做的这些工作只是保证了数据备份以及高可用，目前为止我们的程序一直都是向1台redis写数据，其他的redis只是备份而已。在实际使用中一般分片集群使用较多，我为什么要特意强调是分片集群呢，其实上面所说的主从和哨兵都是集群但是他们都是备份式的集群，实际数据是由一台进行控制的，所谓分片其实是将不同的数据按照一定的分布规则分布在不同的机器上</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/7c040c0e14c86d49d76b08dc101c57a2.jpeg" alt="Redis中主从、哨兵、分片集群入门篇"></p>
<p>在redis中，我们的应用在存取数据的时候需要根据一定的算法(一致性hash)进行计算和存取 ，那么在redis中如何实现数据分片的呢?   首先Redis至少存在三个数据分片，每个分片称为master，假设整个cluster有N个节点，那么每个节点都和其他N-1个节点保持连接和心跳，节点之间相互通信主要确认节点是否存活、节点的数据版本、投票选择新的master等</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/image-20200702100058383.png" alt="image-20200702100058383"></p>
<p>那么我们最终的集群结构大致如下：</p>
<p><img src="https://yangpiqiulaotou.oss-cn-hangzhou.aliyuncs.com/images/e42fe470d4bb59125b1f3fcecf65ce83.jpeg" alt="Redis中主从、哨兵、分片集群入门篇"></p>
<p>集群分片连接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/flgb/p/10810269.html">https://www.cnblogs.com/flgb/p/10810269.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">羊皮裘老头</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
